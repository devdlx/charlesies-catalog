<link rel="import" href="../../bower_components/pushstate-anchor/pushstate-anchor.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-document.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">


<dom-module id="catalog-user">
  <template>
    <firebase-auth id="firebaseLogin" user="{{_userAuth}}" status-known="{{statusKnown}}" location="https://charlesiescom.firebaseio.com" provider="{{provider}}" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler"
    on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>
    <!-- <firebase-document id="firebaseFavorites" location$="{{_favLocation(user)}}" data="{{_favs}}"></firebase-document> -->
    <firebase-document id="fbUserProfile" location$="{{_userProfileLocation(_userAuth)}}" data="{{_userProfile}}" on-firebase-value="_computeUser"></firebase-document>
    <!-- <firebase-collection id="fbCard" location$="[[_computeCardLocation(user, loggedin)]]" data="{{_card}}" on-firebase-value="_computeCard"></firebase-collection> -->
    <!-- <firebase-collection id="fbAddress" location$="[[_computeAddressLocation(user, loggedin, _user)]]" data="{{_address}}" on-firebase-value="_computeAddress"></firebase-collection> -->
  </template>
  <script>
    (function() {

      var _instances = [];
      var _card = [];

      var _add = function(type, item) {
        // console.log('_computeUser._add - ', 'type: ', type);
        // console.log('_computeUser._add - ', 'item: ', item);
        var check = _instances[0];
        var insertAt = 0;

        // for (var i = 0; i < check[type].length; i++) {
        //   // console.log(check.items[i].__firebaseKey__);
        //
        // }

        check.splice(type, insertAt, 0, item);
        // console.dir(check.card);
        console.dir(_instances);

        _instances.forEach(function(instance) {

          if (!instance[type]) {
            return;
          }

          // instance.splice(type, insertAt, 0, item);
        });
        // _updateAll();
        // return item;

      };

      var _remove = function(type, item_index) {
        var check = _instances[0];
        var removeAt = item_index;
        // for (var i = 0; i < check[type].length; i++) {
        //   if (check[type][i] === item || check[type][i].name === item.name) {
        //     removeAt = i;
        //   }
        // }

        if (removeAt >= 0) {
          _instances.forEach(function(instance) {
            instance.splice(type, removeAt, 1);
          });
        } else {
          return false;
        }

        _updateAll();
        return true;
      };

      var _updateAll = function() {
        _instances.forEach(function(instance) {
          instance.address = _instances[0].address;
        });
        _instances.forEach(function(instance) {
          instance.card = _instances[0].card;
        });
      };

      Polymer({
        is: 'catalog-user',
        properties: {
          email: {
            type: String,
            notify: true,
            value: ""
          },
          password: {
            type: String,
            notify: true,
            value: ""
          },
          _userAuth: {
            type: Object,
            notify: true,
          },
          _userProfile: {
            type: Object,
            notify: true,
          },
          user: {
            type: Object,
            notify: true,
          },
          statusKnown: {
            type: Boolean,
            notify: true,
          },
          provider: {
            type: String,
            notify: true,
            value: 'password'
          },
          loggedin: {
            type: Boolean,
            notify: true,
            value: false,
            // computed: 'computeLoginStatus(statusKnown, user)'
          },
          wait: {
            type: Boolean,
            notify: true,
            value: true
          },
          _favs: {
            type: Array,
            notify: true
          },

          // _card: {
          //   type: Array,
          //   notify: true,
          // },
          _card: {
            type: Object,
            notify: true,
          },

          Card: {
            type: Object,
            notify: true,
            value: {
              'cc_num': '5555 5555 5555 5559'
            }
          },

          // _address: {
          //   type: Array,
          //   notify: true,
          // },
          _address: {
            type: Object,
            notify: true,
          },

          Address: {
            type: Object,
            notify: true,
          },

        },
        observers: [
          // '_computeUser(_user)',
          'checkstatus(statusKnown, _userAuth)',
          // 'check(user)',
        ],

        created: function() {
          _instances.push(this);
        },

        check: function(user) {
          console.log(user);
        },
        // Favorites

        _favLocation: function(user) {
          // console.log(user.uid);
          return 'https://charlesiescom.firebaseio.com/users/' + user.uid + '/favorites';
        },
        _userProfileLocation: function(user) {
          // console.log(user.uid);
          if (!user) {
            this.set('user', {});
            return;
          }
          return 'https://charlesiescom.firebaseio.com/users/' + user.uid;
        },

        addFav: function(product) {
          // console.log(product.__firebaseKey__);
          if (!product) return;
          var ref = new Firebase('https://charlesiescom.firebaseio.com/users/' + this.user.uid + '/favorites/' + product.__firebaseKey__);
          ref.once("value", function(snapshot) {
            // console.log(snapshot.val());
            if (snapshot.val()) {
              ref.set(false);
            } else {
              ref.set(true);
            }
          });

        },

        // User

        _computeUser: function(_, ref) {
          // console.log(ref);
          if (!ref) return;
          var userDetails = ref.val() || {};
          var user = this._user || {};
          // user = this._userAuth[this._userAuth.provider];
          user.accessToken = this._userAuth[this._userAuth.provider].accessToken;
          user.cachedUserProfile = this._userAuth[this._userAuth.provider].cachedUserProfile;
          user.displayName = this._userAuth[this._userAuth.provider].displayName;
          user.id = this._userAuth[this._userAuth.provider].id;
          user.profileImageURL = this._userAuth[this._userAuth.provider].profileImageURL;
          // user.token = this._userAuth[this._userAuth.provider].token;
          user.provider = this._userAuth.provider;
          // console.log(userDetails);
          user.isAdmin = userDetails.isAdmin || false;
          user.instagram = userDetails.instagram || false;
          this.set('_userProfile', user);

          // local use properties
          user.uid = this._userAuth.auth.uid;
          user.token = this._userAuth.token;
          // send it up
          this.set('user', user);
        },

        login: function(provider, email, password) {
          // console.log(provider, email, password);
          // this.wait = true;
          var params = {}; // = {email: email, password: password};
          // try {
          //   params = JSON.parse(this.params);
          // } catch (e) {
          //   params = null;
          // }
          if (provider === 'password') {
            // params = params || {};
            params.email = email;
            params.password = password;
          }
          // if (provider == 'anonymous') {
          //   params.createdAt = Date.now();
          // }

          if (provider === 'google') {
            var scope = ['https://www.googleapis.com/auth/photos', 'https://www.googleapis.com/auth/drive', 'email', 'profile'];
            params.scope = scope;

          }
          // console.log('login: ', provider, params);
          this.$.firebaseLogin.provider = provider;
          this.$.firebaseLogin.login(params);
        },
        logout: function() {
          this.$.firebaseLogin.logout();
          // this._computeUser();
          this.set('user', {});
          this.loggedin = false;
          this.wait = false;
          // console.log('logout!');
          this.fire('toast', {
            text: "Logged out!"
          });
        },
        errorHandler: function(e) {
          this.fire('toast', {
            text: e.detail.message
          });
          console.log('error: ', e.detail.message);
        },
        userSuccessHandler: function(e) {
          this.fire('toast', {
            text: 'Xsuccess!'
          });
          console.log('success: ', this.user);
        },
        createUserHandler: function(e) {
          this.$.firebaseLogin.createUser(this.email, this.password);
          this.fire('toast', {
            text: 'Thanks for joining Charlesies.com ' + this.email
          });
        },
        changePasswordHandler: function(e) {
          this.$.firebaseLogin.changePassword(this.email, this.password, this.newPassword);
          this.fire('toast', {
            text: 'Password for account ' + this.email + ' has been changed'
          });
        },
        resetPasswordHandler: function(e) {
          this.$.firebaseLogin.sendPasswordResetEmail(this.email);
          this.fire('toast', {
            text: 'Reset password requset sent to ' + this.email
          });
        },

        checkstatus: function(statusKnown, _user) {
          // console.log(statusKnown);

          if (statusKnown && _user) {
            // console.log('statusKnown: ', _user, statusKnown);
            // console.log('logged in');
            this.loggedin = true;
            this.wait = false;
            return true;
          }
          if (statusKnown) {
            // console.log('NOT logged in');

            // login annonomusly

            // this.login('anonymous');
            this.loggedin = false;
            this.wait = false;

            if (!_user) {
              _user = {};
              _user.uid = 'guest_' + Date.now();
              _user.displayName = 'Guest';
              _user.isAdmin = false;
              this.set('user', _user);
            }
            // console.log(_user);

            return false;
          }
          // console.log('Unknown (checking status...)');
          this.loggedin = false;
          this.wait = true;
          // return 'Unknown (checking status...)';
        },

        _computeCardLocation: function(user, loggedin) {
          if (loggedin) {
            return 'https://charlesiescom.firebaseio.com/users/' + this.user.uid + '/card';
          }
          return;
        },

        _computeAddressLocation: function(user, loggedin) {
          // console.log(user.uid, loggedin);
          if (loggedin) {
            return 'https://charlesiescom.firebaseio.com/users/' + user.uid + '/address';
          }
        },

        _computeAddress: function(_, userSetting) {
          // console.log(userSetting, this.userSetting);
          // console.log(this._address.length);
          // if (this._address.length > 0) {
          //   for (var i = 0; i < this._address.length; i++) {
          //     // console.log(this._address[i].__firebaseKey__ === this.userSetting.default_address );
          //     if (this._address[i].__firebaseKey__ === this.userSetting.default_address) {
          //       // console.log(this._address[i]);
          //       this._address[i].isDefault = true;
          //     }
          //   }
          // }
          this.address = this._address;
        },

        _computeDefaultAddress: function(userSetting, address) {
          // console.log(userSetting, address);
          if (this._address.length > 0) {
            for (var i = 0; i < this._address.length; i++) {
              // console.log(this._address[i].__firebaseKey__ === this.userSetting.default_address );
              if (this._address[i].__firebaseKey__ === this.userSetting.default_address) {
                // console.log(this._address[i]);
                return this._address[i];
              }
            }
          }

        },

        // Save Address

        save_address: function(newAddress) {
          // If logged in, add to database
          if (!this.loggedin) {
            _add('address', newAddress);
            return true;
          }

          var key;
          if (!newAddress.id) {
            console.log(newAddress.id);
            // console.dir(this.$.fbAddress);
          } else {
            key = this.$.fbAddress.add(newAddress).key();
          }

          this.fire('toast', {
            text: 'New address added!'
          });
          return true;
          // console.log(this.$.fbAddress.add(this.newAddress).key());
        },

        // Save Card

        save_card: function function_name(newCard) {
          // console.log(this.loggedin);
          // If logged in, add to database
          if (!this.loggedin) {
            // If guest, add to guest card array
            _add('card', newCard);
            return true;
          }

          // console.log('loggedin, saved to db');
          var key = this.$.fbCard.add(newCard).key();

          this.fire('toast', {
            text: 'New card added!'
          });
          return true;
          // console.log(this.$.fbAddress.add(this.newAddress).key());

        },

        _computeCard: function(_, cardRef) {
          // console.log(cardRef.val());
          // console.log(this._card);
          // var card = cardRef.val();
          // if (this._card.length === 0) {
          //   this.Card = null;
          //   return;
          // }

          // console.log(this._user.default_card);

          // for (var i = 0; i < this._card.length; i++) {
          //   // console.log(this.card[i].default_card);
          //   if (this._card[i].default_card) {
          //     this._Card = this._card[i];
          //     console.log(this.Card.cc_name);
          //     return;
          //   }
          // }

          // this.card = this._card;
          this.Card = this._card;

        },




        // Instagram


        authInstagram: function(authCode) {
          console.log(authCode);

          var _instagram = {
            authCode: authCode
          };

          var urlRef = 'https://charlesiescom.firebaseio.com';
          var ref = new Firebase(urlRef);
          var updates = {};
          var uid = this.user.uid;
          updates['/users/' + uid + '/instagram/'] = _instagram;
          ref.update(updates);
          return true;
        },

      });
    })();
  </script>
</dom-module>
