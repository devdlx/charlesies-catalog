<link rel="import" href="../../bower_components/pushstate-anchor/pushstate-anchor.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-document.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">


<dom-module id="catalog-user">
  <template>
    <firebase-auth id="firebaseLogin" user="{{_userAuth}}" status-known="{{statusKnown}}" location="https://charlesiescom.firebaseio.com" provider="{{provider}}" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler"
    on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>
    <firebase-document id="fbUserProfile" location$="{{_userProfileLocation(_userAuth)}}" data="{{_userProfile}}" on-firebase-value="_computeUser"></firebase-document>
  </template>
  <script>
    (function() {

      var _instances = [];

      var _add = function(type, item) {
        // console.log('_computeUser._add - ', 'type: ', type);
        // console.log('_computeUser._add - ', 'item: ', item);
        var check = _instances[0];
        var insertAt = 0;

        // for (var i = 0; i < check[type].length; i++) {
        //   // console.log(check.items[i].__firebaseKey__);
        //
        // }

        check.splice(type, insertAt, 0, item);
        // console.dir(check.card);
        console.dir(_instances);

        _instances.forEach(function(instance) {

          if (!instance[type]) {
            return;
          }

          // instance.splice(type, insertAt, 0, item);
        });
        // _updateAll();
        // return item;

      };

      var _remove = function(type, item_index) {
        var check = _instances[0];
        var removeAt = item_index;
        // for (var i = 0; i < check[type].length; i++) {
        //   if (check[type][i] === item || check[type][i].name === item.name) {
        //     removeAt = i;
        //   }
        // }

        if (removeAt >= 0) {
          _instances.forEach(function(instance) {
            instance.splice(type, removeAt, 1);
          });
        } else {
          return false;
        }

        _updateAll();
        return true;
      };

      var _updateAll = function() {
        _instances.forEach(function(instance) {
          instance.address = _instances[0].address;
        });
        _instances.forEach(function(instance) {
          instance.card = _instances[0].card;
        });
      };

      Polymer({
        is: 'catalog-user',
        properties: {
          email: {
            type: String,
            notify: true,
            value: ""
          },
          password: {
            type: String,
            notify: true,
            value: ""
          },
          _userAuth: {
            type: Object,
            notify: true,
          },
          _userProfile: {
            type: Object,
            notify: true,
          },
          user: {
            type: Object,
            notify: true,
          },
          statusKnown: {
            type: Boolean,
            notify: true,
          },
          provider: {
            type: String,
            notify: true,
            value: 'password'
          },
          loggedin: {
            type: Boolean,
            notify: true,
            value: false,
            // computed: 'computeLoginStatus(statusKnown, user)'
          },
          wait: {
            type: Boolean,
            notify: true,
            value: true
          },
          _favs: {
            type: Array,
            notify: true
          },

        },
        observers: [
          // '_computeUser(_user)',
          'checkstatus(statusKnown, _userAuth)',
          // 'check(user)',
        ],

        created: function() {
          _instances.push(this);
        },

        check: function(user) {
          console.log(user);
        },

        _userProfileLocation: function(user) {
          // console.log(user.uid);
          if (!user) {
            this.set('user', {});
            return;
          }
          return 'https://charlesiescom.firebaseio.com/users/' + user.uid;
        },

        addFav: function(product) {
          // console.log(product.__firebaseKey__);
          if (!product) return;
          var ref = new Firebase('https://charlesiescom.firebaseio.com/users/' + this.user.uid + '/favorites/' + product.__firebaseKey__);
          ref.once("value", function(snapshot) {
            // console.log(snapshot.val());
            if (snapshot.val()) {
              ref.set(false);
            } else {
              ref.set(true);
            }
          });

        },

        // User

        _computeUser: function(_, ref) {
          // console.log(ref);
          if (!ref) return;
          var userDetails = ref.val() || {};
          var user = {};
          // user = this._userAuth[this._userAuth.provider];
          user.accessToken = this._userAuth[this._userAuth.provider].accessToken;
          user.cachedUserProfile = this._userAuth[this._userAuth.provider].cachedUserProfile;
          user.displayName = this._userAuth[this._userAuth.provider].displayName;
          user.id = this._userAuth[this._userAuth.provider].id;
          user.profileImageURL = this._userAuth[this._userAuth.provider].profileImageURL;
          // user.token = this._userAuth[this._userAuth.provider].token;
          user.provider = this._userAuth.provider;
          // console.log(userDetails);
          user.isAdmin = userDetails.isAdmin || false;
          user.loggedin = true;
          // Instagram
          user.instagram = userDetails.instagram || null;
          this.set('_userProfile', user);

          // local use properties
          user.uid = this._userAuth.auth.uid;
          user.token = this._userAuth.token;
          // compute address for gold-zip-input
          var _address = userDetails.address || {
            zipcode: ''
          };
          if (!_address.zipcode) {
            _address.zipcode = '';
          }
          user.address = _address;
          // compute card for gold-elements
          user.card = userDetails.card || {
            num: '',
            cvc: '',
            type: '',
            exp: '',
            zipcode: ''
          };
          // send it up
          this.set('user', user);
        },

        login: function(provider, email, password) {
          // console.log(provider, email, password);
          // this.wait = true;
          var params = {}; // = {email: email, password: password};
          // try {
          //   params = JSON.parse(this.params);
          // } catch (e) {
          //   params = null;
          // }
          if (provider === 'password') {
            // params = params || {};
            params.email = email;
            params.password = password;
          }
          // if (provider == 'anonymous') {
          //   params.createdAt = Date.now();
          // }

          if (provider === 'google') {
            var scope = ['https://www.googleapis.com/auth/photos', 'https://www.googleapis.com/auth/drive', 'email', 'profile'];
            params.scope = scope;
          }
          // console.log('login: ', provider, params);
          this.$.firebaseLogin.provider = provider;
          this.$.firebaseLogin.login(params);
        },
        logout: function() {
          this.$.firebaseLogin.logout();
          // this._computeUser();
          this.set('user', this._computeGuest());
          this.wait = false;
          // console.log('logout!');
          this.fire('toast', {
            text: "Logged out!"
          });
        },
        errorHandler: function(e) {
          this.fire('toast', {
            text: e.detail.message
          });
          console.log('error: ', e.detail.message);
        },
        userSuccessHandler: function(e) {
          this.fire('toast', {
            text: 'Xsuccess!'
          });
          console.log('success: ', this.user);
        },
        createUserHandler: function(e) {
          this.$.firebaseLogin.createUser(this.email, this.password);
          this.fire('toast', {
            text: 'Thanks for joining Charlesies.com ' + this.email
          });
        },
        changePasswordHandler: function(e) {
          this.$.firebaseLogin.changePassword(this.email, this.password, this.newPassword);
          this.fire('toast', {
            text: 'Password for account ' + this.email + ' has been changed'
          });
        },
        resetPasswordHandler: function(e) {
          this.$.firebaseLogin.sendPasswordResetEmail(this.email);
          this.fire('toast', {
            text: 'Reset password requset sent to ' + this.email
          });
        },

        checkstatus: function(statusKnown, _user) {

          if (statusKnown && _user) {
            // console.log('statusKnown: ', _user, statusKnown);
            // console.log('logged in');
            // console.log(_user);
            _user.loggedin = true;
            this.wait = false;
            return true;
          }
          if (statusKnown) {
            // console.log('NOT logged in');

            // login annonomusly

            // this.login('anonymous');

            if (!_user) {
              this.set('user', this._computeGuest());
              this.wait = false;
            }
            // console.log(_user);

            // return false;
          }
          // console.log('Unknown (checking status...)');
          this.wait = true;
          // return 'Unknown (checking status...)';
        },


        _computeGuest: function() {
          var _user = {};
          _user.uid = 'guest_' + Date.now();
          _user.displayName = 'Guest';
          _user.isAdmin = false;
          _user.loggedin = false;
          _user.address = {
            zipcode: ''
          };
          _user.card = {
            num: '',
            cvc: '',
            type: '',
            exp: '',
            zipcode: ''
          };
          // console.log(_user);

          return _user;
        },

        _updateAddress: function(_place) {
          var componentForm = {
            street_number: 'short_name',
            route: 'long_name',
            locality: 'long_name',
            administrative_area_level_1: 'short_name',
            country: 'long_name',
            postal_code: 'short_name'
          };
          var _out = {
            zipcode: ''
          };


          if (!_place) {
            return _out;
          }

          if (_place.geometry) {
            if (typeof _place.geometry.location.lat === 'function') {
              _place.geometry.location.lat = _place.geometry.location.lat();
            }
            if (typeof _place.geometry.location.lng === 'function') {
              _place.geometry.location.lng = _place.geometry.location.lng();
            }
          }

          for (var i = 0; i < _place.address_components.length; i++) {
            var addressType = _place.address_components[i].types[0];
            if (componentForm[addressType]) {

              var val = _place.address_components[i][componentForm[addressType]];
              // console.log(addressType, val);
              if (addressType === 'street_number') {
                // this.formatted_address_1 = val;
                _place.street = val;
              }

              if (addressType === 'route') {
                // this.formatted_address_1 += ' ' + val;
                // console.log(this.formatted_address_1);
                _place.street += ' ' + val;

              }

              if (addressType === 'locality') {
                // this.formatted_address_2 = val;
                _place.city = val;
              }

              if (addressType === 'administrative_area_level_1') {
                // this.formatted_address_2 += ', ' + val;
                _place.state = val;
              }

              if (addressType === 'postal_code') {
                // this.formatted_address_2 += ', ' + val;
                // console.log(this.formatted_address_2);
                _place.zipcode = val.toString();
              }

            }
          }

          this.set('_userProfile.address', _place);
        },

        _computeCard: function() {


        },


        // Instagram

        authInstagram: function(authCode) {
          console.log(authCode);

          var _instagram = {
            authCode: authCode
          };

          var urlRef = 'https://charlesiescom.firebaseio.com';
          var ref = FireProof(new Firebase(urlRef));
          var update = {};
          var uid = this.user.uid;
          update['/users/' + uid + '/instagram/'] = _instagram;
          ref.update(update);
          return true;
        },

      });
    })();
  </script>
</dom-module>
