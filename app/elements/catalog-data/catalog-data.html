<dom-module id="catalog-data">
  <template>
    <iron-ajax id="checkoutReq" url="http://localhost:8080/checkout" method="post" handle-as="json" on-response="_handleCheckoutPostsResponse"></iron-ajax>
  </template>
  <script>
    (function() {

      var _instances = [],
        _data = {};

      var _add = function(product) {
        var check = _instances[0];
        var insertAt = 0;

        for (var i = 0; i < check.items.length; i++) {
          // console.log(check.items[i].__firebaseKey__);
          if (check.items[i].__firebaseKey__ === product.__firebaseKey__) {
            // console.log('product match');
            check.items[i].quantity++;
            // console.log(check.items[i].quantity);
            // console.log(check);
            return;
          }
        }

        product.quantity = 1;

        _instances.forEach(function(instance) {
          instance.splice('items', insertAt, 0, product);
          instance.fire('item-added', product, {
            bubbles: false
          });
        });

        _store();

        return product;
      };

      var _remove = function(product_index) {
        var check = _instances[0];
        var removeAt = product_index;
        // for (var i = 0; i < check.items.length; i++) {
        //   if (check.items[i] === product || check.items[i].name === product.name) {
        //     removeAt = i;
        //   }
        // }

        if (removeAt >= 0) {
          _instances.forEach(function(instance) {
            instance.splice('items', removeAt, 1);
            instance.fire('item-removed', product_index, {
              bubbles: false
            });
          });
        } else {
          return false;
        }
      };


      var _updateAll = function() {
        _instances.forEach(function(instance) {
          instance.items = _instances[0].items;
        });
      };

      Polymer({
        is: 'catalog-data',
        ready: function() {

          // SC.oEmbed("http://soundcloud.com/forss/flickermood", {
          //   auto_play: true
          // }, function(oembed) {
          //   console.log("oEmbed response: ", oembed);
          // });
        },
        attached: function() {
          if (_instances.length === 0 && !_data.packages) {
            //this.$.req.generateRequest();
          }
          _instances.push(this);
        },
        detached: function() {
          _els.splice(_els.indexOf(this), 1);
        },
        properties: {

        },

        observers: [

        ],

        created: function() {
          _instances.push(this);
        },

        checkout: function(order) {
          this.$.checkoutReq.body = order;
          this.$.checkoutReq.method = 'POST';
          this.$.checkoutReq.generateRequest();
        },

        _handleCheckoutPostsResponse: function(_, req) {
          console.log('_handleCheckoutPostsResponse: ', req.response);
        },


      });
    })();
  </script>

</dom-module>
