<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-document.html">
<dom-module id="catalog-data">
  <template>
    <!-- <iron-ajax id="req" url="/catalog.json" method="get" handle-as="json" on-response="_handleResponse"></iron-ajax> -->
    <firebase-document location="https://charlesiesbeta.firebaseio.com" data="{{_app}}"></firebase-document>
  </template>
</dom-module>

<script>
  (function() {
    var _data = {};
    var _els = [];

    var _generateMap = function(list) {
      var out = {};
      for (var i = 0; i < list.length; i++) {
        out[list[i].name] = list[i];
      }
      return out;
    };

    var _generateArray = function(myObj) {
      var arr = [];
      for (var i in myObj) {
        if (myObj.hasOwnProperty(i)) {
          arr.push(myObj[i]);
        }
      }
      //console.log(arr.length);
      return arr;

    };

    var _setPackageData = function(data) {

      _data = data || {};
      if (data) {

        _data.packageMap = data.packages; // _generateMap(data.packages);
        _data.elementMap = data.elements; //_generateMap(data.elements);
        _data.guideMap = data.guides; //_generateMap(data.guides);
        _data.behaviorMap = {};
        // _data.elements.forEach(function(el) {
        //   el.behaviors.forEach(function(be) {
        //     _data.behaviorMap[be] = el.name;
        //   });
        // });

        _data.packages = _generateArray(data.packages);

        _data.packages.push({
          "color": "#E82C0C",
          "description": "DLX Elements are used at dlxstudios",
          "elements": ["dlx-data"],
          "name": "dlx-elements",
          "symbol": "Dlx",
          "tagline": "dlxstudios elements",
          "title": "DLX Elements",
          "version": "0.2.3823"
        });

        _data.elements = _generateArray(data.elements);
        _data.guides = _generateArray(data.guides);
      }
      _els.forEach(function(el) {
        el.load(_data);
      });
    };

    Polymer({
      is: 'catalog-data',
      ready: function() {
        this.load(_data);
      },
      attached: function() {
        //console.log(this);
        if (_els.length === 0 && !_data.packages) {
          //this.$.req.generateRequest();
        }
        _els.push(this);
      },
      detached: function() {
        _els.splice(_els.indexOf(this), 1);
      },
      properties: {
        _app: {
          type: Object,
          notify: true
        },
        packages: {
          type: Array,
          readOnly: true,
          notify: true
        },
        packageMap: {
          type: Object,
          readOnly: true,
          notify: true
        },
        elements: {
          type: Array,
          readOnly: true,
          notify: true
        },
        elementMap: {
          type: Object,
          readOnly: true,
          notify: true
        },
        guides: {
          type: Array,
          readOnly: true,
          notify: true
        },
        guideMap: {
          type: Object,
          readOnly: true,
          notify: true
        },
        tags: {
          type: Object,
          readOnly: true,
          notify: true
        },
        behaviorMap: {
          type: Object,
          readOnly: true,
          notify: true
        }
      },
      observers: [
        '_getData(_app)',
      ],

      load: function(data) {
        //console.log('load', data.packageMap);
        if (data.packages) {
          this._setPackages(data.packages);
          this._setPackageMap(data.packageMap);
          this._setElements(data.elements);
          this._setElementMap(data.elementMap);
          this._setGuides(data.guides);
          this._setGuideMap(data.guideMap);
          this._setBehaviorMap(data.behaviorMap);
          this._setTags(data.tags);
        }
      },
      _getData: function(data) {

        _setPackageData(data);
      }
    });
  })();
</script>
