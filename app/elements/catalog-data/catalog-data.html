<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-document.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="../../bower_components/google-apis/google-client-loader.html">


<dom-module id="catalog-data">
  <template>
    <!-- <iron-ajax id="req" url="https://charlesiesbeta.firebaseio.com/.json" method="get" handle-as="json" on-response="_handleResponse"></iron-ajax> -->
    <firebase-document location="https://charlesiesbeta.firebaseio.com/packages" data={{packages}}></firebase-document>
    <firebase-document location="https://charlesiesbeta.firebaseio.com/elements" data={{elements}}></firebase-document>
    <firebase-document location="https://charlesiesbeta.firebaseio.com/settings" data={{settings}}></firebase-document>

    <firebase-document location="{{_locFBD}}" data="{{_item}}"></firebase-document>

    <google-client-loader id="gcl" name="blogger" version="v3"></google-client-loader>
    <iron-ajax id="req" url="/blogger.json" method="get" handle-as="json" on-response="_handlePostsResponse"></iron-ajax>

  </template>
</dom-module>

<script>
  (function() {
    var _data = {};
    var _els = [];

    _genLoc = function(app, ext) {
      // console.log('_genLoc', app, ext);
      return 'https://' + app + '.firebaseio.com/' + ext;
    }

    var _generateMap = function(list) {

      var out = {};
      for (var i = 0; i < list.length; i++) {
        out[list[i].name] = list[i];
      }
      return out;
    };

    var _generatePostsMap = function(list) {

      var out = {};
      for (var i = 0; i < list.length; i++) {
        out[list[i].id] = list[i];
      }
      return out;
    };

    var _setPackageData = function(data) {
      console.log('_setPackageData');

      _data = data || {};
      if (data) {
        //this.packages = data.packages;

        // _data.packages = data.packages;
        _data.packageMap = _generateMap(data.packages);
        _data.elementMap = _generateMap(data.elements);
        // _data.guideMap = _generateMap(data.guides);
        // _data.behaviorMap = {};
        // _data.elements.forEach(function(el) {
        //   el.behaviors.forEach(function(be) {
        //     _data.behaviorMap[be] = el.name;
        //   });
        // });
      }
      _els.forEach(function(el) {
        el.load(_data);
      });
    };

    Polymer({
      is: 'catalog-data',
      ready: function() {
        this.load(_data);
      },
      attached: function() {
        if (_els.length === 0 && !_data.packages) {
          //this.$.req.generateRequest();
        }
        _els.push(this);
      },
      detached: function() {
        _els.splice(_els.indexOf(this), 1);
      },
      properties: {

        /* FBDocument */
        app: {
          type: String,
        },
        _locFBD: {
          type: String,
          computed: '_locfbd(app, itembyid)'
        },
        item: {
          type: Object,
          notify: true
        },
        itembyid: String,

        packages: {
          type: Array,
          // readOnly: true,
          notify: true,

        },
        packageMap: {
          type: Object,
          readOnly: true,
          notify: true
        },
        elements: {
          type: Array,
          // readOnly: true,
          notify: true
        },
        elementMap: {
          type: Object,
          readOnly: true,
          notify: true
        },

        tags: {
          type: Object,
          readOnly: true,
          notify: true
        },
        behaviorMap: {
          type: Object,
          readOnly: true,
          notify: true
        },

        /* Blogger */
        blogid: {
          type: String,
          notify: true
        },
        postid: {
          type: String,
          notify: true
        },
        posts: {
          type: Array,
          // readOnly: true,
          notify: true
        },
        postsMap: {
          type: Object,
          readOnly: true,
          notify: true
        }


      },

      observers: [
        /* Blogger */
        '_getPostList(blogid)',
        '_getPostSingle(posts, postid)',

        'checkdata(elements, packages)'
      ],


      load: function(data) {
        // console.log(data.posts);
        if (data.packages) {
          // this._setPackages(data.packages);
          this._setPackageMap(data.packageMap);
          //this._setElements(data.elements);
          this._setElementMap(data.elementMap);
          this.posts = data.posts;
          this._setPostsMap(data.postsMap);
          //this._setBehaviorMap(data.behaviorMap);
          //this._setTags(data.tags);
        }
      },
      _handlePostsResponse: function(_, req) {
        // console.log(req.response);
        // console.log(_generatePostsMap(req.response.items));
        _data.posts = req.response.items;
        _data.postsMap = _generatePostsMap(req.response.items);
        _els.forEach(function(el) {
          el.load(_data);
        });

      },
      _locfbd: function(app, itembyid) {

        if (!itembyid.length) {
          return
        }
        // console.log('_locfbd', app, itembyid);
        console.log('_locfbd', _genLoc(app, itembyid));
        return _genLoc(app, itembyid);
      },
      checkdata: function(elements, packages) {
        // console.log('checkdata', elements, packages);
        _data.packages = packages;
        _data.elements = elements;
        _data.packageMap = _generateMap(packages);
        _data.elementMap = _generateMap(elements);

        _els.forEach(function(el) {
          el.load(_data);
        });
      },
      /*  Blogger  */
      _getPostList: function(blogid) {
        //console.log('_getPostList', blogid);
        if (blogid) {
          this.$.req.generateRequest();
          // var blogger = this.$.gcl;
          // blogger.addEventListener('google-api-load', function(event) {
          //   var request = blogger.api.post.list({
          //     blogId: this.blogid,
          //     key: 'AIzaSyAzyqzqu1sURmPH3VPzkOc9ywT7lCPPPF4'
          //   });
          //   request.execute(function(resp) {
          //     console.log(resp);
          //   });
          // });

        }
      },
      _getPostSingle: function(posts, postid) {
        // console.log('_getPostSingle', posts, postid);
        if (postid && this.posts) {
          for (var i = 0; i < posts.items.length; i++) {
            if (posts.items[i].id == postid) {
              // console.log(this.posts.items[i].id);
              // return posts.items[i];
              // console.log(this.posts.items[i]);
              // this.data = this.posts.items[i];
            }
          }

          //this.$.req.generateRequest();
          // var blogger = this.$.gcl;
          // blogger.addEventListener('google-api-load', function(event) {
          //   var request = blogger.api.posts.list({
          //     blogId: this.blogid,
          //     postId: this.postid,
          //     key: 'AIzaSyAzyqzqu1sURmPH3VPzkOc9ywT7lCPPPF4'
          //   });
          //   request.execute(function(resp) {
          //     console.log(resp);
          //   });
          // });

        }
      }
    });
  })();
</script>
