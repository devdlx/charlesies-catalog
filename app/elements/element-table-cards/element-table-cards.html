<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">


<link rel="import" href="../element-card/element-card.html">
<link rel="import" href="../catalog-data/catalog-data.html">
<link rel="import" href="../catalog-user/catalog-user.html">

<dom-module id="element-table-cards">
  <style>
    :host {
      display: block;
      /*max-width: 920px;*/
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      @apply(--layout-vertical);
      @apply(--layout-center);
    }

    #cards {
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
      margin-right: -8px;
    }

    .grid-container {
      @apply(--layout-vertical);
      @apply(--layout-center);
    }

    .grid-layout {
      padding: 16px 0;
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
      width: 266px;
    }

    .grid-cell {
      margin: 0 0 16px 0;
    }

    @media all and (min-width: 481px) {
      .grid-container {
        @apply(--layout-vertical);
        @apply(--layout-center);
      }
      .grid-layout {
        width: 460px;
      }
      .grid-cell {
        margin-right: 8px;
      }
    }

    @media all and (min-width: 961px) and (orientation: landscape) {
      .grid-container {
        padding-left: 0;
        padding-right: 0;
      }
      .grid-layout {
        width: 690px;
      }
    }

    @media all and (min-width: 1281px) and (max-width: 1600px) {
      .grid-cell {
        width: 302px;
      }
      .grid-layout {
        width: 920px;
      }
    }

    .grid-layout paper-button {
      margin: 0 4px;
      width: 125px;
    }

    #new-button-catgeory {
      background-color: white;
    }

    #new-button-catgeory .placeholderBg {
      color: var(--paper-green-500);
    }

    #new-button {
      background-color: white;
    }

    #new-button .placeholderBg {
      color: var(--paper-grey-800);
    }

    .imagePlaceholder {
      position: relative;
      /*height: 100%;*/
      width: 205px;
      height: 100%;
    }

    .imagePlaceholder .placeholderBg {
      /*color: rgba(0, 0, 0, 0.05);*/
      /*width: 205px;
      height: 100%;*/
    }
  </style>
  <template>
    <!-- <catalog-data package-map="{{packages}}"></catalog-data> -->
    <!-- <firebase-collection id="items" location="https://charlesiescom.firebaseio.com/items" data="{{items}}" order-by-child="category/newone" equal-to=""></firebase-collection> -->
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>
    <div id="grid" class="grid-container">

      <template is="dom-if" if="[[edit]]">
        <div class="grid-layout">

          <paper-button id="new-button-catgeory" class="" raised on-tap="_tapNewCollectionItem">

            <div class="imagePlaceholder fullwidth layout horizontal center-center">
              <span>New in {{byshort}}</span>
              <iron-icon class="placeholderBg" icon="note-add"></iron-icon>
            </div>
          </paper-button>

          <paper-button id="new-button" class="" raised on-tap="_tapNewCollectionItem" hidden$="[[!byshort]]">
            <div class="imagePlaceholder fullwidth layout horizontal center-center">
              <span>New</span>
              <iron-icon class="placeholderBg" icon="note-add"></iron-icon>
            </div>
          </paper-button>
        </div>
      </template>

      <!-- <div class="grid-layout">
        <template name="element-cards-repeat" is="dom-repeat" items="{{items}}" initial-count="2" chunk-count="2">
          <element-card item="{{item}}" label-path="[[labelPath]]" viewFFFF="{{item.view}}" view="[[view]]" item-key="[[item.key]]" color="[[_getColor(item)]]" package-symbol="[[_getCategorySymbol(item)]]" on-tap="_tapCard" adminFFFF="[[user.isAdmin]]"></element-card>
        </template>
      </div> -->

      <iron-selector multi$="[[multi]]" selected="{{selected}}" selected-items="{{selectedItems}}" class="grid-layout" id="grid">
        <template name="element-cards-repeat" is="dom-repeat" items="{{items}}" initial-count="2" chunk-count="2">
          <element-card select$="[[multi]]" label-path="[[labelPath]]" media-path="[[mediaPath]]" view="[[view]]" item-key="[[item.key]]" on-tap="_tapCard" adminFFFF$="[[user.isAdmin]]">
          </element-card>
        </template>
      </iron-selector>

    </div>
    <!-- <div id="cards" on-tap="_tap">
      <template name="element-cards-repeat" is="dom-repeat" items="[[items]]" initial-count="10" chunk-count="10">
        <element-card item="[[item]]" color="[[_getColor(item)]]" package-symbol="[[_getCategorySymbol(item)]]"></element-card>
      </template>
    </div> -->
  </template>
</dom-module>
<script>
  Polymer({
    is: 'element-table-cards',

    properties: {
      items: {
        type: Array,
        notify: true,
        value: function() {
          return [];
        }
      },

      selected: {
        type: Object,
        notify: true
      },

      selectedItems: {
        type: Array,
        notify: true
      },

      collection: {
        type: String,
      },
      newColelctionItem: Object,


      byshort: {
        type: String,
        value: ''
      },

      bytag: {
        type: String,
        value: ''
      },

    },

    observers: [
      // '_render(elements, packages, isAttached)'
      // '_render(byshort, isAttached)',
      // 'check(selectedItems)',
      '_computeBy(byshort, bytag, collection)',
      // '_computeByArray(items)'
    ],
    check: function(arg) {
      console.log('check: ', arg);
      for (var i = 0; i < arg.length; i++) {
        console.log(arg[i].item);
      }
    },

    _computeBy: function(byshort, bytag, collection) {
      // console.log('_compute:', arguments);
      // if (this.items.length) {
      //   this.splice('items', 0, this.items.length);
      // }

      var _collection = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/' + collection));
      if (byshort.length) {
        _collection.orderByChild('byshort/' + byshort).equalTo(true).on('child_added', function(snap) {
          // console.log(snap.val(), 'byshort');
          var _obj = snap.val();
          _obj.key = snap.key();
          this.push('items', _obj);
        }.bind(this));
      } else if (bytag.length) {
        _collection.orderByChild('bytag/' + bytag).equalTo(true).on('child_added', function(snap) {
          // console.log(snap.val(), 'bytag');
          var _obj = snap.val();
          _obj.key = snap.key();
          this.push('items', _obj);
        }.bind(this));

      } else {
        // console.log('no byShort, no tag');
        _collection.orderByPriority().on('child_added', function(snap) {
          // console.log(snap.val());
          var _obj = snap.val();
          _obj.key = snap.key();

          this.push('items', _obj);
        }.bind(this));

      }



      _collection.on('child_removed', function(snap) {
        // console.log(snap.val());
        for (var index = 0; index < this.items.length; index++) {
          // console.log('looking', this.categories[index]);
          if (snap.key() === this.items[index].key) {
            // console.log('match');
            this.splice('items', index, 1);
            return;
          }
        }
      }.bind(this));

    },

    //#byArray

    _computeByArray: function(arr) {
      // console.dir('_computeByArray: ', arr);
    },

    _tapNewCollectionItem: function() {
      // this.fire('new-item');
      var _newCollectionItem = this.newCollectionItem || {};
      var _collection = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/' + this.collection));
      _collection.push(_newCollectionItem).then(function(snap) {
        // console.log(snap);
      }.bind(this));
    },

    _findAncestor: function(node, fn) {
      while (node && fn.call(this, node)) {
        node = node.parentNode;
      }
      return node;
    },

    _tapCard: function(e) {
      var sourceEvent = e.detail.sourceEvent;
      var A = this._findAncestor(e.target, function(node) {
        return node != this && node.tagName !== 'A';
      });

      if (A && A.tagName === 'A' && A.href.indexOf(location.host) > 0) {
        if (sourceEvent.ctrlKey || sourceEvent.metaKey) {
          window.open(A.href);
        } else {
          this.fire('nav', {
            url: A.href
          });
        }
        e.preventDefault();
      }
    },

    _getColor: function(item) {
      // return this.collection[item.package].color;
    },

    _getCategorySymbol: function(item) {
      // return this.items[item.package].symbol;
    },

    _render: function(byshort) {
      if (byshort) {
        this.$.cards.innerHTML = '';

        var head = 0;
        var batchSize = 3;
        var flush = function() {
          if (head + batchSize >= elements.length) {
            batchSize = elements.length - head;
          }

          if (batchSize <= 0) {
            return false;
          }
          var el;
          var firstHead = head;
          var lastHead = firstHead + batchSize;

          for (; head < lastHead; head++) {
            el = document.createElement('element-card');
            el.item = elements[head];
            el.color = packages[el.item.package].color;
            el.packageSymbol = packages[el.item.package].symbol;
            Polymer.dom(this.$.cards).appendChild(el);
          }
          return true;
        };
        var batch = function() {
          if (flush.call(this)) {
            batchSize = 10;
            requestAnimationFrame(batch.bind(this));
          }
        };

        batch.call(this);
      }
    }
  });
</script>
