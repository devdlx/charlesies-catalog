<dom-module id="product-card">

  <style media="screen">
    :host {
      transition: box-shadow 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      transition-delay: 0.2s;
    }

    :host:hover {
      box-shadow: 2px 8px 17px 0 rgba(0, 0, 0, 0.2);
      transition-delay: 0s;
    }

    paper-card {
      width: 100%;
    }

    .productTitle{
      height: 26px;
    }

    .card-actions .itemPrice {
      line-height: 40px;
      margin: 0;
    }

    .card-actions {
      border: none;
    }

    .card-content {
    }

    .productDescription {
      height: 2.3em;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .image {
      width: 100%;
      height: 214px;
    }

    [tall] .image {
      width: 100%;
      height: 264px;
    }

    [in-fav] {
      color: #f44336;
    }

    [in-cart] {
      color: #f44336;
    }

    .inCart,
    .inFav {
      transition: color 0.2s cubic-bezier(.02, .82, 1, .33);
    }
  </style>

  <template>
    <catalog-product id="catalogProducts" by-id="{{byId}}" data="{{product}}"></catalog-product>

    <!-- <firebase-document id="fbfav" location$="[[_favLocation(user, product)]]" data="{{_fav}}" on-firebase-value="_updateFavIcon"></firebase-document> -->
    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{user}}"></catalog-user>
    <catalog-cart id="catalogCart" items="{{cart}}"></catalog-cart>

    <paper-card animated-shadow="true" elevation="0">

      <a href$="{{_computeLink(product)}}" is="pushstate-anchor">
        <!-- <img class="image" src="[[firstImageURL]]"> -->
        <iron-image fade class="image" src="{{_computeProductImage(product)}}" sizing="cover" preload placeholder="data:image/gif;base64,R0lGODdhyADIAOMAAO7u/5aWlqGho9jY5OPj8cLCyqyssLe3vc3N1wAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAyADIAAAE/hDISau9OOvNu/9gKI5kaZ5oqq5s675wLM90bd94ru987//AoHBILBqPyKRyyWw6n9CodEqtWq/YrHbL7Xq/4LB4TC6bz+i0es1uu9/wuHxOr9vv+Lx+z+/7/4CBgoOEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS06kB1tYqA9cUBQEFrgLWAgIqBOEBFNuu1gMs2ugT3d/rAe0r77bsFwMGAQLzEggc8AcQAIJwA+EBuKbQmgF+3iocDHBAXiZ9Fd6dAxhuo4R3/gwnGDgnkqE1BBM0XrN3CSOFgQYM+ouHEsFMAP1i2lQIAN8EhwS6kZPQ74BMnpZcTgiHkoA1AhKxAWDaU+pHqwvrVVVI1ScmpRIwYjxwTqo+r1vTafV6FmtSrRXEak0ooB+8tjzR4v251m0llwSgUnUaAOrJtFMDoESrty9XxYi/wk0sMEBMoRKo7iRK8SiFxu285vQMoIDR0qdNN+rmbxxJlRFLi7u22OG1mDjP4bYb2uFVf+r0CZ+cyOS1oRD/cUM4cN5EA3bDhszqWOHEhBLIZh+qHdnmaFABwIwm9BxLZxAtn6fGvr379/Djy59Pv779+/jz69/Pv7///wAGQyjggAQWaOCBCCao4IIMNujggxBGKOGEFFZo4YUYZqjhhhx26OGHIIYo4ogklmjiiSimqOKKLLbo4oswxijjjDRKEQEAOw=="></iron-image>
      </a>

      <div class="card-content">
        <div class="productTitle paper-font-title">
          <span>[[product.title]]</span>
        </div>

        <!-- <template is="dom-if" if="[[product.description]]" restamp="true">
          <div class="productDescription">
            <span>[[product.description]]</span>
          </div>
        </template> -->
      </div>

      <div class="card-actions layout horizontal">

        <!-- <paper-icon-button class="inFav" icon="favorite" on-tap="_favTap" in-fav$="[[inFav]]" disabled$="[[!loggedin]]"></paper-icon-button> -->
        <paper-icon-button class="inCart" icon="shopping-cart" on-tap="_cartTap" in-cart$="[[inCart]]"></paper-icon-button>
        <span class="flex"></span>

        <h4 class="itemPrice">
          <span>[[_computeProductPriceText(product)]]</span>
        </h4>

      </div>

    </paper-card>

  </template>
  <script>
    Number.prototype.formatMoney = function(c, d, t) {
      var n = this,
        c = isNaN(c = Math.abs(c)) ? 2 : c,
        d = d == undefined ? "." : d,
        t = t == undefined ? "," : t,
        s = n < 0 ? "-" : "",
        i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "",
        j = (j = i.length) > 3 ? j % 3 : 0;
      return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
    };

    Polymer({
      is: 'product-card',
      enableCustomStyleProperties: true,
      properties: {
        byId: {
          type: String,
          notify: true
        },
        product: {
          type: Object,
          notify: true
        },
        // images: Object,
        user: {
          type: Object,
          notify: true
        },
        loggedin: {
          type: Boolean,
          notify: true,
        },
        cart: Array,
        inCart: {
          type: Boolean,
          value: false,
          notify: true,
        },
        inFav: {
          type: Boolean,
          value: false,
          notify: true,
        },
        _fav: {
          type: Object,
          notify: true
        }

      },
      observers: [
        '_updateCartIcon(cart, product)'
      ],


      _computeProductImage: function(product) {
        // console.log(product.images[0]);
        if (product.images) {
          return product.images[0].src || '';
        }

      },

      // Product

      _computeProductPriceText: function(product) {
        // console.log(product.price);
        if (!product.price) {
          return "$0.00";
        }
        var priceText = Number(product.price).formatMoney(2);
        // console.log('$' + priceText);
        return '$' + priceText;
      },

      _computeLink: function(item) {
        // return '/products/' + item.name.split(' ').join('_');
        return '#/products/' + this.byId;

        // this.fire('nav', {
        //   path: '/product/' + this.byId
        // });

      },
      _computeFirstImage: function(images) {
        console.log('_computeFirstImage: ', images);
      },
      _computeImages: function(e, ref) {
        // console.log('_computeImages: ', ref.val());
        var key = Object.keys(ref.val())[0];
        this.images = ref.val()[key].images;
        this.firstImageURL = this.images[0];
        // this.firstImageURL = "http://lorempixel.com/400/400/fashion/";
        // console.log(this.images[0]);
      },

      // Cart

      _cartTap: function(e) {
        e.stopPropagation();
        // console.log('fire: add-to-cart');
        this.fire('add-to-cart', {
          product: this.product
        });
        // this.$.catalogCart.addCart(this.product);
        this.inCart = true;
      },

      _updateCartIcon: function(cart, product) {
        // console.log(product);
        for (var i = 0; i < cart.length; i++) {
          // console.log(cart[i].__firebaseKey__ === product.__firebaseKey__);
          if (cart[i].__firebaseKey__ === product.__firebaseKey__) {
            this.inCart = true;
            // return true;
          }
        }
      },

      // Favorites

      _favTap: function(e) {
        e.stopPropagation();
        // console.log('add-to-fav', e);
        this.fire('add-to-fav', {
          product: this.product
        });
        // this.user.addFav(this.product);
      },

      _favLocation: function(user, product) {
        if (user.uid) {
          return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/favorites/' + product.__firebaseKey__;
        }
      },

      _updateFavIcon: function(e, ref) {
        // console.log('fav');
        if (ref.val()) {
          this.inFav = true;
        } else {
          this.inFav = false;
        }
      }

    });
  </script>
</dom-module>
