<dom-module id="page-package">
  <link rel="import" type="css" href="page-package.css">

  <template>

    <!-- <firebase-document id="package" location$="[[_packageLocation(packageid)]]" data="{{getPackage}}"></firebase-document> -->
    <!-- <firebase-collection location="https://charlesiesbeta.firebaseio.com/packages" data="{{packagesMenu}}"></firebase-collection> -->
    <!-- <firebase-collection id="elements" location$="[[_elementsLocation(getPackage)]]" logs order-by-child="packageByName" equal-to="[[getPackage.name]]" data="{{elements}}"></firebase-collection> -->
    <catalog-data packages="[[packages]]"></catalog-data>

    <catalog-package id="[[packageid]]" data="{{getPackage}}"></catalog-package>
    <iron-media-query query="(max-width: 640px)" query-matches="{{_narrowViewport}}"></iron-media-query>

    <responsive-element>
      <theme-color color="[[getPackage.color]]">
        <paper-drawer-panel id="drawerPanel" responsive-width="900px" drawer-width="272px">
          <app-sidebar drawer>

            <paper-toolbar>
              <app-logo class="flex" tabindex="1"></app-logo>
              <app-bar class="horizontal layout center end-justified" no-search></app-bar>
            </paper-toolbar>

            <div id="search" class="layout horizontal center">
              <iron-icon icon="search"></iron-icon>
              <input id="query" type="search" autocomplete="off" value="{{q::keyup}}" placeholder="Search Elements" class="flex">
            </div>

            <div class="content">
              <div id="package-tag" hidden$="[[!tag]]">
                <span>[[tag]]</span>
                <iron-icon icon="clear" on-tap="clearTag"></iron-icon>
              </div>
              <div id="package-list">
                <h5>Products</h5>
                <nav>
                  <a class="package" is="app-link" href="/p" active$="[[_isEqual(packageid,'')]]" tabindex="1">
                    <div class="layout horizontal center">
                      <div class="all-symbol" aria-hidden="true">
                        <iron-icon icon="apps"></iron-icon>
                      </div>
                      <span class="title flex">All Elements</span>
                    </div>
                  </a>
                  <template is="dom-repeat" items="[[packagesMenu]]">
                    <a class="package" is="app-link" href$="[[_packageLink(item.__firebaseKey__)]]" active$="[[_isEqual(packageid,item.__firebaseKey__)]]" tabindex="1">
                      <div class="layout horizontal center">
                        <package-symbol aria-hidden="true" package="[[item]]"></package-symbol>
                        <span class="title flex">[[item.title]]</span>
                      </div>
                    </a>
                  </template>
                </nav>
              </div>


              <div id="tags">

              </div>

              <div hidden$="[[!tag]]" id="current-tag" class="horizontal layout center">
                <b>Tag:</b>
                <span class="flex">[[tag]]</span>
                <iron-icon icon="clear" on-tap="clearTag"></iron-icon>
              </div>
            </div>

          </app-sidebar>


          <paper-scroll-header-panel main condenses keep-condensed-header>

            <paper-toolbar class="tall">
              <iron-icon icon="menu" paper-drawer-toggle></iron-icon>
              <h2 class="flex">
                <span class="count">[[_elementCount]]</span>
              </h2>
              <span class="flex"></span>
              <div class="bottom">
                <div class="title">[[pageTitle]]</div>[[getPackage.description]]</div>
              <iron-icon id="package-view-mode" icon="[[viewIcon]]" on-tap="toggleView" hidden$="[[_forceCards]]"></iron-icon>
              <cart-icon id="cart-toggle" icon="stars" on-tap="cartOpen"></cart-icon>

              <iron-icon icon="av:mic"></iron-icon>

            </paper-toolbar>

            <div id="container" view$="[[_actualView(view,_narrowViewport)]]">



              <!-- <div class="elements-title horizontal layout center">

              </div> -->

              <!-- <div id="package-heading" hidden$="[[!packageid]]">

              </div> -->

              <div id="element-cards" class="horizontal layout wrap">
                <template is="dom-if" if="[[_stampCards(view,_forceCards)]]">
                  <template name="element-cards-repeat" is="dom-repeat" items="[[getPackage.elementsKeys]]">
                    <element-card elementid="[[item]]" pack="[[getPackage]]"></element-card>
                  </template>
                </template>
              </div>

            </div>

          </paper-scroll-header-panel>


        </paper-drawer-panel>
      </theme-color>
    </responsive-element>
  </template>

  <script>
    (function() {
      var _lastNavigated = null;

      Polymer({
        is: 'page-package',
        enableCustomStyleProperties: true,
        properties: {
          router: Object,
          pageTitle: {
            type: String
          },

          // Query Parameters
          q: {
            type: String,
            notify: true,
            value: ''
          },
          tag: {
            type: String,
            notify: true,
            value: ''
          },
          package: {
            type: Object,
            notify: true
          },
          view: {
            type: String,
            notify: true
          },

          tagList: {
            type: Array,
            computed: 'arrayParam(tag)',
            value: function() {
              return [];
            }
          },
          packageList: {
            type: Array,
            computed: 'arrayParam(package)',
            value: function() {
              return [];
            }
          },

          viewIcon: {
            type: String,
            computed: 'computeViewIcon(view)',
            value: 'view-module'
          },
          packages: Array,
          packageInfo: {
            type: Object,
            value: {}
          },
          // elements: Object,

          _elements: {
            type: Array,
            value: []
          },
          _elementCount: Number,
          _narrowViewport: {
            type: Boolean,
            observer: '_updateForceCards'
          },
          _forceCards: {
            type: Boolean
          },
        },
        observers: [
          // 'updateURL(q,package,tag,view,packageid)',
          // '_elementscheck(_elements)',
          'updateMeta(getPackage)'
        ],
        listeners: {
          'update-params': '_handleParamsUpdate'
        },
        updateURL: function (e) {
          console.log('updateURL: ', e);
        },

        ready: function() {
          // this._updateForceCards();
          // this.view = this._forceCards ? 'cards' : 'table';
          this.view = "cards";
        },

        attached: function() {
          // this.updateMeta();
          this.updateSearch();
        },

        filter: function(element) {
          if (this.q && this.q.length && element.name.indexOf(this.q) < 0) {
            return false;
          }

          console.log(element.package);

          if (this.packages.length && this.packages.indexOf(element.package) <
            0) {
            return false;
          }

          if (this.tagList.length) {

            if (!element.tags) return;

            var match = false;
            for (var i = 0; i < this.tagList.length; i++) {

              if (element.tags.join(' ').indexOf(this.tagList[i]) >= 0)
                match = true;
            }
            if (!match) return false;
          }

          return true;
        },

        updateTag: function(e, detail) {
          e.stopPropagation();
          e.preventDefault();
          var newTag = detail.name;
          var t = this.tagList.slice(0);
          if (t.indexOf(newTag) < 0) t.push(newTag);
          this.tag = t.join(',');
        },
        clearTag: function() {
          this.tag = null;
        },
        updatePackage: function(e) {
          e.stopPropagation();
          e.preventDefault();
          var newPkg = e.currentTarget.name;
          var p = this.packageList.slice(0);
          if (p.indexOf(newPkg) < 0) p.push(newPkg);
          this.package = p.join(',');
        },
        clearPackage: function() {
          this.package = null;
        },
        togglePackages: function() {
          if (this.package) {
            this.prevPackage = this.package;
            this.clearPackage();
          } else {
            this.package = this.prevPackage;
          }
        },
        _parseQueryString: function() {
          var query = window.location.search.substring(1);
          var params = query.split('&');
          var results = [];
          for (var i = 0; i < params.length; i++) {
            var pair = params[i].split('=');
            results[pair[0]] = pair[1];
          }
          return results;
        },
        _buildQueryString: function() {
          var out = [];
          if (this.q && this.q.length) out.push("q=" + this.q);
          if (this.tag && this.tag.length) out.push("tag=" + this.tag);
          // if (this.getPackage && this.getPackage.length) out.push("package=" + this.package);
          if (this.view !== 'table') out.push("view=" + this.view);

          return out.join("&");
        },
        _handleParamsUpdate: function(_, params) {
          for (var key in params) {
            this[key] = params[key];
          }
        },
        _packageLink: function(id) {
          return "/p/" + id;
        },

        _packageLocation: function(id) {
          return "https://charlesiesbeta.firebaseio.com/packages/" + id;
        },

        _packagesLocation: function() {
          return "https://charlesiesbeta.firebaseio.com/packages";
        },

        _elementsLocation: function(getPackage) {
          // console.log('_elementsLocation', getPackage.elements);
          return "https://charlesiesbeta.firebaseio.com/elements/";
        },

        _elementscheck: function(_elements) {
          console.log('_elementscheck', _elements);
        },

        updateSearch: function() {
          var params = this._parseQueryString();
          if (params && params.q) {
            this.async(function() {
              this.$.query.focus();
            });
          }
        },

        updateMeta: function(getPackage) {
          // console.log('updateMeta', getPackage);

          if (!getPackage) return;

          this.customStyle['--my-package-color'] = getPackage.color;
          this.customStyle['--my-package-image'] = "url(" + getPackage.image + ")";
          // console.log(this.customStyle['--my-package-image']);
          this.updateStyles();

          if (this.q && this.q.length) {
            var t = "'" + this.q + "' ";
            t += (this.packageid && getPackage.title) ? getPackage.title :
              "Elements";
            this.pageTitle = t;
          } else if (getPackage) {
            this.pageTitle = getPackage.title;
          } else if (this.tagList.length) {
            this.pageTitle = "Elements Tagged '" + this.tagList.join(
              "' or '") + "'";
          } else {
            this.pageTitle = "All Elements";
          }

          this.fire('page-meta', {
            title: this.pageTitle
          });

        },
        toggleView: function() {
          if (this.view === 'table') {
            this.view = 'cards';
          } else {
            this.view = 'table';
          }
        },
        computeViewIcon: function(view) {
          if (view === 'table') {
            return 'view-module';
          } else {
            return 'view-list';
          }
        },
        arrayParam: function(param) {
          if (!param || !param.length) {
            return [];
          }
          return param.toString().split(',');
        },
        cartOpen: function(e) {
          this.fire('cart-open');
        },
        _stampCards: function(view, stamp) {
          return stamp || view === 'cards';
        },
        _stampTable: function(view, skip) {
          return !skip && view === 'table';
        },
        closeDrawer: function() {
          this.$.drawerPanel.closeDrawer();
        },
        _detectIEVersion: function() {
          // via http://stackoverflow.com/questions/17907445/how-to-detect-ie11
          var rv = -1;
          var ua, re;
          if (navigator.appName === 'Microsoft Internet Explorer') {
            ua = navigator.userAgent;
            re = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) !== null)
              rv = parseFloat(RegExp.$1);
          } else if (navigator.appName === 'Netscape') {
            ua = navigator.userAgent;
            re = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) !== null)
              rv = parseFloat(RegExp.$1);
          }
          return rv;
        },
        _actualView: function(view, force) {
          return force ? 'cards' : view;
        },
        _updateForceCards: function() {
          this._forceCards = this._narrowViewport || this._detectIEVersion() >
            0;
        },
        _isEqual: function(a, b) {
          // console.log('_isEqual', a, b);
          return a === b;
        }
      });
    })();
  </script>

</dom-module>
