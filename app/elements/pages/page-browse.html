<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">

<link rel="import" href="../../bower_components/fireproof-element/fireproof-element.html">

<link rel="import" href="../app-sidebar/app-sidebar.html">
<link rel="import" href="../app-logo/app-logo.html">
<link rel="import" href="../search-bar/search-bar.html">
<link rel="import" href="../cart-icon/cart-icon.html">
<link rel="import" href="../catalog-data/catalog-data.html">
<link rel="import" href="../catalog-category/catalog-category.html">
<link rel="import" href="../package-symbol/package-symbol.html">
<link rel="import" href="../tag-link/tag-link.html">
<link rel="import" href="../theme-color/theme-color.html">
<link rel="import" href="../item-action-menu/item-action-menu.html">
<link rel="import" href="../item-table/item-table.html">
<link rel="import" href="../item-table-cards/item-table-cards.html">
<link rel="import" href="../responsive-element/responsive-element.html">

<link rel="import" href="../catalog-user/catalog-user.html">

<dom-module id="page-browse">
  <link rel="import" type="css" href="page-browse.css">
  <template>
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>
    <catalog-category short="[[category]]" data="{{categoryInfo}}" id="catalogCategory"></catalog-category>
    <paper-drawer-panel id="drawerPanel" responsive-width="900px" narrow="{{narrowMode}}" drawer-width="272px" disable-edge-swipe>
      <app-sidebar drawer>
        <paper-toolbar>
          <app-logo class="flex" tabindex="1" full="true"></app-logo>
          <search-bar class="horizontal layout center end-justified" no-search></search-bar>
        </paper-toolbar>
        <div id="search" class="layout horizontal center">
          <iron-icon icon="search"></iron-icon>
          <input id="query" type="search" autocomplete="off" value="{{q::keyup}}" placeholder="Search" class="flex" on-search="onSearch">
        </div>
        <div class="content">
          <div id="package-tag" hidden$="[[!tag]]">
            <span>[[tag]]</span>
            <iron-icon icon="clear" on-tap="clearTag"></iron-icon>
          </div>
          <div id="package-list">
            <nav>
              <a class="package" is="app-link" href="/" active$="[[_isEqual(package,'')]]" tabindex="1">
                <div class="layout horizontal center">
                  <div class="all-symbol" aria-hidden="true">
                    <iron-icon icon="apps"></iron-icon>
                  </div>
                  <span class="title flex">All Products</span>
                </div>
              </a>
              <template is="dom-repeat" items="{{categories}}" as="menu">
                <template is="dom-if" if="{{!menu.editor}}" restamp="true">
                  <a class="package" is="app-link" href$="[[_categoriesLink(menu.short)]]" active$="[[_isEqual(package,menu.short)]]" tabindex="1">
                    <div class="layout horizontal center">
                      <package-symbol aria-hidden="true" symbol="[[menu.symbol]]" color="[[menu.color]]"></package-symbol>
                      <span class="title flex">[[menu.label]]</span>
                      <template is="dom-if" if="[[menuEditor]]" restamp="true">
                        <paper-icon-button suffix icon="clear" on-tap="_tapMenuEditor" item="[[menu]]"></paper-icon-button>
                      </template>
                    </div>
                  </a>
                </template>

                <template is="dom-if" if="{{menu.editor}}" restamp="true">
                  <div class="layout horizontal center" style="padding-left: 16px;padding-right: 16px;">
                    <package-symbol aria-hidden="true" symbol="[[menu.symbol]]" color="[[menu.color]]" style="margin-right: 16px;"></package-symbol>
                    <paper-input class="flex" tab-index="0" value="{{menu.label::change}}" on-change="_categoryLabelChange" no-label-float disabledx$="{{user.isAdmin}}">
                      <template is="dom-if" if="{{user.isAdmin}}" restamp="true">
                        <paper-icon-button suffix icon="clear" on-tap="_tapClear" item="[[menu]]"></paper-icon-button>
                      </template>
                    </paper-input>
                  </div>
                </template>
              </template>
              <template is="dom-if" if="{{user.isAdmin}}" restamp="true">
                <div class="package" tabindex="1">
                  <div class="layout horizontal center">
                    <package-symbol aria-hidden="true" symbol="[[item.symbol]]" color="[[item.color]]"></package-symbol>
                    <paper-input id="newCategoryInput" class="flex" tab-index="0" value="{{newCategory}}" labelx="{{item.label}}" on-change="_newLabelChange" no-label-float Placeholder="New"></paper-input>
                  </div>
                </div>
              </template>
            </nav>
          </div>
          <div hidden$="[[!tag]]" id="current-tag" class="horizontal layout center">
            <b>Tag:</b>
            <span class="flex">[[tag]]</span>
            <iron-icon icon="clear" on-tap="clearTag"></iron-icon>
          </div>
        </div>
      </app-sidebar>
      <paper-header-panel id="container" modeFFFF="[[_getMode(narrowMode)]]" mode="waterfall" view$="[[_actualView(view)]]" main>
        <div class="paper-header">
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <h2 class="flex">[[pageTitle]]</h2>
          <!-- <paper-icon-button class="toggleViewButton" icon="[[viewIcon]]" on-tap="toggleView" hidden$="[[_forceCards]]"></paper-icon-button> -->
          <paper-menu-button vertical-align="top" horizontal-align="right">

            <template is="dom-if" if="[[!user.loggedin]]" restamp="true">
              <paper-icon-button icon="social:person" class="dropdown-trigger" alt="menu"></paper-icon-button>
            </template>
            <template is="dom-if" if="[[user.loggedin]]" restamp="true">
              <paper-icon-button src="{{user.profileImageURL}}" class="dropdown-trigger" alt="menu"></paper-icon-button>
            </template>

            <paper-menu class="dropdown-content">
              <!-- <paper-item link="cart" on-tap="_tapNav" hidden$="{{narrow}}">
                <iron-icon icon="shopping-cart"></iron-icon>
                <span>{{cartCount}}</span>
              </paper-item> -->
              <paper-item hidden={{!user.loggedin}} link="/account" on-tap="_tapNav">[[user.displayName]]</paper-item>
              <paper-item hidden={{!user.loggedin}} on-tap="_tapLogout">logout</paper-item>
              <paper-item hidden={{user.loggedin}} link="/login" on-tap="_tapLogin">login</paper-item>
            </paper-menu>
          </paper-menu-button>
          <cart-icon class="cartButton" id="cart-toggle" icon="stars" on-tap="cartOpen"></cart-icon>
        </div>
        <div id="content">
          <div id="package-heading" hidden$="[[!categoryInfo]]">
            <div class="description">[[categoryInfo.description]]</div>
          </div>

          <template is="dom-if" if="[[_stampCards(view)]]" restamp>
            <item-table-cards id="item-cards" byshort$="[[category]]" bytag$="[[tag]]" collection="[[collection]]" new-buttons="true" media-path="item.cover.src" edit="[[user.isAdmin]]" new-collection-item="{{newCollectionItem}}"></item-table-cards>
          </template>

        </div>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
</dom-module>

<script>
  (function() {


    function joinPaths(id, paths, callback) {
      var returnCount = 0;
      var expectedCount = paths.length;
      var mergedObject = {};

      paths.forEach(function(p) {
        fb.child(p + '/' + id).once('value',
          // success
          function(snap) {
            // add it to the merged data
            extend(mergedObject, snap.val());

            // when all paths have resolved, we invoke
            // the callback (jQuery.when would be handy here)
            if (++returnCount === expectedCount) {
              callback(null, mergedObject);
            }
          },
          // error
          function(error) {
            returnCount = expectedCount + 1; // abort counters
            callback(error, null);
          }
        );
      });
    }

    function loadCategory(categoryId) {
      joinPaths(categoryId, ['category', 'media'], function(data) {
        console.log(data);
      });
    }

    function extend(base) {
      var parts = Array.prototype.slice.call(arguments, 1);
      parts.forEach(function(p) {
        if (p && typeof(p) === 'object') {
          for (var k in p) {
            if (p.hasOwnProperty(k)) {
              base[k] = p[k];
            }
          }
        }
      });
      return base;
    }

    var _lastNavigated = null;
    Polymer({
      is: 'page-browse',
      enableCustomStyleProperties: true,
      properties: {
        router: Object,
        pageTitle: {
          type: String
        },

        // Query Parameters
        q: {
          type: String,
          notify: true,
          value: '',
          observer: '_qChanged'
        },
        collection: {
          type: String,
          value: 'products'
        },

        newCollectionItem: {
          type: Object,
          notify: true,
          value: {
            status: 1
          }
        },
        tag: {
          type: String,
          notify: true,
          value: ''
        },

        view: {
          type: String,
          notify: true
        },

        tagList: {
          type: Array,
          computed: 'arrayParam(tag)',
          value: function() {
            return [];
          }
        },
        categories: {
          type: Array,
          // computed: 'arrayParam(package)',
          value: function() {
            return [];
          }
        },

        viewIcon: {
          type: String,
          computed: 'computeViewIcon(view)',
          value: 'view-module'
        },

        catalog: {
          type: Object,
          notify: true
        },

        category: {
          type: String,
          notify: true,
          value: ''
        },
        categoryInfo: {
          type: Object,
          value: {}
        },
        editCategory: {
          type: Boolean,
          notify: true,
          value: false
        },
        newCategory: {
          type: String,
          notify: true,
          value: ''
        },

        elements: Array,

        _forceCards: {
          type: Boolean
        },

        // DLX
        user: {
          type: Object,
          notify: true
        },
        loading: {
          type: Boolean,
          notify: true,
          value: true
        },
      },
      observers: [
        'updateURL(q,category)', //tag, view, elements
        'updateMeta(category, categoryInfo)',
        'scrollToTop(package)',
        // '_auth(auth, user)',
        // '_check(view)',
        // '_computeCategoryLocation(category)'
        // '_check(newCollectionItem)'
      ],
      listeners: {
        'update-params': '_handleParamsUpdate',
        'new-item': '_newItem'
      },

      _check: function(obj) {
        console.log(obj);
      },

      ready: function() {
        // console.log('ready');
        this.view = 'cards';
        var _cats = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/categories/'));
        _cats.orderByChild('active').equalTo(1).on('child_added', function(snap) {
          // console.log(snap.val());
          var _obj = snap.val();
          _obj.key = snap.key();
          this.push('categories', _obj);
        }.bind(this));

        _cats.on('child_removed', function(snap) {
          // console.log(snap.val());
          for (var index = 0; index < this.categories.length; index++) {
            // console.log('looking', this.categories[index]);
            if (snap.key() === this.categories[index].key) {
              // console.log('match');
              this.splice('categories', index, 1);
              return;
            }
          }
        }.bind(this));

      },


      attached: function() {
        // console.log('attached');
        // this.view = this._forceCards ? 'cards' : 'table';
      },


      _auth: function(auth, user) {
        console.log(auth);
        if (auth === 'instagram') {
          // console.log(window.location.hash.split('#access_token=')[1]);
          var done = this.$.catalogUser.authInstagram(window.location.hash.split('#access_token=')[1]);
          // console.log(done);
          if (done) {
            this.debounce('authInstagramFFFF', function(argument) {
              window.close();
            });
          }
        }
      },


      _tapClear: function(e) {
        // console.log('clear');
        // console.dir(e);
        var _clear = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/categories/' + e.model.__data__.item.key + '/'));
        // _clear.set(null);
        _clear.remove();
      },

      _newItem: function() {
        // var _newProductItem = {
        //   "creadtedAt": {
        //     ".sv": "timestamp"
        //   }
        // };

        var _newProductItem = {
          creadtedAt: Firebase.ServerValue.TIMESTAMP
        };

        _newProductItem.edit = true;
        if (this.category) {
          // Add category to
          // _newProductItem['categories'] = {};
          // _newProductItem.categories[this.categoryInfo.key] = true;
          _newProductItem.category = this.categoryInfo.short;
          _newProductItem.active = 1;
          // console.log(this.categoryInfo);
        }
        var _products = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/products/'));
        _products.push(_newProductItem).then(function(snap) {
          // console.log(snap);
          console.log();
        }.bind(this));

      },



      _categoryLabelChange: function(e) {
        // console.log(e.model.item);
        var item = e.model.item;
        var label = item.label;
        // var short = label.replace(/[^\w-]/g, '').toLowerCase();
        var short = label.replace(/[^\w-]/g, '');
        item.short = label.replace(/[^\w-]/g, '');
        // console.log('label: ', label);
        // console.log('short: ', short);
        item.key = null;
        var _edit = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/categories/' + item.key + '/'));
        // _edit.child('short').set(short);
        _edit.set(item);

      },

      _newLabelChange: function(e) {
        // console.log(e);
        // console.log(this.newCategory);
        var label = this.newCategory;
        var short = label.replace(/[^\w-]/g, '').toLowerCase();

        if (short.length) {
          // console.log(short);
          var _newC = {};
          _newC.label = label;
          _newC.short = short;
          _newC.active = 1;
          var _newCat = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/categories/'));
          _newCat.push(_newC).then(function(snap) {
            this.newCategory = '';
          }.bind(this));
        }
      },


      _computeCategoryLocation: function(category) {
        console.log(category);
        var catloc = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/categories/'));
        catloc.orderByChild('short').equalTo(category).then(function(snap) {
          console.log(snap.val());
          this.categoryInfo = snap.val();
        }.bind(this));
      },

      filter: function(element) {
        if (this.q && this.q.length && element.name.indexOf(this.q) < 0) {
          return false;
        }

        if (this.packageList.length && this.packageList.indexOf(element.package) < 0) {
          return false;
        }

        if (this.tagList.length) {
          var match = false;
          for (var i = 0; i < this.tagList.length; i++) {
            if (element.tags.join(' ').indexOf(this.tagList[i]) >= 0) match = true;
          }
          if (!match) return false;
        }

        return true;
      },

      updateTag: function(e, detail) {
        e.stopPropagation();
        e.preventDefault();
        var newTag = detail.name;
        var t = this.tagList.slice(0);
        if (t.indexOf(newTag) < 0) t.push(newTag);
        this.tag = t.join(',');
      },
      clearTag: function() {
        this.tag = null;
      },
      updatePackage: function(e) {
        e.stopPropagation();
        e.preventDefault();
        var newPkg = e.currentTarget.name;
        var p = this.packageList.slice(0);
        if (p.indexOf(newPkg) < 0) p.push(newPkg);
        this.package = p.join(',');
      },
      clearPackage: function() {
        this.package = null;
      },
      togglePackages: function() {
        if (this.package) {
          this.prevPackage = this.package;
          this.clearPackage();
        } else {
          this.package = this.prevPackage;
        }
      },
      _parseQueryString: function() {
        var query = window.location.search.substring(1);
        var params = query.split('&');
        var results = [];
        for (var i = 0; i < params.length; i++) {
          var pair = params[i].split('=');
          results[pair[0]] = pair[1];
        }
        return results;
      },
      _buildQueryString: function() {
        var out = [];
        if (this.q && this.q.length) out.push("q=" + this.q);
        if (this.tag && this.tag.length) out.push("tag=" + this.tag);
        if (this.category && this.category.length) out.push("category=" + this.category);
        // if (this.view !== 'table') out.push("view=" + this.view);
        return out.join("&");
      },
      _handleParamsUpdate: function(_, params) {
        console.log(params);
        for (var key in params) {
          this[key] = params[key];
        }
      },
      _categoriesLink: function(short) {
        // return "/browse?package=" + name;
        return "/?category=" + short;
      },
      _qChanged: function(q) {
        if (q) {
          this.async(function() {
            this.$.query.focus();

            // make sure to force the cursor to the end of the
            // input. Only an issue in Firefox.
            this.$.query.setSelectionRange(q.length, q.length);
          });
        }
      },
      updateURL: function(q, category, tag) {
        // console.log(q, category, tag);
        var qs = this._buildQueryString();
        // console.log(qs);
        if (qs !== _lastNavigated && this.router) {
          _lastNavigated = qs;
          // this.router.go('/browse' + (qs.length ? '?' + qs : ''), {replace: true});
          this.router.go('/' + (qs.length ? '?' + qs : ''), {
            replace: true
          });
        }
        // this.updateMeta(category, this.categoryInfo);
        this.scrollToTop();
      },
      updateMeta: function(category, categoryInfo) {
        // console.log(category, categoryInfo);
        if (this.q && this.q.length) {
          var t = "Search '" + this.q + "' ";
          t += (categoryInfo && categoryInfo.label) ? categoryInfo.label : "";
          this.pageTitle = t;
        } else if (category.length && categoryInfo && categoryInfo.label) {
          this.pageTitle = categoryInfo.label;
        } else if (this.tagList.length) {
          this.pageTitle = "Tagged '" + this.tagList.join("' or '") + "'";
        } else {
          this.pageTitle = "All Products";
        }

        this.fire('page-meta', {
          title: this.pageTitle
        });
        this.$.drawerPanel.closeDrawer();
      },
      toggleView: function() {
        if (this.view === 'table') {
          this.view = 'cards';
        } else {
          this.view = 'table';
        }
      },
      computeViewIcon: function(view) {
        if (view === 'table') {
          return 'view-module';
        } else {
          return 'view-list';
        }
      },
      arrayParam: function(param) {
        // console.log('arrayParam', param);
        if (!param || !param.length) {
          return [];
        }
        return param.toString().split(',');
      },
      cartOpen: function(e) {
        this.fire('cart-open');
      },
      onSearch: function(e) {
        // when a user clicks on the (x) button we need to be sure to
        // clear the query
        // console.log('searching: ', this.$.query.value);
        this.q = this.$.query.value;
      },
      scrollToTop: function() {
        this.$.container.scroller.scrollTop = 0;
      },
      _stampCards: function(view) {
        return view === 'cards';
      },
      _stampTable: function(view) {
        return view === 'table';
      },
      closeDrawer: function() {
        this.$.drawerPanel.closeDrawer();
      },
      _actualView: function(view, force) {
        return force ? 'cards' : view;
      },
      _isEqual: function(a, b) {
        return a === b;
      },
      _getColor: function() {
        return this.categoryInfo && this.categoryInfo.color ? this.categoryInfo.color : '';
      },

      _getMode: function(narrow) {
        // console.log(narrow ? 'waterfall' : 'scroll');
        return narrow ? 'waterfall' : 'scroll';
      },
      _tapLogin: function() {
        this.fire('nav', {
          url: "/account"
        });
      },

      _tapLogout: function() {
        this.$.catalogUser.logout();
      },
    });
  })();
</script>
