<dom-module id="page-product">
  <template>
    <style media="screen" is="custom-style">
      :host {
        display: block;
        margin-bottom: 204px;
      }

      .editToolbarTitle {
        --paper-toolbar-background: white;
        -webkit-transition: all 0.3s, -webkit-transform 0.3s, opacity 0.3s;
        transition: all 0.3s, transform 0.3s, opacity 0.3s;
        opacity: 0;
        visibility: hidden;
        -webkit-transform: translateY(-50px);
        transform: translateY(-50px);
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          z-index: 1;
      }

      [edit] .editToolbarTitle {
        visibility: visible;
        opacity: 1;
        -webkit-transform: translateY(0px);
        transform: translateY(0px);
      }

      .productForm[wide] {}

      paper-material {
        background-color: white;
        margin: 16px;
        -webkit-transition: all 0.3s, -webkit-transform 0.3s, opacity 0.3s;
        transition: all 0.3s, transform 0.3s, opacity 0.3s;
      }

      [edit] paper-material {
        -webkit-transform: translateY(100px);
        transform: translateY(100px);
      }

      [wide] paper-material {
        width: 480px;
      }

      [wide] .page-container {
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      .body {
        padding: 16px;
      }

      .small-body {
        padding: 8px;
      }

      .fullwidth {
        width: 100%;
      }

      .headerIcon {
        position: absolute;
        width: 80px;
        height: 80px;
        right: -38px;
        bottom: -14px;
        color: rgba(0, 0, 0, 0.05);
        transform: rotateY( 180deg);
      }

      .section {
        margin-bottom: 24px;
        margin-top: 24px;
        /*border-bottom: 1px solid red;*/
      }

      .sectionHeader {
        margin-bottom: 8px;
        /*height: 56px;*/
        /*padding: 16px;*/
        /*box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 1.16);*/
      }

      .sectionHeader .title {
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 20px;
        font-weight: 500;
        line-height: normal;
      }
      /*  View Product  */

      .productPrice {}

      .margin-right-16 {
        margin-right: 16px;
      }

      .margin-bottom-8 {
        margin-bottom: 8px;
      }
      /*  Product Images  */

      #images {
        position: relative;
      }

      #images .iron-selected {}

      .image-list {
        height: 100%;
        overflow-x: scroll;
        overflow-y: hidden;
      }

      ::-webkit-scrollbar {
        -webkit-appearance: none;
        height: 4px;
      }

      ::-webkit-scrollbar-thumb {
        border-radius: 1px;
        background-color: #f44336;
        /*box-shadow: 0 0 1px rgba(255, 255, 255, .5);*/
      }

      .imagePlaceholder {
        position: relative;
        height: 100%;
      }

      .imagePlaceholder .placeholderBg {
        color: rgba(0, 0, 0, 0.05);
        /*position: absolute;*/
        width: 148px;
        height: 148px;
      }

      .thumb.add {
        --paper-icon-button: {
          color: green;
        }
      }

      .images-container {
        /*padding-bottom: 1px;*/
        /*padding: 8px;*/
        height: 325px;
        border-bottom: 1px solid #e6e6e6;
      }

      .image-container {
        --iron-image-height: 100%;
        height: 320px;
      }

      .image {
        /*width: 80vw;
        height: 80vw;
        margin-right: 8px;*/
        background-color: white;
      }
      /* Details */

      #details {
        margin-top: 16px;
      }

      .line1 {
        height: 64px;
        margin-bottom: 8px;
      }

      .productDescription {}
      /*  Card Actions  */

      [in-fav] {
        color: #f44336;
      }

      [in-cart] {
        color: #f44336;
      }

      [edit] .actionfab {
        background-color: var(--google-green-500);
        color: white;
      }

      .inCart,
      .inFav,
      .actionFab {
        transition: all 2s cubic-bezier(.02, .82, 1, .33);
      }

      .actionFab {
        position: absolute;
        bottom: -24px;
        right: 16px;
        background-color: white;
      }

      .card-actions {
        line-height: 40px;
      }

      .card-actions[admin] .value {
        width: 35px;
      }
      /*  Product Options  */

      .productOptionLabelDefaultValue {
        margin-top: 30px;
        width: 100px;
      }

      .productOptionPriceValue {
        width: 72px;
      }

      .productOptionPriceDefaultValue {
        width: 72px;
      }

      .productOptionsRemoveContainer {
        height: 100%;
      }
      /*  Product Tags  */

      .tags .label {
        width: 45px;
      }
      /*  Product Status  */

      .productStatus {
        line-height: 1px;
      }

      .productStatusSelector {
        width: 128px;
        height: 24px;
      }
    </style>

    <iron-media-query query="(min-width: 841px)" query-matches="{{wide}}"></iron-media-query>
    <catalog-product id="catalogProduct" by-id="{{byId}}" data="{{product}}" edit="{{_edit}}"></catalog-product>
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>
    <google-client-loader id="driveApi" name="drive" version="v2" on-google-api-loadx="driveApiLoaded"></google-client-loader>
    <catalog-cart id="catalogCart" items="{{cart}}" count={{count}}></catalog-cart>

    <form is="iron-form" class="productForm" action="index.html" method="post" edit$="{{edit}}" wide$="{{wide}}">


      <!-- <template is="dom-if" if="{{edit}}">
        <paper-toolbar class="editToolbarTitle" show$="{{edit}}">
          <div class="paper-font-title" hidden="{{edit}}">[[pageTitle]]</div>
          <template is="dom-if" if="{{edit}}">
            <paper-input class="editTitleValue fullwidth" value="{{_edit.title::input}}" label="Title" type="text">
            </paper-input>
          </template>
          <span class="flex"></span>
          <iron-icon class="headerIcon" icon="maps:local-shipping"></iron-icon>
        </paper-toolbar>
      </template> -->
      <paper-toolbar class="editToolbarTitle">
        <paper-input class="editTitleValue flex" value="{{_edit.title::input}}" label="Title" type="text">
        </paper-input>
        <!-- <paper-icon-button class="editImagesButton" icon="editor:mode-edit" on-tap="_editImages"></paper-icon-button> -->
      </paper-toolbar>



      <div class="page-container">
        <paper-material elevation="1">
          <!-- <template is="dom-if" if="{{product.images}}"> -->
          <template is="dom-if" if="{{edit}}">
            <paper-toolbar class="editToolbarTitle">
              <div class="paper-font-title">[[_computeImageCountText(product)]]</div>
              <span class="flex"></span>
              <paper-icon-button class=" editImagesButton" icon="add" on-tap="_openPicker"></paper-icon-button>
            </paper-toolbar>
          </template>


          <div id="images" class="images-container">
            <div class="image-list">

              <template is="dom-if" if="{{!product.images}}">
                <div class="imagePlaceholder fullwidth layout horizontal center-center">

                  <iron-icon class="placeholderBg" icon="image:collections" hidden="{{edit}}"></iron-icon>

                  <div class="fit layout horizontal center-center">
                    <template is="dom-if" if="{{edit}}">
                      <h2>Add Image
                        <paper-icon-button icon="add" on-tap="_openPicker"></paper-icon-button>
                      </h2>
                    </template>
                  </div>

                </div>
              </template>

              <iron-selector attr-for-selected="item" selected="{{imageSelected}}" class=" layout horizontal">
                <template is="dom-repeat" items="{{product.images}}">
                  <div class="image-container">
                    <!-- <iron-image class="image" src="{{item.webContentLink}}" fade preload sizing="contain"></iron-image> -->
                    <img class="image" src="{{item.webContentLink}}" height="100%" />
                  </div>
                </template>
              </iron-selector>
            </div>

            <paper-fab class="actionFab" in-cart$="[[inCart]]" icon$="[[_actionFabIcon(user, edit)]]" on-tap="_actionFabTap"></paper-fab>

          </div>


          <div id="details" class="layout vertical body">

            <template is="dom-if" if="{{!edit}}">

              <div class="layout horizontal margin-right-16">
                <div class="paper-font-title">
                  <span>[[product.title]]</span>
                </div>

                <span class="flex"></span>

                <h3 class="productPrice">
                  <span class="red">[[_computePrice(product.price)]]</span>
                </h3>

              </div>


            </template>

            <!-- Card Actions -->
            <div class="card-actions layout horizontal center-centerFFFF">

              <div class="layout horizontal margin-right-16">
                <paper-icon-button class="inFav" icon="favorite" on-tap="_favTap" in-fav$="[[inFav]]" disabled$="[[!loggedin]]"></paper-icon-button>
                <template is="dom-if" if="{{edit}}">
                  <div>100k</div>
                </template>
              </div>

              <div class="layout horizontal margin-right-16">
                <paper-icon-button hidden$="{{!user.isAdmin}}" class="inCart" icon="shopping-cart" on-tap="_cartTap" in-cart$="[[inCart]]"></paper-icon-button>
                <template is="dom-if" if="{{edit}}">
                  <div>100k</div>
                </template>
              </div>

              <!-- <template is="dom-if" if="{{!user.isAdmin}}">
              <h4 class="productPrice">
                <span class="red">[[_computePrice(product.price)]]</span>
              </h4>
            </template> -->

            </div>



            <!-- Product Description -->

            <div class="productDescription section layout vertical">
              <!-- Product Description -->
              <template is="dom-if" if="{{!edit}}">
                <div hidden="{{!product.description}}">
                  <span class="paper-font-body1">{{product.description}}</span>
                </div>
              </template>

              <template is="dom-if" if="{{edit}}">
                <!-- <paper-input class="editTitleValue fullwidth" value="{{_edit.title::input}}" label="Title" type="text">
              </paper-input> -->
                <paper-textarea class="" label="description" rows="1" max-rows="2" value="{{_edit.description}}"></paper-textarea>
              </template>
            </div>




            <!-- Options List -->
            <template is="dom-if" if="{{product.options}}">
              <template is="dom-if" if="{{!edit}}">


                <template is="dom-repeat" items="{{product.options}}">
                  <div class="layout horizontal  " hidden="{{edit}}">
                    <div class="margin-right-16">[[item.title]]</div>
                    <div class="">+
                      <span>[[item.price]]</span>
                    </div>
                  </div>
                </template>



              </template>
            </template>


            <!-- Option List EDIT -->
            <template is="dom-if" if="{{edit}}">
              <div class="section productOptions">
                <div class="sectionHeader layout horizontal">
                  <div class="title">
                    Options
                  </div>
                  <template is="dom-if" if="{{edit}}">
                    <span class="flex"></span>
                    <paper-button class="addTagsButton" in-fav on-tap="_tapAddOption">Add Option
                      <iron-icon icon="add"></iron-icon>
                    </paper-button>
                  </template>
                </div>

                <div class="productOptions layout vertical">
                  <!-- Admin -->
                  <template is="dom-if" if="{{edit}}">

                    <div class=" layout horizontal">
                      <div class="productOptionLabelDefaultValue layout start margin-right-16">
                        Default:
                      </div>

                      <span class="flex"></span>

                      <paper-input class="productOptionPriceDefaultValue layout end" value="{{_edit.price::change}}" label="price" type="number">
                        <div prefix>$</div>
                      </paper-input>
                    </div>

                    <template is="dom-repeat" items="{{product.options}}">
                      <div class="layout horizontal">
                        <paper-input class="productOptionLabelValue margin-right-16" value="{{item.title::input}}" label="Option Label" type="text">
                        </paper-input>
                        <span class="flex"></span>
                        <paper-input class="productOptionPriceValue" value="{{item.price::input}}" label="price" type="number">
                          <div prefix>$</div>
                        </paper-input>

                        <div class="productOptionsRemoveContainer">
                          <paper-icon-button icon="clear" on-tap="_tapRemoveOption"></paper-icon-button>
                        </div>

                      </div>
                    </template>

                  </template>
                </div>
              </div>
            </template>





            <!-- Product Tags -->
            <template is="dom-if" if="{{edit}}">
              <div class="section productTags layout">
                <div class="sectionHeader layout horizontal">
                  <div class="title">
                    Tags
                  </div>

                  <span class="flex"></span>

                  <paper-menu-button vertical-align="top" horizontal-align="right">
                    <paper-button class="dropdown-trigger addTagsButton" in-fav>
                      <iron-icon icon="add"></iron-icon>Add Tag</paper-button>
                    <paper-menu class="dropdown-content">
                      <paper-item>Unpublished</paper-item>
                      <paper-item>Active</paper-item>
                      <paper-item>Sold Out</paper-item>
                      <paper-item>Pre-Order</paper-item>
                    </paper-menu>
                  </paper-menu-button>
                </div>

                <template is="dom-if" if="{{edit}}">
                  <template is="dom-repeat" items="[[product.tags]]">
                    <paper-chip animated removable on-remove="_removeTag">
                      <h1>[[item.title]]</h1>
                    </paper-chip>
                  </template>
                </template>


                <template is="dom-if" if="{{!user.isAdmin}}">
                  <div class="layout horizontal wrap">
                    <template is="dom-repeat" items="[[product.tags]]">
                      <a href="" class="margin-right-16">
                    r Parker
                  </a>
                    </template>
                  </div>
                </template>


              </div>
            </template>

            <!-- Product Status -->
            <template is="dom-if" if="{{edit}}">

              <div class="section  productStatus">
                <div class="sectionHeader layout horizontal">
                  <div class="title">
                    Status
                  </div>
                  <span class="flex"></span>
                  <paper-dropdown-menu class="productStatusSelector layout end" noLabelFloat="true">
                    <paper-menu class="dropdown-content" selected="{{_edit.status}}">
                      <paper-item>Unpublished</paper-item>
                      <paper-item>Active</paper-item>
                      <paper-item>Sold Out</paper-item>
                      <paper-item>Pre-Order</paper-item>
                    </paper-menu>
                  </paper-dropdown-menu>
                </div>
              </div>

            </template>

          </div>

        </paper-material>
      </div>
    </form>
    <script type="text/javascript" src="//apis.google.com/js/api.js?onload=onApiLoad" async></script>
  </template>


  <script>
    var picker, pickerReady, thiss;

    function onApiLoad() {
      // console.log('apiload');
      gapi.load('picker', {
        'callback': function(argument) {
          pickerReady = true;
        }
      });
    }

    function setupPicker(cb, developerKey, accessToken) {
      if (!pickerReady) return;
      var supportedMimeType = "image/png,image/jpeg,image/jpg";

      var view1 = new google.picker.DocsView();
      view1.setMimeTypes(supportedMimeType);
      view1.setLabel("Image Files");

      var view3 = new google.picker.View(google.picker.ViewId.PHOTOS);
      view3.setLabel("Photos");

      var view2 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);
      view2.setLabel("Recently Selected");

      picker = new google.picker.PickerBuilder().
      addView(view1).
      addView(view3).
      addView(view2).
        // enableFeature(google.picker.Feature.NAV_HIDDEN).
      enableFeature(google.picker.Feature.MULTISELECT_ENABLED).
      setOAuthToken(accessToken).
      setDeveloperKey(developerKey).
      setCallback(cb).
      build();

    }
    // Google Drive API Const
    // var developerKey = 'AIzaSyAkeEajTtdn1qGL-UKCEq5uJNiRziLY3X4';
    var developerKey = 'AIzaSyB2x_CG22tc1yosAWKz5hOfx6g6CF8d0Gw';

    // Utils
    var decimalOnly = /^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;

    Polymer({
      is: 'page-product',
      enableCustomStyleProperties: true,
      properties: {
        router: Object,

        // page
        byId: {
          type: String,
          notify: true,
        },

        pageTitle: {
          type: String,
          notify: true,
        },

        product: {
          type: Object,
          notify: true,
        },
        addImages: {
          type: Array,
          notify: true,
        },
        images: {
          type: Array,
          notify: true,
        },
        user: {
          type: Object,
          notify: true
        },

        actionFabIcon: {
          notify: true,
          // value: 'shopping-cart'
        },

        editImages: {
          type: Boolean,
          notify: true,
        },

        _edit: {
          type: Object,
          notify: true
        },

        edit: {
          type: Boolean,
          notify: true,
          value: false
        },

        imageSelected: {
          type: Number,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
          value: []
        },

        // cart: Array,
        // inCart: {
        //   type: Boolean,
        //   value: false,
        //   notify: true,
        // },
        // inFav: {
        //   type: Boolean,
        //   value: false,
        //   notify: true,
        // },
        // _fav: {
        //   type: Object,
        //   notify: true
        // },
      },
      observers: [
        '_updateCartIcon(cart, product)',
        '_computePageTitle(product)',
        // 'check(images.*)',
        '_computePicker(user)',
        '_computeNewProduct(byId)',
      ],

      _actionFabIcon: function(user, edit) {
        if (user.isAdmin && edit) {
          return 'save';
        } else if (user.isAdmin && !edit) {
          return 'editor:mode-edit';
        } else if (!user.isAdmin) {
          return 'shopping-cart';
        }
      },

      ready: function() {
        // console.log(_images);
        // this.images = _images;
      },

      dettached: function() {
        console.dir(this.edit);
      },

      _tapAddOption: function() {
        // console.log('new option');
        this.$.catalogProduct.newOption();
      },

      _tapRemoveOption: function(item) {
        // console.log('tap remove option: ', item);
        this.$.catalogProduct.removeOption(item.model.__data__.item);
      },

      _actionFabTap: function(e, _) {
        e.stopPropagation();
        // console.log('fire: add-to-cart');
        if (!this.user.isAdmin) {
          this.fire('add-to-cart', {
            product: this.product
          });
          // this.$.catalogCart.addCart(this.product);
          this.inCart = true;
          return;
        }
        this.set('edit', !this.edit);
        return;
      },

      _computeNewProduct: function(byId) {
        // console.log(byId);
        // console.log(this._product.categories[0]);
        // this.product = this._product;
        if (byId === 'new') {
          // Add one
          key = this.$.catalogProduct.new();
          // console.log(key);
          this.debounce('_computeNewProductDebounce', function(argument) {
            // this.fire('nav', {
            //   path: '/product/' + key,
            //   replace: true
            // });
            // var path = "/product/" + key + "&edit=true";
            // history.replaceState(key, null, path);
            this.router.go("/product/" + key, {
              replace: true
            });
            // window.location.search = path;
            this.edit = true;
            this.byId = key;
          }, 10);

        }
      },

      _computeImageCountText: function(product) {
        // console.log(product.images);
        if (product.images) {
          if (product.images.length > 1) {
            return product.images.length + " Images";
          }
          return product.images.length + " Image";
        }
        return 'None, add some!';

      },


      // page

      _computePageTitle: function(product) {
        // console.log(product);
        if (!product) {
          return;
        }
        if (this.byId) {
          this.pageTitle = this.product.title;
          return;
        }
        this.pageTitle = 'No Product Found';
      },

      // Product

      _computePrice: function(price) {
        return '$' + Number(price).toFixed(2);
      },

      // Cart


      _updateCartIcon: function(cart, product) {
        // console.log(product);
        for (var i = 0; i < cart.length; i++) {
          // console.log(cart[i].__firebaseKey__ === product.__firebaseKey__);
          if (cart[i].__firebaseKey__ === product.__firebaseKey__) {
            this.inCart = true;
            // return true;
          }
        }
      },

      // Favorites

      _favTap: function(e) {
        e.stopPropagation();
        // console.log('add-to-fav', e);
        if (this.user.isAdmin) return;
        this.fire('add-to-fav', {
          product: this.product
        });
        // this.user.addFav(this.product);
      },

      _favLocation: function(user, product) {
        if (user.uid) {
          return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/favorites/' + product.__firebaseKey__;
        }
      },

      _updateFavIcon: function(e, ref) {
        // console.log('fav');
        if (ref.val()) {
          this.inFav = true;
        } else {
          this.inFav = false;
        }
      },


      // Drive

      _getDriveFile: function(file) {
        // console.log(file.id);

        // console.dir(this.$.driveApi);
        var request = this.$.driveApi.api.files.get({
          'fileId': file.id,
          access_token: this.user.accessToken
            // 'api': developerKey
        });

        request.execute(function(resp) {
          // console.log(resp);
          thiss.$.catalogProduct.addImage(resp);
        });

      },


      // Picker

      _openPicker: function(e) {
        // console.log(picker);
        // console.log(picker);
        if (!picker) {
          this.fire('toast', {
            text: 'have to be admin to add images'
          });
          return;
        }
        picker.setVisible(true);
      },


      google_api_load_error: function(argument) {
        console.error(e);
      },

      _computePicker: function(user) {
        if (!user) return;
        // console.log(user);
        // user.accessToken
        thiss = this;
        setupPicker(this._pickerCallback, developerKey, user.accessToken);
      },

      _pickerCallback: function(data) {

        var url = 'nothing';
        if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
          var docs = data[google.picker.Response.DOCUMENTS];
          // console.dir(data.docs);
          for (var i = 0; i < docs.length; i++) {
            thiss._getDriveFile(data.docs[i]);
            // data.docs[i].id
            // console.log('docs[i].id: ', docs[i]);
            // thiss.$.ajax.url = "https://www.googleapis.com/drive/v2/files/" + docs[i].id + "?key=AIzaSyAkeEajTtdn1qGL-UKCEq5uJNiRziLY3X4";
            // thiss.$.ajax.url = "http://localhost:8080/addPickerImages/?ac=" + thiss.user.accessToken;
            // thiss.$.ajax.body = docs;
            // thiss.$.ajax.generateRequest();
            // console.dir(thiss.$.ajax);

          }
        }
      },



      // END SCRIPT

    });
  </script>
</dom-module>
