<dom-module id="page-product">
  <template>
    <style media="screen" is="custom-style">
      :host {
        /*display: block;*/
        /*padding-bottom: 204px;*/
      }

      .editToolbarTitle {
        --paper-toolbar-background: white;
        -webkit-transition: all 0.3s, -webkit-transform 0.3s, opacity 0.3s;
        transition: all 0.3s, transform 0.3s, opacity 0.3s;
        opacity: 0;
        visibility: hidden;
        -webkit-transform: translateY(-50px);
        transform: translateY(-50px);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        /*z-index: 1;*/
      }
      /*[edit] .editToolbarTitle {
        visibility: visible;
        opacity: 1;
        -webkit-transform: translateY(0px);
        transform: translateY(0px);
      }*/
      /*[edit] .productForm {
        padding-bottom: 172px;
      }*/

      paper-material {
        min-height: 1px;
        background-color: white;
        margin: 16px;
        -webkit-transition: all 0.3s, -webkit-transform 0.3s, opacity 0.3s;
        transition: all 0.3s, transform 0.3s, opacity 0.3s;
        width: 288px;
      }
      /*[edit] paper-material {
        -webkit-transform: translateY(100px);
        transform: translateY(100px);
      }*/

      .page-container {
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      [edit] .page-container {
        padding-bottom: 160px;
      }

      .body {
        padding: 16px;
      }

      .small-body {
        padding: 8px;
      }

      .fullwidth {
        width: 100%;
      }

      .headerIcon {
        position: absolute;
        width: 80px;
        height: 80px;
        right: -38px;
        bottom: -14px;
        color: rgba(0, 0, 0, 0.05);
        transform: rotateY( 180deg);
      }

      .section {
        margin-bottom: 24px;
        margin-top: 24px;
        /*border-bottom: 1px solid red;*/
      }

      .sectionHeader {
        margin-bottom: 8px;
        /*height: 56px;*/
        /*padding: 16px;*/
        /*box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 1.16);*/
      }

      .sectionHeader .title {
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 20px;
        font-weight: 500;
        /*line-height: normal;*/
        line-height: 40px;
      }
      /*  View Product  */

      .productPrice {}

      .margin-right-16 {
        margin-right: 16px;
      }

      .margin-bottom-8 {
        margin-bottom: 8px;
      }
      /*  Product Images  */

      .editToolbarImages {
        background: rgba(0, 0, 0, 0.25);
        /*position: fixed;*/
        position: absolute;
        color: #f5f5f5;
        /*z-index: 1;*/
        right: 0;
        top: 0;
        left: 0;
      }

      #images {
        position: relative;
        height: 296px;
        z-index: 0;
        border-bottom: 1.5px solid #e6e6e6;
      }

      #images .iron-selected {}

      .image-list {
        height: 100%;
        overflow-x: scroll;
        overflow-y: hidden;
        display: flex;
      }

      ::-webkit-scrollbar {
        -webkit-appearance: none;
        height: 4px;
      }

      ::-webkit-scrollbar-thumb {
        border-radius: 1px;
        background-color: #f44336;
        /*box-shadow: 0 0 1px rgba(255, 255, 255, .5);*/
      }

      .imagePlaceholder {
        position: relative;
        /*height: 100%;*/
      }

      .imagePlaceholder .placeholderBg {
        color: rgba(0, 0, 0, 0.05);
        /*position: absolute;*/
        width: 148px;
        height: 148px;
      }

      .thumb.add {
        --paper-icon-button: {
          color: green;
        }
      }

      .images-container {
        /*padding-bottom: 1px;*/
        /*padding: 8px;*/
        /*height: 325px;*/
        -webkit-flex-direction: row;
        /* Safari */
        flex-direction: row;
        /*height: 288px;
        width: 288px;*/
      }

      iron-image,
      .image-container {
        /*--iron-image-height: 100%;*/
        height: 288px;
        width: 288px;
      }

      @media all and (min-width: 481px) {
        paper-material {
          width: 464px;
        }
        #images {
          height: 468px;
        }
        iron-image,
        .image-container {
          height: 464px;
          width: 464px;
        }
      }

      @media all and (min-width: 705px) {
        paper-material {
          width: 416px;
        }
        #images {
          height: 420px;
        }
        iron-image,
        .image-container {
          height: 416px;
          width: 416px;
        }
      }

      iron-image {
        /*width: 100%;*/
        /*height: 288px;*/
        --iron-image-width: 100%;
        /*--iron-image-height: 288px;*/
        /*height: 100%;*/
        background-color: #212121;
      }

      iron-image-container iron-image /deep/ img {
        width: 100%;
        height: 100%;
      }
      /* Details */

      #details {
        margin-top: 16px;
      }

      .line1 {
        height: 64px;
        margin-bottom: 8px;
      }

      .productDescription {}

      .productDescriptionText {
        margin-top: 16px;
      }
      /*  Card Actions  */

      [in-fav] {
        color: #f44336;
      }

      [in-cart] {
        color: #f44336;
      }

      [edit] paper-fab {
        background-color: var(--google-green-500);
        color: white;
      }

      .actionFab {
        transition: all .2s cubic-bezier(.02, .82, 1, .33);
      }

      .actionFab {
        position: absolute;
        bottom: -26px;
        right: 16px;
        background-color: white;
      }

      .card-actions {
        line-height: 40px;
      }

      [edit] .card-actions {
        margin-bottom: 16px;
      }

      .card-actions[admin] .value {
        width: 35px;
      }
      /*  Product Description  */

      [edit] .editDescriptionValue {
        margin-bottom: 16px;
      }
      /*  Product Options  */

      .productOptionLabelDefaultValue {
        /*margin-top: 30px;*/
        /*width: 100px;*/
      }

      .productOptionPriceDefaultValue,
      .productOptionPriceValue {
        width: 56px;
      }

      .productOptions {
        margin-bottom: 0;
      }

      .productOptionsRemoveContainer {
        height: 100%;
      }
      /*  Product Tags  */

      .tags .label {
        width: 45px;
      }
      /*  Product Status  */

      .productStatus {
        line-height: 1px;
      }

      .productStatusSelector {
        /*width: 128px;
        height: 24px;*/
      }
    </style>

    <catalog-product id="catalogProduct" by-id$="{{byId}}" data="{{product}}" edit="{{_edit}}" loading="{{loading}}"></catalog-product>
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>
    <catalog-cart id="catalogCart" items="{{cart}}" count={{count}}></catalog-cart>

    <template is="dom-if" if="{{product}}" restamp="true">
      <form is="iron-form" class="productForm" action="index.html" method="post" edit$="{{edit}}">
        <!-- <template is="dom-if" if="{{edit}}">
        <paper-toolbar class="editToolbarTitle" show$="{{edit}}">
          <div class="paper-font-title" hidden="{{edit}}">[[pageTitle]]</div>
          <template is="dom-if" if="{{edit}}">
            <paper-input class="editTitleValue fullwidth" value="{{_edit.title::input}}" label="Title" type="text">
            </paper-input>
          </template>
          <span class="flex"></span>
          <iron-icon class="headerIcon" icon="maps:local-shipping"></iron-icon>
        </paper-toolbar>
      </template> -->
        <paper-toolbar class="editToolbarTitle">
          <paper-input class="editTitleValue flex" value="{{_edit.title::input}}" label="Title" type="text">
          </paper-input>
          <!-- <paper-icon-button class="editImagesButton" icon="editor:mode-edit" on-tap="_editImages"></paper-icon-button> -->
        </paper-toolbar>



        <div class="page-container">
          <paper-material elevation="1">
            <!-- <template is="dom-if" if="{{product.images}}"> -->
            <!-- <template is="dom-if" if="{{edit}}">
            <paper-toolbar class="editToolbarImages">
              <div class="paper-font-title">[[_computeImageCountText(product)]]</div>
              <span class="flex"></span>
              <paper-icon-button class=" editImagesButton" icon="add" on-tap="_openPicker"></paper-icon-button>
            </paper-toolbar>
          </template> -->


            <div id="images" class="images-container">
              <div class="image-list">

                <template is="dom-if" if="{{!product.images.length}}">
                  <div class="imagePlaceholder fullwidth layout horizontal center-center">
                    <iron-icon class="placeholderBg" icon="image:collections" hidden="{{edit}}"></iron-icon>
                    <!-- <div class="fit layout horizontal center-center">
                    <template is="dom-if" if="{{edit}}">
                      <h2>Add Image
                        <paper-icon-button icon="add" on-tap="_openPicker"></paper-icon-button>
                      </h2>
                    </template>
                  </div> -->
                  </div>
                </template>

                <iron-selector attr-for-selected="item" selected="{{imageSelected}}" class=" layout horizontal">
                  <template is="dom-repeat" items="{{product.images}}">
                    <div class="image-container">
                      <iron-image class="image" src="{{item.images.low_resolution.url}}" fade preload sizingx="cover"></iron-image>
                      <!-- <img class="image" src="{{item.src}}" height="100%" /> -->
                    </div>
                  </template>
                  <!-- <template is="dom-if" if="{{edit}}">
                  <div class=" image-container layout horizontal center-center addImage">
                    <h2>Add Image
                      <paper-icon-button icon="add" on-tap="_openPicker"></paper-icon-button>
                    </h2>
                  </div>
                </template> -->
                </iron-selector>

              </div>

              <paper-fab class="actionFab" in-cart$="[[inCart]]" icon$="[[_actionFabIcon(user, edit)]]" on-tap="_actionFabTap" edit$="{{edit}}"></paper-fab>

            </div>


            <div id="details" class="layout vertical body">

              <template is="dom-if" if="{{!edit}}">

                <div class="layout horizontal">
                  <div class="paper-font-title margin-right-16">
                    <span>[[product.title]]</span>
                  </div>

                  <span class="flex"></span>

                  <h3 class="productPrice">
                    <span class="red">[[_computePrice(product.price)]]</span>
                  </h3>

                </div>


              </template>

              <!-- Card Actions -->
              <div class="card-actions layout horizontal center-centerFFFF">

                <div class="layout horizontal margin-right-16">
                  <paper-icon-button class="inFav" icon="favorite" on-tap="_favTap" in-fav$="[[inFav]]" disabled$="[[!loggedin]]"></paper-icon-button>
                  <template is="dom-if" if="{{edit}}">
                    <div>100k</div>
                  </template>
                </div>

                <div class="layout horizontal margin-right-16">
                  <paper-icon-button hidden$="{{!user.isAdmin}}" class="inCart" icon="shopping-cart" on-tap="_cartTap" in-cart$="[[inCart]]"></paper-icon-button>
                  <template is="dom-if" if="{{edit}}">
                    <div>100k</div>
                  </template>
                </div>

                <!-- <template is="dom-if" if="{{!user.isAdmin}}">
              <h4 class="productPrice">
                <span class="red">[[_computePrice(product.price)]]</span>
              </h4>
            </template> -->

              </div>



              <!-- Product Description -->

              <div class="productDescription layout vertical">
                <!-- Product Description -->
                <template is="dom-if" if="{{!edit}}">
                  <div hidden="{{!product.description}}">
                    <div class="paper-font-body1 productDescriptionText">{{product.description}}</div>
                  </div>
                </template>

                <template is="dom-if" if="{{edit}}">
                  <paper-input class="editTitleValue fullwidth " value="{{_edit.title::input}}" label="Title" type="text" always-float-label>
                  </paper-input>
                  <paper-textarea class="editDescriptionValue fullwidth " label="description" rows="1" max-rows="4" value="{{_edit.description}}" always-float-label></paper-textarea>
                </template>
              </div>


              <!-- Options List -->
              <div class="section productOptions">

                <template is="dom-if" if="{{product.options}}">
                  <template is="dom-if" if="{{!edit}}">
                    <template is="dom-repeat" items="{{product.options}}">
                      <div class="layout horizontal" hidden="{{edit}}">
                        <div class="margin-right-16">[[item.title]]</div>
                        <div class="">+
                          <span>[[item.price]]</span>
                        </div>
                      </div>
                    </template>
                  </template>
                </template>

                <!-- Option List EDIT -->
                <template is="dom-if" if="{{edit}}">

                  <div class="sectionHeader layout horizontal">
                    <div class="title">
                      Options
                    </div>
                    <span class="flex"></span>
                    <paper-icon-button icon="add" in-fav on-tap="_tapAddOption"></paper-icon-button>
                  </div>

                  <div class="layout vertical">
                    <!-- Admin -->
                    <template is="dom-if" if="{{edit}}">

                      <div class=" layout horizontal">
                      <div class="productOptionLabelDefaultValue layout start margin-right-16">
                        Default Price:
                      </div>

                      <span class="flex"></span>

                      <paper-input class="productOptionPriceDefaultValue layout end" value="{{_edit.price::change}}" label="price" type="number" no-label-float>
                        <div prefix>$</div>
                      </paper-input>
                    </div>

                      <template is="dom-repeat" items="{{product.options}}">
                        <!-- <div class="layout horizontal">
                        <paper-input class="productOptionLabelValue margin-right-16" value="{{item.title::input}}" label="Label" type="text" always-float-label>
                        </paper-input>
                        <span class="flex"></span>
                        <paper-input class="productOptionPriceValue" value="{{item.price::input}}" label="price" type="number" no-label-float>
                          <div prefix>$</div>
                        </paper-input>
                        <div class="productOptionsRemoveContainer">
                          <paper-icon-button icon="clear" on-tap="_tapRemoveOption"></paper-icon-button>
                        </div>
                      </div> -->
                        <div class="layout horizontal">
                          <paper-input class="productOptionLabelValue margin-right-16" value="{{item.title::input}}" label="Label" type="text" always-float-label>
                          </paper-input>
                          <span class="flex"></span>
                          <paper-input class="productOptionPriceValue" value="{{item.price::input}}" label="Price" type="number">
                            <div prefix>$</div>
                          </paper-input>
                          <paper-icon-button on-tap="_tapRemoveOption" icon="clear" alt="clear" title="clear" style="margin-top: 20px;">
                          </paper-icon-button>
                        </div>

                      </template>

                    </template>
                  </div>

                </template>

              </div>

              <!-- Product Tags -->
              <template is="dom-if" if="{{edit}}">
                <div class="section productTags layout">
                  <div class="sectionHeader layout horizontal">
                    <div class="title">
                      Tags
                    </div>
                    <span class="flex"></span>
                    <paper-icon-button icon="add" in-fav on-tap="_tapAddTag"></paper-icon-button>
                  </div>

                  <template is="dom-if" if="{{edit}}">
                    <template is="dom-repeat" items="[[product.tags]]">
                      <paper-chip animated removable on-remove="_removeTag">
                        <h1>[[item.title]]</h1>
                      </paper-chip>
                    </template>
                  </template>

                </div>
              </template>

              <!-- Product Status -->
              <template is="dom-if" if="{{edit}}">

                <paper-dropdown-menu class="productStatusSelector" label="Status" always-float-label>
                  <!-- class="layout end" -->
                  <paper-menu class="dropdown-content" selected="{{_edit.status}}">
                    <paper-item>Unpublished</paper-item>
                    <paper-item>Active</paper-item>
                    <paper-item>Sold Out</paper-item>
                    <paper-item>Pre-Order</paper-item>
                  </paper-menu>
                </paper-dropdown-menu>

                <!-- <div class="section  productStatus">
                <div class="sectionHeader layout horizontal">
                  <div class="title">
                    Status
                  </div>
                  <span class="flex"></span>
                </div>
              </div> -->

              </template>

            </div>

          </paper-material>
        </div>
      </form>
    </template>

    <instagram-picker id="instagramPicker" token="{{user.instagram.authCode}}" on-media-selected="_instagramMediaSelected">
    </instagram-picker>


    <!-- <script type="text/javascript" src="//apis.google.com/js/api.js?onload=onApiLoad" async></script> -->
  </template>

  <script>
    var _lastNavigated = null;
    // Utils
    var decimalOnly = /^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;

    Polymer({
      is: 'page-product',
      enableCustomStyleProperties: true,
      properties: {
        router: Object,

        // page
        byId: {
          type: String,
          notify: true,
        },

        pageTitle: {
          type: String,
          notify: true,
        },

        product: {
          type: Object,
          notify: true,
        },
        addImages: {
          type: Array,
          notify: true,
        },
        images: {
          type: Array,
          notify: true,
        },
        user: {
          type: Object,
          notify: true
        },

        actionFabIcon: {
          notify: true,
          // value: 'shopping-cart'
        },

        editImages: {
          type: Boolean,
          notify: true,
        },

        _edit: {
          type: Object,
          notify: true
        },

        edit: {
          type: Boolean,
          notify: true,
          value: false
        },

        imageSelected: {
          type: Number,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
          value: []
        },


        loading: {
          type: Boolean,
          notify: true,
        },

      },
      observers: [
        '_updateCartIcon(cart, product)',
        '_computePageTitle(product)',
        '_computeNewProduct(byId)',
        '_computeReset(byId)',
      ],



      _computeReset: function(byId) {
        // console.log(this.$$('.image-list').scrollLeft);
        if (byId !== _lastNavigated && this.router) {
          _lastNavigated = byId;
          this.debounce('_computeResetFFFF', function() {
            this.$$('.image-list').scrollLeft = 0;
          }, 0);
        }
      },

      _actionFabIcon: function(user, edit) {
        if (user.isAdmin && edit) {
          return 'save';
        } else if (user.isAdmin && !edit) {
          return 'editor:mode-edit';
        } else if (!user.isAdmin) {
          return 'shopping-cart';
        }
      },

      ready: function() {
        // console.log(_images);
        // this.images = _images;
      },

      dettached: function() {
        console.log('detached page-product');
        console.dir(this.edit);
      },

      _tapAddOption: function() {
        // console.log('new option');
        this.$.catalogProduct.newOption();
      },

      _tapRemoveOption: function(item) {
        // console.log('tap remove option: ', item);
        // console.log(item.model.__data__.index);
        // console.log(this.product.options[item.model.__data__.index] = null);
        this.$.catalogProduct.removeOption(item.model.__data__.item);
      },

      _tapAddTag: function() {
        // console.log('new option');
        this.$.catalogProduct.newTag();
      },

      _tapRemoveTag: function(item) {
        // console.log('tap remove option: ', item);
        this.$.catalogProduct.removeTag(item.model.__data__.item);
      },


      _actionFabTap: function(e, _) {
        e.stopPropagation();
        // console.log('fire: add-to-cart');
        if (!this.user.isAdmin) {
          this.fire('add-to-cart', {
            product: this.product
          });
          // this.$.catalogCart.addCart(this.product);
          this.inCart = true;
          return;
        }
        this.set('edit', !this.edit);
        return;
      },

      _computeNewProduct: function(byId) {
        // console.log(this._product.categories[0]);
        // this.product = this._product;
        if (byId === 'new') {
          // Add one
          key = this.$.catalogProduct.new();
          // console.log(key);
          this.debounce('_computeNewProductDebounce', function(argument) {
            // this.fire('nav', {
            //   path: '/product/' + key,
            //   replace: true
            // });
            // var path = "/product/" + key + "&edit=true";
            // history.replaceState(key, null, path);
            this.router.go("/products/" + key, {
              replace: true
            });
            // window.location.search = path;
            this.edit = true;
            this.byId = key;
          }, 90);

        }

      },

      _computeImageCountText: function(product) {
        // console.log(product.images);
        if (product.images) {
          if (product.images.length > 1) {
            return product.images.length + " Images";
          }
          return product.images.length + " Image";
        }
        return 'None, add some!';

      },


      // page

      _computePageTitle: function(product) {
        // console.log(product.images);
        // console.log(Date.now(), product.options);
        if (!product) {
          return;
        }
        if (this.byId) {
          this.pageTitle = this.product.title;
          return;
        }
        this.pageTitle = 'No Product Found';
      },

      // Product

      _computePrice: function(price) {
        return '$' + Number(price).toFixed(2);
      },

      // Cart

      _updateCartIcon: function(cart, product) {
        // console.log(product);
        for (var i = 0; i < cart.length; i++) {
          // console.log(cart[i].__firebaseKey__ === product.__firebaseKey__);
          if (cart[i].__firebaseKey__ === product.__firebaseKey__) {
            this.inCart = true;
            // return true;
          }
        }
      },

      // Favorites

      _favTap: function(e) {
        e.stopPropagation();
        // console.log('add-to-fav', e);
        if (this.user.isAdmin) return;
        this.fire('add-to-fav', {
          product: this.product
        });
        // this.user.addFav(this.product);
      },

      _favLocation: function(user, product) {
        if (user.uid) {
          return 'https://charlesiescom.firebaseio.com/users/' + user.uid + '/favorites/' + product.__firebaseKey__;
        }
      },

      _updateFavIcon: function(e, ref) {
        // console.log('fav');
        if (ref.val()) {
          this.inFav = true;
        } else {
          this.inFav = false;
        }
      },


      // Picker
      // Instagram
      _instagramMediaSelected: function(_, e) {
        // console.log(e);
        this.$.catalogProduct.addImageInstagram(e);
      },

      _openPicker: function(e) {
        // console.log(picker);
        // console.log(picker);
        // if (!picker) {
        //   this.fire('toast', {
        //     text: 'have to be admin to add images'
        //   });
        //   return;
        // }
        // picker.setVisible(true);
        this.$.instagramPicker.open();
      },





      // END SCRIPT

    });
  </script>
</dom-module>
