<dom-module id="page-product">
  <template>
    <style media="screen" is="custom-style">
      :host {
        display: block;
        margin-bottom: 88px;
      }

      .editFab {
        position: fixed;
        bottom: 16px;
        right: 16px;
        color: #fff;
        /* Firefox */
        -moz-transition: all 10s ease-in;
        /* WebKit */
        -webkit-transition: all 10s ease-in;
        /* Opera */
        -o-transition: all 10s ease-in;
        /* Standard */
        transition: all 10s ease-in;
        z-index: 1;
      }

      [edit].editFab {
        /*color: green;*/
        background-color: var(--google-green-500);
      }

      paper-material {
        background-color: white;
        overflow: hidden;
      }

      paper-toolbar {
        --paper-toolbar-background: white;
        overflow: hidden;
      }

      paper-material[wide] {
        margin: 16px auto;
        width: 480px;
      }

      .body {
        padding: 16px;
      }

      .small-body {
        padding: 8px;
      }

      .fullwidth {
        width: 100%;
      }

      .headerIcon {
        position: absolute;
        width: 80px;
        height: 80px;
        right: -38px;
        bottom: -14px;
        color: rgba(0, 0, 0, 0.05);
        transform: rotateY( 180deg);
      }

      .section {
        margin-bottom: 24px;
        /*border-bottom: 1px solid red;*/
      }

      .sectionHeader {
        margin-bottom: 8px;
        height: 56px;
        /*padding: 16px;*/
        /*box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 1.16);*/
      }

      .sectionHeader .title {
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 20px;
        font-weight: 500;
        line-height: 54px;
      }
      /*  View Product  */

      [in-fav] {
        color: #f44336;
      }

      [in-cart] {
        color: #f44336;
      }

      .inCart,
      .inFav {
        transition: color 0.2s cubic-bezier(.02, .82, 1, .33);
      }

      .productPrice {
        float: right;
        display: inline-block;
        position: relative;
        padding: 8px;
        margin: 0;
        outline: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .margin-right-16 {
        margin-right: 16px;
      }

      .margin-bottom-8 {
        margin-bottom: 8px;
      }
      /*  Product Images  */

      #images {
        margin: 16px auto;
      }

      [wide] {}

      #images .iron-selected {}

      .image-container {}

      .image-list {
        height: 100%;
        overflow-x: scroll;
      }

      .image {
        min-width: 200px;
        height: 200px;
        margin-right: 16px;
      }

      .imagePlaceholder {
        position: relative;
        height: 200px;
      }

      .imagePlaceholder .placeholderBg {
        color: rgba(0, 0, 0, 0.05);
        /*position: absolute;*/
        width: 148px;
        height: 148px;
      }

      .thumb.add {
        --paper-icon-button: {
          color: green;
        }
      }
      /*  Card Actions  */

      .card-actions {
        line-height: 40px;
      }

      .card-actions[admin] .value {
        width: 35px;
      }
      /*  Product Options  */

      .productOptionLabelDefaultValue {
        margin-top: 30px;
        width: 100px;
      }

      .productOptionPriceValue {
        width: 72px;
      }

      .productOptionPriceDefaultValue {
        width: 72px;
      }
      /*  Product Tags  */

      .tags .label {
        width: 45px;
      }
      /*  Product Status  */

      .productStatus {
        line-height: 1px;
      }

      .productStatusSelector {
        width: 128px;
        height: 24px;
      }
    </style>

    <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>
    <catalog-product id="catalogProduct" by-id="{{byId}}" data="{{product}}" edit="{{_edit}}"></catalog-product>
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>
    <google-client-loader id="driveApi" name="drive" version="v2" on-google-api-loadx="driveApiLoaded"></google-client-loader>

    <template is="dom-if" if="{{user.isAdmin}}">
      <paper-fab class="editFab" icon="{{editFab_icon}}" on-tap="_toggleEditMode" edit$="{{edit}}"></paper-fab>
    </template>

    <form is="iron-form" class="productForm" action="index.html" method="post" hidden="{{!byId}}">

      <paper-toolbar>
        <div class="paper-font-title" hidden="{{edit}}">[[pageTitle]]</div>
        <template is="dom-if" if="{{edit}}">
          <paper-input class="editTitleValue fullwidth" value="{{_edit.title::input}}" label="Title" type="text">
          </paper-input>
        </template>
        <span class="flex"></span>
        <!-- <iron-icon class="headerIcon" icon="maps:local-shipping"></iron-icon> -->
      </paper-toolbar>




      <paper-material id="images" wide$="{{wide}}" elevation="0">

        <template is="dom-if" if="{{edit}}">
          <paper-toolbar class="">
            <div class="paper-font-title">[[_computeImageCountText(product)]]</div>
            <span class="flex"></span>
            <paper-icon-button class="editImagesButton" icon="add" on-tap="_openPicker"></paper-icon-button>
            <!-- <paper-icon-button class="editImagesButton" icon="editor:mode-edit" on-tap="_editImages"></paper-icon-button> -->
          </paper-toolbar>
        </template>

        <!-- <template is="dom-if" if="{{product.images}}"> -->
        <div class="image-container body">
          <div class="image-list">
            <iron-selector attr-for-selected="item" selected="{{imageSelected}}" class=" layout horizontal">

              <template is="dom-if" if="{{!product.images.length}}">
                <div class="imagePlaceholder fullwidth layout horizontal center-center">

                  <iron-icon class="placeholderBg" icon="image:collections" hidden="{{!edit}}"></iron-icon>

                  <div class="fit layout horizontal center-center">
                    <template is="dom-if" if="{{edit}}">
                      <h2>Add Image
                        <paper-icon-button icon="add" on-tap="_openPicker"></paper-icon-button>
                      </h2>
                    </template>
                  </div>

                </div>
              </template>

              <template is="dom-repeat" items="{{product.images}}">
                <div>
                  <iron-image class="image" src="{{item.webContentLink}}" sizing="cover"></iron-image>
                </div>
              </template>
            </iron-selector>
          </div>
        </div>
        <!-- </template> -->

        <!-- <template is="dom-if" if="{{!product.images.length}}">
          <div class="imagePlaceholder layout horizontal center-center">
            <template is="dom-if" if="{{product.images}}}">
              <iron-icon class="placeholderBg" icon="image:collections" hidden="{{!edit}}"></iron-icon>
            </template>

            <div class="">
              <template is="dom-if" if="{{edit}}">
                <h2>Add Image
                  <paper-icon-button icon="add" on-tap="_openPicker"></paper-icon-button>
                </h2>
              </template>
            </div>

          </div>
        </template> -->
      </paper-material>


      <paper-material id="details" wide$="{{wide}}" elevation="0">
        <div class="layout vertical center-center body">

          <!-- Card Actions: If not loggedin -->

          <template is="dom-if" if="{{!edit}}">
            <div class="card-actions layout horizontal">
              <paper-icon-button class="inFav" icon="favorite" on-tap="_favTap" in-fav$="[[inFav]]" disabled$="[[!loggedin]]"></paper-icon-button>
              <paper-icon-button class="inCart" icon="shopping-cart" on-tap="_cartTap" in-cart$="[[inCart]]"></paper-icon-button>
              <template is="dom-if" if="{{!user.isAdmin}}">
                <h4 class="productPrice">
                  <span class="red">[[_computePrice(product.price)]]</span>
                </h4>
              </template>
            </div>
          </template>

          <!-- Card Actions: If Admin -->

          <template is="dom-if" if="{{edit}}">
            <div class="card-actions admin section layout horizontal">

              <div class="layout horizontal margin-right-16">
                <paper-icon-button class="productFavorites" icon="favorite" in-fav></paper-icon-button>
                <div>100k</div>
              </div>

              <div class="layout horizontal margin-right-16">
                <paper-icon-button class="productOrders" icon="shopping-cart" in-cart></paper-icon-button>
                <div>100k</div>
              </div>

            </div>
          </template>


          <!-- Product Name -->
          <!-- <div class="paper-font-title section fullwidth">Name of product</div> -->

          <div class="section paper-font-body1 fullwidth layout vertical">
            <div class="sectionHeader fullwidth">
              <div class="title">
                Description
              </div>
            </div>
            <!-- Product Description -->
            <div hidden="{{edit}}">
              <span>{{product.description}}</span>
            </div>
            <template is="dom-if" if="{{edit}}">
              <!-- <paper-input class="editTitleValue fullwidth" value="{{_edit.title::input}}" label="Title" type="text">
              </paper-input> -->

              <!-- Product Description -->
              <paper-textarea class="fullwidth" label="description" rows="1" max-rows="2" value="{{_edit.description}}"></paper-textarea>
            </template>
          </div>


          <!-- Product Price -->

          <div class="section editPrice fullwidth">

            <div class="sectionHeader fullwidth layout horizontal">
              <div class="title">
                Options
              </div>
              <span class="flex"></span>
              <template is="dom-if" if="{{edit}}">
                <paper-button class="addTagsButton" in-fav on-tap="_tapAddOption">Add Option
                  <iron-icon icon="add"></iron-icon>
                </paper-button>
              </template>
            </div>

            <div class="productOptions layout vertical">
              <!-- Options List -->

              <!-- <template is="dom-repeat" items="[[product.options]]">
                <div class="layout horizontal fullwidth">
                  <div>[[item.title]]</div>
                  <div>[[item.price]]</div>
                </div>
              </template> -->

              <template is="dom-repeat" items="{{product.options}}">
                <div class="layout horizontal fullwidth" hidden="{{edit}}">
                  <div class="flex margin-right-16">[[item.title]]</div>
                  <div class="">[[item.price]]</div>
                </div>
              </template>

              <!-- Admin -->
              <template is="dom-if" if="{{edit}}">

                <div class="fullwidth layout horizontal">
                  <div class="productOptionLabelDefaultValue layout start margin-right-16">
                    Default:
                  </div>

                  <span class="flex"></span>

                  <paper-input class="productOptionPriceDefaultValue layout end" value="{{_edit.price::change}}" label="price" type="number">
                    <div prefix>$</div>
                  </paper-input>
                </div>


                <template is="dom-repeat" items="{{product.options}}">
                  <div class="fullwidth layout horizontal">
                    <paper-input class="productOptionLabelValue margin-right-16" value="{{item.label::change}}" label="Option Label" type="text">
                    </paper-input>
                    <span class="flex"></span>
                    <paper-input class="productOptionPriceValue" valuex="{{item.price}}" value="{{item.price::change}}" label="price" type="number">
                      <div prefix>$</div>
                    </paper-input>
                  </div>
                </template>

              </template>


            </div>

          </div>


          <!-- Product Tags -->
          <template is="dom-if" if="{{edit}}">
            <div class="section productTags fullwidth layout">
              <div class="sectionHeader layout horizontal">
                <div class="title">
                  Tags
                </div>

                <span class="flex"></span>

                <paper-menu-button vertical-align="top" horizontal-align="right">
                  <paper-button class="dropdown-trigger addTagsButton" in-fav>
                    <iron-icon icon="add"></iron-icon>Add Tag</paper-button>
                  <paper-menu class="dropdown-content">
                    <paper-item>Unpublished</paper-item>
                    <paper-item>Active</paper-item>
                    <paper-item>Sold Out</paper-item>
                    <paper-item>Pre-Order</paper-item>
                  </paper-menu>
                </paper-menu-button>
              </div>

              <template is="dom-if" if="{{edit}}">
                <template is="dom-repeat" items="[[product.tags]]">
                  <paper-chip animated removable on-remove="_removeTag">
                    <h1>[[item.title]]</h1>
                  </paper-chip>
                </template>
              </template>


              <template is="dom-if" if="{{!user.isAdmin}}">
                <div class="layout horizontal wrap">
                  <template is="dom-repeat" items="[[product.tags]]">
                    <a href="" class="margin-right-16">
                    r Parker
                  </a>
                  </template>
                </div>
              </template>


            </div>
          </template>

          <!-- Product Status -->
          <template is="dom-if" if="{{edit}}">

            <div class="section fullwidth productStatus">
              <div class="sectionHeader layout horizontal">
                <div class="title">
                  Status
                </div>
                <span class="flex"></span>
                <paper-dropdown-menu class="productStatusSelector layout end" noLabelFloat="true">
                  <paper-menu class="dropdown-content" selected="{{_edit.status}}">
                    <paper-item>Unpublished</paper-item>
                    <paper-item>Active</paper-item>
                    <paper-item>Sold Out</paper-item>
                    <paper-item>Pre-Order</paper-item>
                  </paper-menu>
                </paper-dropdown-menu>
              </div>
            </div>

          </template>

        </div>

      </paper-material>

    </form>
    <script type="text/javascript" src="//apis.google.com/js/api.js?onload=onApiLoad" async></script>
  </template>


  <script>
    var picker, pickerReady, thiss;

    function onApiLoad() {
      // console.log('apiload');
      gapi.load('picker', {
        'callback': function(argument) {
          pickerReady = true;
        }
      });
    }

    function setupPicker(cb, developerKey, accessToken) {
      if (!pickerReady) return;
      var supportedMimeType = "image/png,image/jpeg,image/jpg";

      var view1 = new google.picker.DocsView();
      view1.setMimeTypes(supportedMimeType);
      view1.setLabel("Image Files");

      var view3 = new google.picker.View(google.picker.ViewId.PHOTOS);
      view3.setLabel("Photos");

      var view2 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);
      view2.setLabel("Recently Selected");

      picker = new google.picker.PickerBuilder().
      addView(view1).
      addView(view3).
      addView(view2).
        // enableFeature(google.picker.Feature.NAV_HIDDEN).
      enableFeature(google.picker.Feature.MULTISELECT_ENABLED).
      setOAuthToken(accessToken).
      setDeveloperKey(developerKey).
      setCallback(cb).
      build();

    }
    // Google Drive API Const
    // var developerKey = 'AIzaSyAkeEajTtdn1qGL-UKCEq5uJNiRziLY3X4';
    var developerKey = 'AIzaSyB2x_CG22tc1yosAWKz5hOfx6g6CF8d0Gw';

    // Utils
    var decimalOnly = /^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;

    Polymer({
      is: 'page-product',
      enableCustomStyleProperties: true,
      properties: {

        // page
        byId: {
          type: String,
          notify: true,
        },

        pageTitle: {
          type: String,
          notify: true,
        },

        product: {
          type: Object,
          notify: true,
        },
        addImages: {
          type: Array,
          notify: true,
        },
        images: {
          type: Array,
          notify: true,
        },
        user: {
          type: Object,
          notify: true
        },

        editFab_icon: {
          value: 'editor:mode-edit'
        },

        editImages: {
          type: Boolean,
          notify: true,
        },

        _edit: {
          type: Object,
          notify: true
        },

        edit: {
          type: Boolean,
          notify: true,
          // value: true
        },

        imageSelected: {
          type: Number,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
          value: []
        },

        // cart: Array,
        // inCart: {
        //   type: Boolean,
        //   value: false,
        //   notify: true,
        // },
        // inFav: {
        //   type: Boolean,
        //   value: false,
        //   notify: true,
        // },
        // _fav: {
        //   type: Object,
        //   notify: true
        // },
      },
      observers: [
        // '_updateCartIcon(cart, product)',
        '_computePageTitle(product)',
        // 'check(images.*)',
        '_computePicker(user)',
        '_computeNewProduct(byId)',
        // 'check(_edit.*)',
      ],

      check: function(check) {
        console.log('check', check.base);
        // this.set('_edit', check.base);
      },

      ready: function() {
        // console.log(_images);
        // this.images = _images;
      },

      _tapAddOption: function() {
        // console.log('new option');
        this.$.catalogProduct.newOption();
      },

      _toggleEditMode: function() {
        // console.log(_images);
        this.set('edit', !this.edit);
        if (this.edit) {
          this.set('editFab_icon', 'save');
        } else {
          this.set('editFab_icon', 'editor:mode-edit');
        }

      },

      _computeNewProduct: function(byId) {
        // console.log(byId);
        // console.log(this._product.categories[0]);
        // this.product = this._product;
        if (byId === 'new') {
          // Add one
          key = this.$.catalogProduct.new();
          this.fire('nav', {
            path: '/product/' + key,
            replace: true
          });
        }
      },

      _computeImageCountText: function(product) {
        // console.log(product.images);
        if (product.images) {
          return product.images.length;
        }
        return 'None';

      },


      // page

      _computePageTitle: function(product) {
        // console.log(product);
        if (this.byId) {
          this.pageTitle = this.product.title;
          return;
        }

        this.pageTitle = 'No Product Found';

      },

      // Product

      _computePrice: function(price) {
        return '$' + Number(price).toFixed(2);
      },

      // Cart

      _cartTap: function(e) {
        // e.stopPropagation();
        // console.log('fire: add-to-cart');
        this.fire('add-to-cart', {
          product: this.product
        });
        // this.$.catalogCart.addCart(this.product);
        this.inCart = true;
      },

      _updateCartIcon: function(cart, product) {
        // console.log(product);
        for (var i = 0; i < cart.length; i++) {
          // console.log(cart[i].__firebaseKey__ === product.__firebaseKey__);
          if (cart[i].__firebaseKey__ === product.__firebaseKey__) {
            this.inCart = true;
            // return true;
          }
        }
      },

      // Favorites

      _favTap: function(e) {
        e.stopPropagation();
        // console.log('add-to-fav', e);
        this.fire('add-to-fav', {
          product: this.product
        });
        // this.user.addFav(this.product);
      },

      _favLocation: function(user, product) {
        if (user.uid) {
          return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/favorites/' + product.__firebaseKey__;
        }
      },

      _updateFavIcon: function(e, ref) {
        // console.log('fav');
        if (ref.val()) {
          this.inFav = true;
        } else {
          this.inFav = false;
        }
      },


      // Drive

      _getDriveFile: function(file) {
        // console.log(file.id);

        // console.dir(this.$.driveApi);
        var request = this.$.driveApi.api.files.get({
          'fileId': file.id,
          access_token: this.user.accessToken
            // 'api': developerKey
        });

        request.execute(function(resp) {
          // console.log(resp);
          thiss.$.catalogProduct.addImage(resp);
        });

      },


      // Picker

      _openPicker: function(e) {
        // console.log(picker);
        console.log(picker);
        if (!picker) {
          this.fire('toast', {
            text: 'have to be admin to add images'
          });
          return;
        }
        picker.setVisible(true);
      },


      google_api_load_error: function(argument) {
        console.error(e);
      },

      _computePicker: function(user) {
        if (!user) return;
        // console.log(user);
        // user.accessToken
        thiss = this;
        setupPicker(this._pickerCallback, developerKey, user.accessToken);
      },

      _pickerCallback: function(data) {

        var url = 'nothing';
        if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
          var docs = data[google.picker.Response.DOCUMENTS];
          // console.dir(data.docs);
          for (var i = 0; i < docs.length; i++) {
            thiss._getDriveFile(data.docs[i]);
            // data.docs[i].id
            // console.log('docs[i].id: ', docs[i]);
            // thiss.$.ajax.url = "https://www.googleapis.com/drive/v2/files/" + docs[i].id + "?key=AIzaSyAkeEajTtdn1qGL-UKCEq5uJNiRziLY3X4";
            // thiss.$.ajax.url = "http://localhost:8080/addPickerImages/?ac=" + thiss.user.accessToken;
            // thiss.$.ajax.body = docs;
            // thiss.$.ajax.generateRequest();
            // console.dir(thiss.$.ajax);

          }
        }
      },



      // END SCRIPT

    });
  </script>
</dom-module>
