<dom-module id="page-product">
  <template>
    <style media="screen" is="custom-style">
      :host {
        display: block;
        padding-bottom: 80px;
      }

      paper-material {
        background-color: white;
        overflow: hidden;
      }

      paper-toolbar {
        --paper-toolbar-background: white;
        overflow: hidden;
      }

      paper-material[wide] {
        margin: 16px auto;
        width: 480px;
      }

      .body {
        padding: 16px;
      }

      .small-body {
        padding: 8px;
      }

      .productTags {
        @apply(--paper-font-body1);
      }

      .fullwidth {
        width: 100%;
      }

      .headerIcon {
        position: absolute;
        width: 80px;
        height: 80px;
        right: -38px;
        bottom: -14px;
        color: rgba(0, 0, 0, 0.05);
        transform: rotateY( 180deg);
      }

      .section {
        margin-bottom: 24px;
        /*border-bottom: 1px solid red;*/
      }

      .sectionHeader {
        height: 56px;
        /*padding: 16px;*/
        /*box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 1.16);*/
      }

      .sectionHeader .title {
        font-size: 34px;
        font-weight: 400;
        letter-spacing: -.01em;
        line-height: 40px;
      }
      /*  View Product  */

      [in-fav] {
        color: #f44336;
      }

      [in-cart] {
        color: #f44336;
      }

      .inCart,
      .inFav {
        transition: color 0.2s cubic-bezier(.02, .82, 1, .33);
      }

      .productPrice {
        float: right;
        display: inline-block;
        position: relative;
        padding: 8px;
        outline: none;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .margin-right-16 {
        margin-right: 16px;
      }
      /*  Product Images  */

      #images {
        margin: 16px auto;
      }

      [wide] {}

      #images .iron-selected {}

      .image-container {}

      .image-list {
        height: 100%;
        overflow-x: scroll;
      }

      .image {
        width: 200px;
        height: 200px;
        margin-right: 16px;
      }

      .imagePlaceholder {
        height: 200px;
      }

      .imagePlaceholder .placeholderBg {}

      .thumb.add {
        --paper-icon-button: {
          color: green;
        }
      }
      /*  Card Actions  */

      .card-actions {
        line-height: 36px;
      }

      .card-actions[admin] .value {
        width: 35px;
      }
      /*  Product Options  */

      .productOptionLabelDefaultValue {
        margin-top: 30px;
        width: 100px;
      }

      .productOptionPriceValue {
        width: 72px;
      }

      .productOptionPriceDefaultValue {
        width: 72px;
      }
      /*  Product Tags  */

      .tags .label {
        width: 45px;
      }
      /*  Product Status  */

      .productStatus {
        line-height: 1px;
      }

      .productStatusSelector {
        width: 128px;
        height: 24px;
      }
    </style>

    <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>
    <catalog-product id="catalogProduct" byId="[[id]]" product="{{product}}" images="{{images}}" optionsx="{{optionsx}}" categoriesx="{{categoriesx}}"></catalog-product>
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>
    <!-- <iron-ajax id="ajax" url="http://localhost:8080/checkout" method="post" handle-as="json" on-response="_handleAddImagesResponse" on-error="_handleAddImagesError"></iron-ajax> -->
    <google-client-loader id="driveApi" name="drive" version="v2" on-google-api-loadx="driveApiLoaded"></google-client-loader>

    <paper-toolbar>
      <div class="paper-font-title">[[pageTitle]]</div>
      <span class="flex"></span>
      <iron-icon class="headerIcon" icon="maps:local-shipping"></iron-icon>
    </paper-toolbar>

    <form is="iron-form" class="productForm" action="index.html" method="post">

      <paper-material id="images" wide$="{{wide}}" elevation="0">
        <paper-toolbar>
          <div class="paper-font-title">(2)</div>
          <span class="flex"></span>
          <paper-icon-button class="editImagesButton" icon="editor:mode-edit" on-tap="_openPicker"></paper-icon-button>
          <paper-icon-button class="editImagesButton" icon="editor:mode-edit" on-tap="_editImages"></paper-icon-button>
        </paper-toolbar>

        <div class="image-container body">
          <div class="image-list">
            <iron-selector attr-for-selected="item" selected="{{imageSelected}}" class=" layout horizontal">
              <template is="dom-repeat" items="[[images]]">
                <div>
                  <iron-image class="image" src="[[item.webContentLink]]" sizing="cover"></iron-image>
                </div>
              </template>
            </iron-selector>
          </div>
        </div>

        <div class="imagePlaceholder layout horizontal center-center" hidden="{{images}}">
          <iron-icon class="placeholderBg" icon="image:collections"></iron-icon>

          <div class="margin-right-16">
            <h2>Add Image
              <paper-icon-button icon="add" on-tap="_openPicker">
              </paper-icon-button>
            </h2>
          </div>

        </div>
      </paper-material>


      <paper-material id="details" wide$="{{wide}}" elevation="0">
        <div class="layout vertical center-center body">

          <!-- Card Actions: If not loggedin -->

          <template is="dom-if" if="{{user.isAdmin}}">

            <div class="card-actions section layout horizontal">
              <paper-icon-button class="inFav" icon="favorite" on-tap="_favTap" in-fav$="[[inFav]]" disabled$="[[!loggedin]]"></paper-icon-button>
              <paper-icon-button class="inCart" icon="shopping-cart" on-tap="_cartTap" in-cart$="[[inCart]]"></paper-icon-button>
              <h4 class="productPrice">
                <span class="red">$990.99</span>
              </h4>
            </div>

          </template>

          <!-- Card Actions: If Admin -->

          <template is="dom-if" if="{{!user.isAdmin}}">
            <div class="card-actions admin section layout horizontal">

              <div class="layout horizontal margin-right-16">
                <paper-icon-button class="productFavorites" icon="favorite" in-fav></paper-icon-button>
                <div>100k</div>
              </div>

              <div class="layout horizontal margin-right-16">
                <paper-icon-button class="productOrders" icon="shopping-cart" in-cart></paper-icon-button>
                <div>100k</div>
              </div>

            </div>
          </template>


          <!-- Product Name -->
          <!-- <div class="paper-font-title section fullwidth">Name of product</div> -->

          <div class="section productTags fullwidth layout vertical">
            <div class="sectionHeader fullwidth">
              <div class="title">
                Description
              </div>
            </div>

            <paper-input class="editTitleValue fullwidth" value="{{product.title}}" valuex="Some Product Title" label="Title" type="text" hidden$="{{!edit}}">
            </paper-input>

            <!-- Product Description -->
            <paper-textarea hidden$="{{!edit}}" class="fullwidth " label="description" rows="2" max-rows="2" value="{{product.description}}" valuex="blah blah blahhhhhh blah blah "></paper-textarea>

          </div>


          <!-- Product Price -->

          <div class="section editPrice fullwidth">
            <div class="sectionHeader fullwidth layout horizontal">
              <div class="title">
                Options
              </div>

              <span class="flex"></span>

              <paper-button class="addTagsButton" in-fav>
                <iron-icon icon="add"></iron-icon>
                Add Option
              </paper-button>

            </div>

            <div class="productOptions layout vertical">

              <div class="fullwidth layout horizontal">
                <div class="productOptionLabelDefaultValue layout start margin-right-16">
                  Default:
                </div>

                <span class="flex"></span>

                <paper-input class="productOptionPriceDefaultValue layout end" valuex="{{product.price}}" value="999.99" label="price" type="number" hidden$="{{!edit}}">
                  <div prefix>$</div>
                </paper-input>
              </div>

              <div class="fullwidth layout horizontal">
                <paper-input class="productOptionLabelValue margin-right-16" valuex="{{productOption.label}}" value="Red w/stripes" label="Option Title" type="text" hidden$="{{!edit}}">
                </paper-input>

                <span class="flex"></span>

                <paper-input class="productOptionPriceValue" valuex="{{productOption.price}}" value="999.99" label="price" type="number" hidden$="{{!edit}}">
                  <div prefix>$</div>
                </paper-input>
              </div>

            </div>

          </div>


          <!-- Product Tags -->
          <div class="section productTags fullwidth layout">
            <div class="sectionHeader layout horizontal">

              <div class="title">
                Tags
              </div>

              <span class="flex"></span>

              <paper-menu-button class="layout end" vertical-align="top" horizontal-align="right">
                <paper-button class="dropdown-trigger" class="addTagsButton" in-fav>
                  <iron-icon icon="add"></iron-icon>Add Tag</paper-button>

                <paper-menu class="dropdown-content">
                  <paper-item>Unpublished</paper-item>
                  <paper-item>Active</paper-item>
                  <paper-item>Sold Out</paper-item>
                  <paper-item>Pre-Order</paper-item>
                </paper-menu>
              </paper-menu-button>

            </div>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
            <paper-chip animated removable on-remove="_removeTag">
              <h1>Peter Parker</h1>
            </paper-chip>
          </div>


          <!-- Product Status -->


          <div class="section fullwidth productStatus">
            <div class="sectionHeader layout horizontal">
              <div class="title">
                Status
              </div>
              <span class="flex"></span>
              <paper-dropdown-menu class="productStatusSelector layout end" noLabelFloat="true" selected-Item="{{status}}">
                <paper-menu class="dropdown-content">
                  <paper-item>Unpublished</paper-item>
                  <paper-item>Active</paper-item>
                  <paper-item>Sold Out</paper-item>
                  <paper-item>Pre-Order</paper-item>
                </paper-menu>
              </paper-dropdown-menu>
            </div>
          </div>
        </div>

        <div class="section buttons layout horizontal end-justified">
          <paper-button raised class="cancel_button" on-tap="cancel">Cancel</paper-button>
          <paper-button raised class="save_button" on-tap="_saveProduct">Done</paper-button>
        </div>
      </paper-material>




    </form>
    <script type="text/javascript" src="//apis.google.com/js/api.js?onload=onApiLoad" async></script>
  </template>


  <script>
    var picker, pickerReady, thiss;

    function onApiLoad() {
      // console.log('apiload');
      gapi.load('picker', {
        'callback': function(argument) {
          pickerReady = true;
        }
      });
    }

    function setupPicker(cb, developerKey, accessToken) {
      if (!pickerReady) return;
      var supportedMimeType = "image/png,image/jpeg,image/jpg";

      var view1 = new google.picker.DocsView();
      view1.setMimeTypes(supportedMimeType);
      view1.setLabel("Image Files");

      var view3 = new google.picker.View(google.picker.ViewId.PHOTOS);
      view3.setLabel("Photos");

      var view2 = new google.picker.View(google.picker.ViewId.RECENTLY_PICKED);
      view2.setLabel("Recently Selected");

      picker = new google.picker.PickerBuilder().
      addView(view1).
      addView(view3).
      addView(view2).
        // enableFeature(google.picker.Feature.NAV_HIDDEN).
      enableFeature(google.picker.Feature.MULTISELECT_ENABLED).
      setOAuthToken(accessToken).
      setDeveloperKey(developerKey).
      setCallback(cb).
      build();

    }

    // var developerKey = 'AIzaSyAkeEajTtdn1qGL-UKCEq5uJNiRziLY3X4';
    var developerKey = 'AIzaSyB2x_CG22tc1yosAWKz5hOfx6g6CF8d0Gw';


    var decimalOnly = /^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;

    _images = [{
      url: 'http://lorempixel.com/500/600/abstract'
    }, {
      url: 'http://lorempixel.com/700/700/abstract'
    }, {
      url: 'http://lorempixel.com/200/400/abstract'
    }, {
      url: 'http://lorempixel.com/100/400/abstract'
    }, {
      url: 'http://lorempixel.com/400/200/abstract'
    }, {
      url: 'http://lorempixel.com/800/400/abstract'
    }, {
      url: 'http://lorempixel.com/400/400/abstract'
    }, {
      url: 'http://lorempixel.com/600/400/abstract'
    }, {
      url: 'http://lorempixel.com/900/900/abstract'
    }, {
      url: 'http://lorempixel.com/590/900/abstract'
    }, {
      url: 'http://lorempixel.com/500/500/abstract'
    }, {
      url: 'http://lorempixel.com/600/600/abstract'
    }];

    Polymer({
      is: 'page-product',
      enableCustomStyleProperties: true,
      properties: {

        // page
        byId: {
          type: String,
          notify: true,
        },

        pageTitle: {
          type: String,
          notify: true,
          value: 'New Product'
        },

        product: {
          type: Object,
          notify: true,
        },
        addImages: {
          type: Array,
          notify: true,
        },
        images: {
          type: Array,
          notify: true,
        },
        user: {
          type: Object,
          notify: true
        },

        editImages: {
          type: Boolean,
          notify: true,
        },

        edit: {
          type: Boolean,
          notify: true,
          value: true
        },

        imageSelected: {
          type: Number,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
          value: []
        },

        // cart: Array,
        // inCart: {
        //   type: Boolean,
        //   value: false,
        //   notify: true,
        // },
        // inFav: {
        //   type: Boolean,
        //   value: false,
        //   notify: true,
        // },
        // _fav: {
        //   type: Object,
        //   notify: true
        // },
      },
      observers: [
        // '_updateCartIcon(cart, product)',
        '_computePageTitle(product)',
        // 'check(images.*)',
        '_computePicker(user)'
      ],

      ready: function() {
        // console.log(_images);
        // this.images = _images;
      },


      check: function(check) {
        console.log('check', check.base);
      },

      // page

      _computePageTitle: function(product) {
        console.log(product);
        if (this.id) {
          return 'Edit: ' + this.product.name;
        }
        return 'Add Product';

      },

      // Product

      // Cart

      _cartTap: function(e) {
        // e.stopPropagation();
        // console.log('fire: add-to-cart');
        this.fire('add-to-cart', {
          product: this.product
        });
        // this.$.catalogCart.addCart(this.product);
        this.inCart = true;
      },

      _updateCartIcon: function(cart, product) {
        // console.log(product);
        for (var i = 0; i < cart.length; i++) {
          // console.log(cart[i].__firebaseKey__ === product.__firebaseKey__);
          if (cart[i].__firebaseKey__ === product.__firebaseKey__) {
            this.inCart = true;
            // return true;
          }
        }
      },

      // Favorites

      _favTap: function(e) {
        e.stopPropagation();
        // console.log('add-to-fav', e);
        this.fire('add-to-fav', {
          product: this.product
        });
        // this.user.addFav(this.product);
      },

      _favLocation: function(user, product) {

        if (user.uid) {
          return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/favorites/' + product.__firebaseKey__;
        }
      },

      _updateFavIcon: function(e, ref) {
        // console.log('fav');
        if (ref.val()) {
          this.inFav = true;
        } else {
          this.inFav = false;
        }
      },


      // Drive

      _getDriveFile: function(file) {
        // console.log(file.id);

        // console.dir(this.$.driveApi);
        var request = this.$.driveApi.api.files.get({
          'fileId': file.id,
          access_token: this.user.accessToken
            // 'api': developerKey
        });

        request.execute(function(resp) {
          // console.log(resp);
          thiss.$.catalogProduct.addImage(resp);
        });

      },


      // Picker

      _openPicker: function(argument) {
        picker.setVisible(true);
      },


      google_api_load_error: function(argument) {
        console.error(e);
      },

      _computePicker: function(user) {
        if (!user) return;
        // console.log(user);
        // user.accessToken
        thiss = this;
        setupPicker(this._pickerCallback, developerKey, user.accessToken);
      },

      _pickerCallback: function(data) {

        var url = 'nothing';
        if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
          var docs = data[google.picker.Response.DOCUMENTS];
          // console.dir(data.docs);

          for (var i = 0; i < docs.length; i++) {

            thiss._getDriveFile(data.docs[i]);
            // data.docs[i].id
            // console.log('docs[i].id: ', docs[0]);
            // thiss.$.ajax.url = "https://www.googleapis.com/drive/v2/files/" + docs[i].id + "?key=AIzaSyAkeEajTtdn1qGL-UKCEq5uJNiRziLY3X4";
            // thiss.$.ajax.url = "http://localhost:8080/addPickerImages/?ac=" + thiss.user.accessToken;
            // thiss.$.ajax.body = docs;
            // thiss.$.ajax.generateRequest();
            // console.dir(thiss.$.ajax);

          }


        }
      },

      _handleAddImagesResponse: function(_, e) {

        console.log(this.$.ajax.lastResponse);
        // var data = this.$.ajax.lastResponse;

      },

      _handleAddImagesError: function(_, e) {
        this.fire('toast', {
          text: 'Error, Images not loaded'
        });

      }

      // END SCRIPT

    });
  </script>
</dom-module>
