<dom-module id="page-checkout">
  <template>

    <style is="custom-style" media="screen">
      :host {
        display: block;
      }

      .container {
        /*width: 100%;*/
      }

      .checkout-layout {
        /*display: block;*/
        background-color: white;
        margin: 16px;
        padding: 16px;
      }

      .section {
        margin-bottom: 16px;
      }

      .header {
        margin: 0;
        font-size: 16px;
      }

      .price_summary {
        margin: 24px 0;
      }

      .price_summary_header {
        margin-bottom: 16px;
        font-size: 24px;
      }

      .cart_total_text {
        color: var(--paper-green-a700);
        font-size: 20px;
      }

      .actions paper-button {
        width: 100%;
        margin-bottom: 16px;
      }

      .actions .step_left {
        background-color: white;
        color: #848484;
        --paper-button-ink-color: #f44336;
      }

      .actions .step_right {
        background-color: var(--paper-green-a700);
        color: white;
        --paper-button-ink-color: white;
      }

      .address-input,
      .field,
      .shipping_menu {
        width: 100%;
      }

      .cc_type {
        --iron-icon-height: 24px;
        --iron-icon-width: 38px;
      }
    </style>

    <catalog-cart id="catalogCart" items="{{cart}}" count={{count}}></catalog-cart>
    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{user}}" card="{{card}}" address="{{address}}"></catalog-user>
    <catalog-data id="catalogData" on-checkout-response="_handleCheckoutResponse"></catalog-data>

    <!-- <h2>Checkout</h2>
    <paper-slider disabledx id="checkoutSteps" pin snaps max="2" step="1" value="{{checkoutProgress}}"></paper-slider> -->

    <div class="container">

      <paper-material class="checkout-layout layout vertical">

        <iron-pages selected="{{checkoutProgress}}">
          <form class="checkout-form" is="iron-form" id="checkoutForm" method="post" action="/" on-iron-form-submit="_submitCheckoutForm">
            <div class="section">
              <h3 class="header">Pay With</h3>
              <paper-dropdown-menu label="Select Card" no-label-float required>
                <paper-menu id="selectedCardMenu" class="dropdown-content" selected="{{selectedCard}}">
                  <template is="dom-repeat" items="{{card}}">
                    <paper-item>
                      <paper-item-body>
                        <!-- <div>{{item.cc_end}}</div> -->
                        <div>
                          <iron-icon class="cc_type" src$="[[_computeTypeIcon(item.cc_type)]]"></iron-icon>
                          <span>{{item.cc_end}}</span>
                        </div>
                      </paper-item-body>
                    </paper-item>
                  </template>
                  <paper-item>Add New Card</paper-item>
                </paper-menu>
              </paper-dropdown-menu>
            </div>

            <div class="section">
              <h3 class="header">Ship to</h3>
              <paper-dropdown-menu label="Select Address" no-label-float class="field" required>
                <paper-menu id="selectedAddressMenu" class="dropdown-content" selected="{{selectedAddress}}">
                  <template is="dom-repeat" items="{{address}}">
                    <paper-item>
                      <paper-item-body>
                        <div label>
                          <span>{{_computeAddressFormatted(item)}}</span>
                        </div>
                      </paper-item-body>
                    </paper-item>
                  </template>
                  <paper-item>Add New Address</paper-item>
                </paper-menu>
              </paper-dropdown-menu>
            </div>

            <div class="price_summary layout vertical">

              <h3 class="price_summary_header">Price summary</h3>

              <div class="section layout horizontal">
                <div class="label">Subtotal</div>
                <span class="flex"></span>
                <div class="value">
                  <span>[[cartSubtotal]]</span>
                </div>
              </div>

              <!-- <div class="section layout horizontal">
            <div class="label">Tax</div>
            <span class="flex"></span>
            <div class="value">
              <span>[[cartSalesTax]]</span>
            </div>
          </div> -->

              <div class="section">
                <paper-dropdown-menu class="shipping_menu" label="Select Shipping Method" no-label-float>
                  <paper-menu id="selectedShippingOptionMenu" class="dropdown-content" selected="{{selectedShippingOption}}">
                    <template is="dom-repeat" items="{{shippingOptions}}">
                      <paper-item>
                        <span>{{item.label}}</span>
                      </paper-item>
                    </template>
                  </paper-menu>
                </paper-dropdown-menu>
              </div>

              <div class="section layout horizontal">
                <div class="label">Total</div>
                <span class="flex"></span>
                <div class="cart_total_text">
                  <span>[[cartTotal]]</span>
                </div>
              </div>

            </div>
          </form>


          <div class="confirm-dialog layout vertical center-center">
            <p>
              <strong>
                <span>[[count]]</span>
              </strong>
              <span> Items(s) totaling </span>
              <strong>
                <span>[[cartTotal]]</span>
              </strong>
              <br>
              <span> being shipped to </span>
              <br>
              <strong>
                <span>[[_computeSelectedAddressText(selectedAddress)]]</span>
              </strong>
              <br>
              <span> in </span>
              <strong>
                <span>[[_computeSelectedShippingOptionText(selectedShippingOption)]]</span>
              </strong>
              <br>
              <span>paid with this </span>
              <strong>
                <span>[[selectedCardText1]]</span>
              </strong>
              <span> ending in </span>
              <strong>
                <span>[[selectedCardText2]]</span>
              </strong>
            </p>
          </div>

          <div class="layout vertical center-center">



          </div>

          <div class="finished-dialog layout vertical center-center">
            <p>Thank the plug for purchase</p>
          </div>

        </iron-pages>

        <div class="actions section layout vertical center-center" hidden="{{submitting}}">
          <paper-button class="step_left" raised on-tap="_clickBack" hidden="{{hideBackButton}}">{{stepLeftText}}</paper-button>
          <paper-button class="step_right" autofocus on-tap="_clickNext">{{stepRightText}}</paper-button>
        </div>

      </paper-material>

    </div>

  </template>

  <script>
    (function() {

      var componentForm = {
        street_number: 'short_name',
        route: 'long_name',
        locality: 'long_name',
        administrative_area_level_1: 'short_name',
        country: 'long_name',
        postal_code: 'short_name'
      };

      Polymer({
        is: 'page-checkout',
        enableCustomStyleProperties: true,
        properties: {
          router: Object,

          cart: Array,

          cartTotalNumber: {
            type: String,
            notify: true,
            computed: '_computeCartTotalNumber(cart)'
          },

          cartTotal: {
            type: String,
            notify: true,
            computed: '_computeCartTotal(cartTotalNumber, selectedShippingOption)'
          },

          cartSubtotal: {
            type: String,
            notify: true,
            computed: '_computeCartSubtotal(cartTotalNumber)'
          },

          checkoutProgress: {
            type: Number,
            notify: true,
            value: 0
          },

          stepRightText: {
            type: String,
            notify: true,
            computed: '_computeRightText(checkoutProgress)'
          },

          stepLeftText: {
            type: String,
            notify: true,
            computed: '_computeLeftText(checkoutProgress)'
          },

          _user: {
            type: Object,
            notify: true,
          },

          user: {
            type: Object,
            notify: true,
            // computed: '_computeUser(loggedin, wait)'
          },

          card: {
            type: Array,
            notify: true,
          },

          address: {
            type: Array,
            notify: true,
          },

          selectedShippingOption: {
            type: Number,
            notify: true,
          },

          shippingOptions: {
            type: Array,
            notify: true,
            value: [{
              'label': 'Ground (3-5 business days) $0.00',
              'price': 00
            }, {
              'label': 'Two Day (2 business days) $13.99',
              'price': 13.99
            }, {
              'label': 'Next Day (1 business day) $20.99',
              'price': 20.99
            }]
          },

          hideBackButton: {
            type: Boolean,
            notify: true,
          },
          submitting: {
            type: Boolean,
            notify: true,
          },

          selectedCard: {
            type: String,
            notify: true,
          },

          selectedCardText1: {
            type: String,
            notify: true,
          },
          selectedCardText2: {
            type: String,
            notify: true,
          },

          selectedAddress: {
            type: String,
            notify: true,
          },

          selectedShipping: {
            type: Object,
            notify: true,
          },
          order: {
            type: Object,
            notify: true,
            computed: '_computeOrder(selectedAddress, selectedCard, selectedShippingOption)'
          },

        },

        observers: [
          '_cardChange(selectedCard)',
          '_addressChange(selectedAddress)',
          '_computeUser(loggedin, wait)'
        ],

        attached: function(argument) {
          this.selectedShippingOption = 0;
        },

        _computeSelectedShippingOptionText: function(selectedShippingOption) {
          if (selectedShippingOption === 0) {
            return "3-5 business days";
          } else if (selectedShippingOption === 1) {
            return "2 business days";
          } else if (selectedShippingOption === 2) {
            return "1 business day";
          }
        },

        _computeAddressFormatted: function(item) {
          // console.log(item.add_city + ', ' + item.add_state + ', ' + item.add_zip);
          return item.add_street + ', ' + item.add_city + ', ' + item.add_state + ', ' + item.add_zip;
        },

        _computeSelectedAddressText: function(num) {
          // console.log(item.add_city + ', ' + item.add_state + ', ' + item.add_zip);

          if (!this.address) {
            return;
          }

          if (!this.address[num]) {
            return;
          }

          var item = this.address[num];
          return item.add_street + ', ' + item.add_city + ', ' + item.add_state + ', ' + item.add_zip;
        },

        _computeTypeIcon: function(type) {
          return 'bower_components/gold-cc-input/images/' + type + '.png';
        },

        _cardChange: function(selectedCard) {
          // console.log(selectedCard);
          // console.log(this.$.selectedCardMenu.items.length-1);
          if (selectedCard === this.$.selectedCardMenu.items.length - 1) {
            // Show new card dialog
            this.fire('open-card-dialog');
            this.debounce('doSomething', function() {
              this.$.selectedCardMenu.selected = -1;
            }, 0);
          }

          if (typeof this.card[selectedCard] === 'object') {
            this.selectedCardText1 = this.card[selectedCard].cc_type;
            this.selectedCardText2 = this.card[selectedCard].cc_end;
          }

        },
        _addressChange: function(selectedAddress) {
          // console.log(selectedCard);
          // console.log(this.$.selectedAddressMenu.items.length-1);
          if (selectedAddress === this.$.selectedAddressMenu.items.length - 1) {
            // Show new card dialog
            this.fire('open-address-dialog');
            this.debounce('doSomething', function() {
              this.$.selectedAddressMenu.selected = -1;
            }, 0);

            return;
          }
        },

        _computeCartTotalNumber: function(cart) {
          if (cart.length) {
            var total = 0;
            for (var i = 0; i < cart.length; i++) {
              total += cart[i].default_price * cart[i].quantity;
            }
            return Number(total).toFixed(2);
          }
          return Number(0).toFixed(2);
        },

        _computeCartSubtotal: function(cartTotalNumber) {
          return String('$' + cartTotalNumber);
        },

        _computeCartTotal: function(cartTotalNumber, selectedShippingOption) {
          // console.log(cart);

          // console.log(this.shippingOptions[selectedShippingOption]);

          var absShipping = Number(this.shippingOptions[selectedShippingOption].price);

          var absTotal = +cartTotalNumber + this.shippingOptions[selectedShippingOption].price;

          // console.log(+cartTotalNumber+ + absShipping);

          return String('$' + absTotal);

        },

        _computeUser: function(loggedin, wait) {
          if (wait) {
            // console.log('waiting for user');
            return;
          }
          if (loggedin) {
            // console.log('user found');
            // return this._user;
          }
          // console.log(this.user);

        },


        _submitCheckout: function() {
          // console.log(this.order);
          this.hideBackButton = true;
          this.$.catalogData.checkout(this.order);
        },

        _computeOrder: function(selectedAddress, selectedCard, selectedShippingOption) {
          var add = this.address[selectedAddress];
          var card = this.card[selectedCard];
          var ship = this.shippingOptions[selectedShippingOption];

          // console.log(JSON.stringify({address: add, card: card, shipping: ship}));
          return JSON.stringify({
            address: add,
            card: card,
            shipping: ship,
            cart: this.cart,
            total: this.cartTotalNumber,
            user: this.user
          });

        },

        _clickBack: function() {
          if (this.checkoutProgress === 0) {
            this.router.go('/cart');
            return;
          }
          this.checkoutProgress--;
        },

        _clickNext: function() {

          if (this.checkoutProgress === 0) {
            if (!this.$.checkoutForm.validate()) {
              this.fire('toast', {
                text: "checkout isn't complete, please try again"
              });
              console.error("checkout isn't complete, please try again");
              return;
            }
          }

          if (this.checkoutProgress === 1) {
            this._submitCheckout();
          }

          if (this.checkoutProgress === 3) {
            this.router.go('/');
            return;
          }

          this.checkoutProgress++;
        },

        _computeLeftText: function(checkoutProgress) {

          // console.log(checkoutProgress);

          if (checkoutProgress < 2) {
            this.hideBackButton = false;
            this.submitting = false;
            return 'Cancel';
          }
          if (checkoutProgress === 2) {
            this.hideBackButton = true;
            this.submitting = true;
            return 'FinishXXX';
          }
          if (checkoutProgress === 3) {
            this.hideBackButton = true;
            this.submitting = false;
            return 'Finish';
          }

          return 'Edit Cart';
        },

        _computeRightText: function(checkoutProgress) {

          if (checkoutProgress === 1) {
            return 'Confirm';
          }
          if (checkoutProgress === 2) {
            return 'Finish';
          }

          return 'Continue';
        },

        _handleCheckoutResponse: function(_, res) {
          console.log('_handleCheckoutResponse: ', res);

          if (res.err) {
            console.error(res.err);
            this.fire('toast', {
              text: res.err.message
            });
            this.hideBackButton = false;
            return;
          }

          var oRef = new Firebase('https://charlesiesbeta.firebaseio.com/orders');
          var oURef = new Firebase('https://charlesiesbeta.firebaseio.com/users/' + this.user.uid + '/orders');

          var newOrder = oRef.push(res);

          newOrder.child('user_id').set(this.user.uid);

          oURef.child(newOrder.key()).set(true);

          this.debounce('checkoutComplete', function() {
            // this.checkoutProgress++;
            this.checkoutProgress--;
          }, 100);


        },




        // END

      });
    })();
  </script>

</dom-module>
