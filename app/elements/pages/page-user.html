<dom-module id="page-user">
  <template>

    <style media="screen" is="custom-style">
      .login-form {
        background-color: white;
        width: 420px;
        margin: 32px auto;
        padding: 16px 16px 32px 16px;
      }

      .form-submit {
        width: 100%;
      }

      paper-button {
        transition: background-color 0.5s ease;
      }

      paper-button[disabled] {
        background: #a8a8a8 !important;
        color: black;
      }

      .blue {
        background: var(--paper-light-blue-500);
      }

      .red {
        background: var(--paper-red-500);
      }

      .blue2 {
        background: var(--paper-blue-700);
      }
    </style>
    <firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://charlesiesbeta.firebaseio.com" provider="{{provider}}" on-error="errorHandler" on-user-created="userSuccessHandler" on-password-changed="userSuccessHandler"
    on-password-reset="userSuccessHandler" on-user-removed="userSuccessHandler"></firebase-auth>

    <paper-material class="login-form layout vertical center-center" hidden="{{statusKnown}}">

      <h2 class="form-title">Login</h2>
      <br>

      <div class="layout vertical">
        <form is="iron-form" id="loginform" method="post">
          <paper-input no-label-float maxlength="25" required name="email" label="email" type="email" value="{{email}}" disabled$="{{wait}}"></paper-input>
          <paper-input no-label-float maxlength="25" required name="password" label="password" type="password" value="{{password}}" disabled$="{{wait}}"></paper-input>
          <br>
          <paper-button raised class="form-submit" on-click="loginClick" disabled$="{{wait}}">login</paper-button>
        </form>
        <br>
        <br>

        <div class="">
          <paper-button disabled$="{{wait}}" class="blue" on-tap="_loginFacebook">
            <iron-icon src="/images/facebook29.svg"></iron-icon>
          </paper-button>
          <paper-button disabled$="{{wait}}" class="red" on-tap="_loginGoogle">
            <iron-icon src="/images/google29.svg"></iron-icon>
          </paper-button>
          <paper-button disabled$="{{wait}}" class="blue2" on-tap="_loginTwitter">
            <iron-icon src="/images/twitter21.svg"></iron-icon>
          </paper-button>
        </div>
        <br>
        <paper-button on-click="forgotClick" disabled$="{{wait}}">forgot password?</paper-button>
      </div>


    </paper-material>






  </template>

  <script>
    (function() {
      Polymer({
        is: 'page-user',

        properties: {
          email: {
            type: String,
            notify: true,
            value: "cw@dlx.com"
          },
          password: {
            type: String,
            notify: true,
            value: "1234"
          },
          wait: {
            type: Boolean,
            notify: true,
            value: false
          },
          loggedIn: {
            type: Boolean,
            notify: true,
            value: false
          },
          user: {
            type: Object,
            notify: true,
            // observer: 'obUser'
          },
          statusKnown: {
            type: Boolean
          },
          provider: {
            type: String,
            value: 'password'
          },
        },

        observers: [
          'obUser(statusKnown)'
        ],

        _loginFacebook: function() {
          this.provider = 'facebook';
          this.login();
        },

        _loginGoogle: function() {
          this.provider = 'google';
          this.login();
        },
        _loginTwitter: function() {
          this.provider = 'twitter';
          this.login();
        },

        ready: function() {
          // var json = this.$.loginform.validate();
          // console.log(json);
        },

        obUser: function(statusKnown) {
          // console.log('statusKnown: ', statusKnown);
          if (statusKnown) {
            this.wait = true;
          }
        },
        initializeDefaultValue: function(ev) {
          // console.log("initializeTemplate");
          return {};
        },

        computeLoginJson: function(email, password) {
          return JSON.stringify({
            email: email,
            password: password
          });
        },

        loginClick: function(e) {
          // console.log(e);
          // console.log(this.email);
          // console.log(this.user);
          if (!this.email || !this.password) {
            this.$.toast.text = "no email or password entered";
            this.$.toast.show();
            return;
          }

          this.wait = true;
          that = this;
          setTimeout(function() {
            that.$.req.generateRequest();
          }, 400);
          // this.$.loginform.submit();

        },

        loginFormResponse: function(e, e2) {
          console.log(e, e2);
        },

        loginResponse: function(e, req) {
          // console.log(this.data);
          this.wait = false;
          if (this.data.error) {
            ctApp.toast(this.data.error.message);
            return;
          }
          this.user = this.data.user;
          ctApp.router.go('/');
        },

        oneerror: function(e) {
          this.wait = false;
          console.log('error : ', e);
        },


        ////////////////////////////////

        login: function() {
          var params;
          try {
            params = JSON.parse(this.params);
          } catch (e) {
            params = null;
          }
          if (this.provider == 'password') {
            params = params || {};
            params.email = this.email;
            params.password = this.password;
          }
          this.$.firebaseLogin.login(params);
          console.log('login: ', this.provider, params);
        },
        logout: function() {
          this.$.firebaseLogin.logout();
          console.log('logout!');
        },
        errorHandler: function(e) {
          this.fire('toast', {
            text: e.detail.message
          });
          console.log('error: ', e.detail.message);
        },
        userSuccessHandler: function(e) {
          this.fire('toast', {
            text: ' success!'
          });
          console.log('login success: ', this.user);  
        },
        createUserHandler: function(e) {
          this.$.firebaseLogin.createUser(this.email, this.password);
          this.fire('toast', {
            text: 'Thanks for joining Charlesies.com ' + this.email
          });
        },
        changePasswordHandler: function(e) {
          this.$.firebaseLogin.changePassword(this.email, this.password, this.newPassword);
          this.fire('toast', {
            text: 'Password for account ' + this.email + ' has been changed'
          });
        },
        resetPasswordHandler: function(e) {
          this.$.firebaseLogin.sendPasswordResetEmail(this.email);
          this.fire('toast', {
            text: 'Reset password requset sent to ' + this.email
          });
        },

        computeLoginStatus: function(statusKnown, user) {
          if (statusKnown && user) {
            return 'Logged in';
          }
          if (statusKnown) {
            return 'Logged out';
          }
          return 'Unknown (checking status...)';
        }


      });
    })();
  </script>

</dom-module>
