<dom-module id="page-new-card">
  <template>
    <style is="custom-style">
    :host {
      background-color: white;
      display: block;
      @apply(--layout-vertical);
      @apply(--layout-center);
      background: rgba(0, 0, 0, 0.7);
    }

    .new-card-dialog {
      padding: 16px;
      background-color: white;
      margin: 64px 16px 16px;
      width: 320px;
    }

    .new-card-form{
      margin-bottom: 32px;
    }

    .save_button {
      background-color: var(--paper-green-a700);
      color: white;
      --paper-button-ink-color: white;
    }
    </style>

    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{_user}}"></catalog-user>
    <firebase-collection id="fbCard" location$="[[_computeCardLoccation(user, loggedin)]]" data="{{card}}"></firebase-collection>

    <paper-material class="new-card-dialog">

      <h2>Add Card</h2>

      <form class="new-card-form" is="iron-form" id="newCardForm" method="post" action="/">

        <gold-cc-input id="cc_num" class="field" card-type="{{cc_type}}" value="{{cc_num}}" required auto-validate></gold-cc-input>

        <div class="layout horizontal">
          <gold-cc-cvc-input id="cc_cvc" card-type="[[cc_type]]" value="{{cc_cvc}}" required auto-validate></gold-cc-cvc-input>
          <span class="flex" style="margin-right:16px;"></span>
          <gold-cc-expiration-input id="cc_exp" value="{{cc_exp}}" required auto-validate></gold-cc-expiration-input>
        </div>

        <paper-input id="cc_name" label="Name on card" class="field" required value="{{cc_name}}" auto-validate></paper-input>
        <gold-zip-input id="cc_zip" value="{{cc_zip}}" required auto-validate></gold-zip-input>

      </form>


      <div class="buttons">
        <paper-button raised autofocus on-tap="cancel">Cancel</paper-button>
        <paper-button raised disabledx$="[[_validCardForm()]]" on-tap="_saveCard" class="save_button">Save</paper-button>
      </div>

    </paper-material>

  </template>
  <script>
    (function() {

      Polymer({
        is: 'page-new-card',
        enableCustomStyleProperties: true,
        properties: {

          _user: {
            type: Object,
            notify: true,
          },

          user: {
            type: Object,
            notify: true,
            computed: '_computeUser(loggedin, wait)'
          },

          newCard:{
            type: Object,
            notify: true,
            value: {}
          },

          cc_num: {
            type: String,
            notify: true,
          },
          cc_exp: {
            type: String,
            notify: true,
          },
          cc_cvc: {
            type: String,
            notify: true,
          },
          cc_name: {
            type: String,
            notify: true,
          },
          cc_zip: {
            type: String,
            notify: true,
          },

          cc_type: {
            type: String,
            notify: true,
          }

        },

        cancel: function function_name(argument) {
          this.cc_num = "";
          this.cc_exp = "";
          this.cc_cvc = "";
          this.cc_name = "";
          this.cc_zip = "";
          // console.log(window.location.pathname);
          // document.querySelector('app-router').go(window.location.pathname, {replace: true});
          window.history.back(-1);
        },

        _validCardForm:function (argument) {
          // console.dir(this.$.newCardForm.validate());
          return this.$.newCardForm.validate();
        },

        _saveCard: function() {
          // console.log(this.$.address);
          // console.log(!this.place.address_components);

          if (!this.$.newCardForm.validate()) {
            this.fire('toast', {
              text: 'Card form is not complete, please try again'
            });
            return;
          }

          // Add card components

          this.newCard.cc_num = this.cc_num;
          this.newCard.cc_exp = this.cc_exp ;
          this.newCard.cc_cvc = this.cc_cvc;
          this.newCard.cc_name = this.cc_name;
          this.newCard.cc_zip = this.cc_zip;
          this.newCard.cc_type = this.cc_type;
          this.newCard.cc_end = this.cc_num.slice(-5);


          // If logged in, add to database
          if (this.loggedin) {
            // console.log('loggedin, saved to db');
            var key = this.$.fbCard.add(this.newCard).key();
            this.fire('toast', {
              text: 'New card saved!'
            });
            // console.log(this.$.fbAddress.add(this.newAddress).key());
          }
          // If guest, add to guest address array
          if (typeof this.user.guest === 'object') {
            this.user.card.push(this.newCard);
          }
          // document.querySelector('app-router').go(window.location.pathname, {replace: true});
          // document.querySelector('app-router').go(window.location.pathname, {replace: true});
          this.cancel();
        },


        _computeUser: function(loggedin, wait) {
          if (wait) {
            // console.log('waiting for user');
            return;
          }
          if (loggedin) {
            // console.log('user found');
            return this._user;
          }
          // console.log('no user');
          return {
            guest: {
              address: []
            }
          };
        },

        _computeCardLoccation: function(user, loggedin) {
          // console.log(user.uid, loggedin);
          if (loggedin) {
            return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/cards';
          } else {
            console.log(user);
          }
        },

      });
    })();
  </script>


</dom-module>
