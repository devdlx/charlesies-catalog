<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/iron-component-page/iron-component-page.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../catalog-data/catalog-data.html">
<link rel="import" href="../catalog-category/catalog-category.html">
<link rel="import" href="../catalog-product/catalog-product.html">
<link rel="import" href="../package-symbol/package-symbol.html">
<link rel="import" href="../responsive-element/responsive-element.html">
<link rel="import" href="../theme-color/theme-color.html">
<link rel="import" href="../cart-icon/cart-icon.html">
<link rel="import" href="../cart-item-icon/cart-item-icon.html">
<link rel="import" href="../app-logo/app-logo.html">
<link rel="import" href="../app-bar/app-bar.html">
<link rel="import" href="../instagram-picker/instagram-picker.html">

<dom-module id="page-item">
  <template>
    <style is="custom-style">
      .spacer {
        @apply(--layout-flex);
      }

      paper-scroll-header-panel {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        /* background for toolbar when it is at its full size */
        /*background-image: url(media/bg4.jpg);*/
        --paper-scroll-header-panel-full-header: {
          background-color: var(--paper-light-blue-600);
        }
        ;
        /* background for toolbar when it is condensed */
        --paper-scroll-header-panel-condensed-header: {
          background-color: white;
        }
        ;
      }

      paper-toolbar {
        /* custom toolbar height */
        /*height: 300px;*/
        background-color: transparent;
        overflow: visible;
      }

      paper-icon-button {
        margin: 0 8px;
        /*--paper-icon-button-ink-color: white;*/
      }

      .bottom-text {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        font-size: 20px;
        padding-bottom: 10px;
      }

      .subtitle {
        padding-top: 4px;
        font-size: 16px;
        color: #ccc;
      }

      .fab {
        position: absolute;
        bottom: -24px;
        right: 20%;
        fill: #4285f4;
        height: 48px;
        width: 48px;
      }

      .indent {
        margin-left: 60px;
      }

      .content {
        @apply(--layout-vertical);
        @apply(--layout-center);
      }
      /*paper-scroll-header-panel /deep/ #mainContainer.paper-scroll-header-panel {
        margin-top: -200px;
        z-index: 1;
      }*/
      /*paper-scroll-header-panel /deep/ #headerContainer.paper-scroll-header-panel {
        z-index: 0;
      }*/

      paper-material {
        min-height: 1px;
        background-color: white;
        padding-bottom: 16px;
        margin-bottom: 10vh;
        margin-top: 24px;
        -webkit-transition: all 0.3s, -webkit-transform 0.3s, opacity 0.3s;
        transition: all 0.3s, transform 0.3s, opacity 0.3s;
        width: 288px;
      }

      .cartItemIcon {
        position: absolute;
        bottom: -24px;
        right: 24px;
        fill: #4285f4;
      }

      .bottom {}

      #media {
        position: relative;
        height: 288px;
        z-index: 0;
      }

      #mediaToolbar {
        @apply(--layout-fit);
      }

      #media .iron-selected {}

      .media-list {
        height: 100%;
        overflow-x: scroll;
        overflow-y: hidden;
        display: flex;
      }

      ::-webkit-scrollbar {
        -webkit-appearance: none;
        height: 4px;
      }

      ::-webkit-scrollbar-thumb {
        border-radius: 1px;
        background-color: #f44336;
        /*box-shadow: 0 0 1px rgba(255, 255, 255, .5);*/
      }

      .mediaPlaceholder {
        @apply(--layout-vertical);
        @apply(--layout-center);
        position: relative;
        /*height: 100%;*/
      }

      .mediaPlaceholder .placeholderBg {
        color: rgba(0, 0, 0, 0.05);
        width: 148px;
        height: 148px;
      }

      .media-container {
        -webkit-flex-direction: row;
        /* Safari */
        flex-direction: row;
        /*height: 288px;
        width: 288px;*/
      }

      iron-media,
      .media-container {
        /*--iron-media-height: 100%;*/
        height: 288px;
        width: 288px;
      }

      @media all and (min-width: 481px) {
        paper-material {
          width: 464px;
        }
        #media {
          height: 468px;
        }
        iron-image,
        .media-container {
          height: 464px;
          width: 464px;
        }
      }

      @media all and (min-width: 705px) {
        paper-material {
          width: 416px;
        }
        #media {
          height: 420px;
        }
        iron-image,
        .media-container {
          height: 416px;
          width: 416px;
        }
      }

      #item-title {
        line-height: 16px;
      }

      #item-header {
        position: relative;
      }

      #item-header .itemPrice {
        font-size: 20px;
        color: var(--paper-green-500);
      }

      #item-desc {}

      #item-desc p {
        margin: 0;
      }

      .body-item {
        /*margin-bottom: 4px;*/
        margin-left: 16px;
        margin-right: 16px;
        padding-bottom: 4px;
      }

      .body-item h4 {
        margin: 0;
        line-height: 40px;
      }

      .body-item [header-icon] {
        margin-top: 10px;
        margin-right: 4px;
      }

      .body-item [header-text] {}

      section {
        border-top: 1px solid #e5e5e5;
        padding-top: 16px;
        padding-bottom: 16px;
      }

      .optionLabelValue {
        margin-right: 8px;
      }

      .optionPriceValue {
        margin-right: 8px;
        width: 120px;
      }
    </style>

    <catalog-product id="catalogProduct" key="{{byId}}" data="{{item}}"></catalog-product>
    <catalog-category byshort="[[categoryByShort]]" data="{{category}}"></catalog-category>
    <catalog-user id="catalogUser" user="{{user}}" loggedin="{{loggedin}}"></catalog-user>
    <instagram-picker id="instagramPicker" token="{{user.instagram.authCode}}" on-media-selected="_instagramMediaSelected" open="{{pickerOpen}}">
    </instagram-picker>
    <paper-scroll-header-panel fixed admin$="[[user.admin]]">
      <paper-toolbar>
        <paper-icon-button icon="arrow-back"></paper-icon-button>
        <app-logo class="flex" tabindex="1" full="true"></app-logo>
        <div class="spacer"></div>

        <paper-menu-button vertical-align="top" horizontal-align="right">

          <template is="dom-if" if="[[!loggedin]]" restamp="true">
            <paper-icon-button icon="social:person" class="dropdown-trigger userIcon" alt="menu"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[loggedin]]" restamp="true">
            <paper-icon-button src="{{user.profileImageURL}}" class="dropdown-trigger userIcon" alt="menu"></paper-icon-button>
          </template>

          <paper-menu class="dropdown-content">
            <!-- <paper-item link="cart" on-tap="_tapNav" hidden$="{{narrow}}">
              <iron-icon icon="shopping-cart"></iron-icon>
              <span>{{cartCount}}</span>
            </paper-item> -->
            <paper-item hidden={{!loggedin}} link="account" on-tap="_tapNav">[[user.displayName]]</paper-item>
            <paper-item hidden={{!loggedin}} on-tap="_tapLogout">logout</paper-item>
            <paper-item hidden={{loggedin}} link="login" on-tap="_tapLogin">login</paper-item>
          </paper-menu>
        </paper-menu-button>
        <cart-icon id="cart-toggle"></cart-icon>
        <!-- <div class="bottom indent bottom-text" self-end>
          <div>[[item.label]]</div>
          <div class="subtitle">[[item.description]]</div>
        </div> -->
        <!-- <cart-item-icon class="bottom fab" id="cartItemIcon" item="[[item]]" view="paper-fab"></cart-item-icon> -->
      </paper-toolbar>

      <div class="content">

        <paper-material elevation="1">

          <div id="media" class="media-container">

            <template is="dom-if" if="[[user.isAdmin]]" restamp="true">
              <paper-toolbar id="mediaToolbar">
                <span class="flex"></span>
                <paper-icon-button icon="editor:mode-edit" on-tap="_tapEditMedia"></paper-icon-button>
              </paper-toolbar>
            </template>

            <div class="media-list layout horizontal center-center">

              <template is="dom-if" if="{{!item.mediaArray.length}}">
                <div class="mediaPlaceholder">
                  <iron-icon class="placeholderBg" icon="image:collections" hidden="{{edit}}"></iron-icon>
                  <!-- <div class="fit layout horizontal center-center">
                  <template is="dom-if" if="{{edit}}">
                    <h2>Add media
                      <paper-icon-button icon="add" on-tap="_openPicker"></paper-icon-button>
                    </h2>
                  </template>
                </div> -->
                </div>
              </template>

              <iron-selector attr-for-selected="item" selected="{{mediaelected}}" class=" layout horizontal">
                <template is="dom-repeat" items="{{item.media}}">
                  <div class="media-container">
                    <iron-image class="media" src="{{item.media.low_resolution.url}}" fade preload sizingx="cover"></iron-image>
                    <!-- <img class="media" src="{{item.src}}" height="100%" /> -->
                  </div>
                </template>
              </iron-selector>

            </div>
          </div>

          <template is="dom-if" if="[[!user.isAdmin]]" restamp="true">
            <cart-item-icon class="cartItemIcon" id="cartItemIcon" item="[[item]]" view="paper-fab"></cart-item-icon>
          </template>

          <section id="item-title" class="">
            <template is="dom-if" if="[[!user.isAdmin]]" restamp="true">
              <div class="body-item layout horizontal">
                <h2>[[item.label]]</h2>
                <span class="flex"></span>
                <h4 class="itemPrice">
                  <span>[[item.priceText]]</span>
                </h4>
              </div>
            </template>

            <template is="dom-if" if="[[user.isAdmin]]" restamp="true">
              <div class="body-item layout horizontal">
                <paper-input id="data-label" placeholder="Label" value="{{item.label::change}}" label="Name" style="width:100%"></paper-input>
              </div>
            </template>
          </section>

          <section id="item-desc">
            <div class="body-item">
              <template is="dom-if" if="[[item.description]]" restamp="true">
                <template is="dom-if" if="[[!user.isAdmin]]" restamp="true">
                  <p>[[item.description]]</p>
                </template>
              </template>
              <template is="dom-if" if="[[user.isAdmin]]" restamp="true">
                <paper-textarea id="data-description" label="Description" value="{{item.description::input}}" rows="1" max-rows="5"></paper-textarea>
              </template>
            </div>
          </section>


          <section id="item-options" class="shrinkable layout vertical">
            <div class="body-item layout horizontal">
              <h4>Options</h4>
              <span class="flex"></span>
              <paper-icon-button icon="menu" in-fav on-tap="_tapMenuOptions" hidden$="[[!user.isAdmin]]"></paper-icon-button>
            </div>
            <template is="dom-if" if="{{!user.isAdmin}}">
              <div class="meta">
                <template is="dom-repeat" items="[[item.optionsArray]]" as="option">
                  <paper-button id="optionButton" toggles>[[option.label]]</paper-button>
                </template>
              </div>
            </template>

            <template is="dom-if" if="{{user.isAdmin}}">
              <template is="dom-repeat" items="{{item.optionsArray}}" as="option">
                <div class="body-item layout horizontal">
                  <paper-input class="optionLabelValue" value="{{option.label::input}}" label="Label" type="text" always-float-label>
                  </paper-input>
                  <span class="flex"></span>
                  <paper-input class="optionPriceValue" value="{{option.price::input}}" label="Price" type="number" no-label-floatFFFF always-float-label>
                    <div prefix>$</div>
                  </paper-input>
                  <paper-icon-button on-tap="_tapRemoveOption" icon="clear" alt="clear" title="clear" style="margin-top: 20px;">
                  </paper-icon-button>
                </div>
              </template>

              <div class="layout horizontal body-item">
                <paper-input class="optionLabelValue" value="{{addOption.label}}" label="Label" type="text" always-float-label placeholderFFFF="New">
                </paper-input>
                <span class="flex"></span>
                <paper-input class="optionPriceValue" value="{{addOption.price}}" label="Price" type="number" no-label-floatFFFF always-float-label placeholder="0">
                  <div prefix>$</div>
                </paper-input>
                <paper-icon-button on-tap="_tapAddOption" icon="add" alt="add option" title="Add Option" style="margin-top: 20px;">
                </paper-icon-button>
              </div>

            </template>
          </section>


          <section id="item-tags" class="shrinkable layout vertical">
            <div class="body-item layout horizontal">
              <iron-icon header-icon icon="maps:local-offer" class=""></iron-icon>
              <h4 header-text>Tags</h4>
              <span class="flex"></span>
              <paper-icon-button icon="menu" in-fav on-tap="_tapMenuTags" hidden$="[[!user.isAdmin]]"></paper-icon-button>
            </div>


            <div class="body-item">
              <template is="dom-repeat" items="[[item.tagsArray]]" as="tag">

                <template is="dom-if" if="[[!user.isAdmin]]">
                  <a is="app-link" class="tag" href="[[_tagLink]]" active$="[[_tagActive(tag,view)]]">
                    <span>#[[tag.label]]</span>
                  </a>
                </template>

                <template is="dom-if" if="[[user.isAdmin]]">
                  <paper-button on-tap="_tapRemoveTag" alt="Remove Tag" title="Remove Tag">
                    <span>#[[tag.label]]</span>
                    <iron-icon icon="clear"></iron-icon>
                  </paper-button>
                </template>

              </template>
            </div>

            <template is="dom-if" if="[[user.isAdmin]]" restamp="true">

              <div class="layout horizontal body-item">
                <paper-input class="tagLabelValue" value="{{addTagLabel}}" placeholder="Add tag" type="text" no-label-float on-change="_addTagChange" style="width:100%">
                </paper-input>
              </div>

            </template>
          </section>





          <!-- Product Status -->
          <template is="dom-if" if="{{user.isAdmin}}">
            <section class="body-item">
              <paper-dropdown-menu class="productStatusSelector" label="Status" always-float-label>
                <paper-menu class="dropdown-content" selected="{{_edit.status}}">
                  <paper-item>Unpublished</paper-item>
                  <paper-item>Active</paper-item>
                  <paper-item>Sold Out</paper-item>
                  <paper-item>Pre-Order</paper-item>
                </paper-menu>
              </paper-dropdown-menu>
            </section>
          </template>

        </paper-material>

      </div>

    </paper-scroll-header-panel>

  </template>
</dom-module>

<script>
  // Utils
  var decimalOnly = /^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;
  Polymer({
    is: 'page-item',
    enableCustomStyleProperties: true,
    properties: {
      // page
      byId: {
        type: String,
        notify: true,
      },
      item: {
        type: Object
      },
      view: {
        type: String,
        value: 'docs'
      },
      active: {
        type: String,
        value: ''
      },
      pickerOpen: {
        type: Boolean,
        notify: true
      },
      docBehaviors: Array,
      docDemos: Array,
      docs: Object,
      categoryByShort: String,
      router: Object,
      q: String,
      narrowDrawer: Boolean,
      addTagLabel: {
        type: String,
        notify: true
      },
      addOption: {
        type: Object,
        notify: true,
        value: {}
      },
    },
    observers: [
      'updateMeta(item,active)',
      'viewUpdated(view)',
      'search(q)',
      '_updateStyles(category)',
      // '_check(addOption.*)',
    ],

    _tapLogin: function() {
      this.fire('nav', {
        url: "/account"
      });
    },

    _tapLogout: function() {
      this.$.catalogUser.logout();
    },

    _check: function(arg) {
      console.log('check(obj) ', arguments);
    },

    _tapEditMedia: function() {
      // console.log(this.pickerOpen);
      this.pickerOpen = !this.pickerOpen;


    },

    _addTagChange: function() {
      this.$.catalogProduct._addTag(this.addTagLabel)
        .then(function(err) {
          // console.log(err);
          this.addTagLabel = '';
        }.bind(this));
    },
    _tapRemoveTag: function(item) {
      // console.log('tap remove option: ', item);
      this.$.catalogProduct._removeTag(item.model.__data__.tag)
        .then(function(err) {
          // console.log(err);
        }.bind(this));
    },

    _tapAddOption: function(e) {
      this.$.catalogProduct._addOption(this.addOption)
        .then(function(err) {
          // console.log(err);
          this.addOption = {};
        });
    },
    _tapRemoveOption: function(item) {
      // console.log(item.model.__data__);
      this.$.catalogProduct._removeOption(item.model.__data__.option)
        .then(function(err) {
          // console.log(err);
        });
    },

    attached: function() {
      this.updateMeta();
    },
    _link: function(active, view) {
      return this.getURL(active, view);
    },
    _subLink: function(active, path) {
      return this.getURL(active, 'demo:' + path, true);
    },
    _subActive: function(path) {
      return this.view === 'demo:' + path;
    },
    _githubLink: function(source) {
      return 'https://github.com/' + source;
    },
    getURL: function(active, view, force) {
      var url = "/products/" + this.item.key;
      var qs = [];
      if (force || (view && view.length && view !== 'docs')) qs.push('view=' + view);
      if (force || (active && active.length && active !== this.element)) qs.push('active=' + active);
      if (qs.length) url += "?" + qs.join("&");
      return url;
    },
    updateMeta: function(item, active) {
      if (this.item) {
        // this.$.drawerPanel.closeDrawer();
        this.fire('page-meta', {
          // title: (this.active && this.active.length) ? this.active : this.item.label
          title: this.item.label
        });
      }
      // console.log(item);

    },
    viewUpdated: function() {
      // this.$.drawerPanel.closeDrawer();
    },
    _categoryLink: function() {
      return "/?category=" + this.category;
    },
    navToElement: function(e) {
      this.router.go("/elements/" + e.currentTarget.getAttribute('name'));
    },
    search: function(q) {
      if (q || this.q) {
        this.router.go('/?q=' + (q || this.q));
      }
    },
    cartAdd: function() {
      this.fire('cart-add', this.element);
    },
    _oneOrFewer: function(arr1, arr2) {
      if (!arr1 || arr1.length === 0) {
        return true;
      }
      if (!arr2) {
        return arr1.length <= 1;
      }
      return arr1.length + arr2.length <= 1;
    },

    _isEqual: function(a, b) {
      return a === b;
    },

    _handleError: function() {
      this.router.go('/404');
    },

    _updateStyles: function(category) {
      console.log(category);
      // this.async(this.$.componentPage.updateStyles, 2);
    },
  });
</script>
