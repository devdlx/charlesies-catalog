<dom-module id="page-product-list">
  <template>

    <style is="custom-style" media="screen">
      :host {
        display: block;
        padding-bottom: 96px;
      }

      .addFab {
        position: fixed;
        bottom: 16px;
        right: 16px;
        color: #fff;
        will-change: transform;
        transition: -webkit-transform .2s ease-in-out;
        transition: transform .2s ease-in-out;
      }

      .grid-container {
        padding: 16px;
      }

      .grid-layout {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
      }

      .grid-cell {
        margin-bottom: 16px;
        width: 100%;
      }


      .grid-cell[wide]{
        width: 446px;
      }

      @media all and (min-width: 481px) {
        .grid-container {
          /*-ms-flex-pack: center;
          -webkit-justify-content: center;
          justify-content: center;
          -ms-flex-direction: column;
          -webkit-flex-direction: column;
          flex-direction: column;
          -ms-flex-align: center;
           -webkit-align-items: center;
           align-items: center;
          display: -ms-flexbox;
          display: -webkit-flex;
          display: flex;*/
          @apply(--layout-vertical);
          @apply(--layout-center);
        }
        .grid-cell {
          margin: 8px;
          width: 214px;
        }
        .grid-layout {
          width: 460px;
        }
      }

      @media all and (min-width: 961px) and (orientation: landscape) {
        .grid-container {
          padding-left: 0;
          padding-right: 0;
        }
        .grid-layout {
          width: 690px;
        }
      }

      @media all and (min-width: 1281px) and (max-width: 1600px) {
        .grid-cell {
          margin: 8px;
          width: 214px;
        }
        .grid-layout {
          width: 920px;
        }
      }
    </style>

    <firebase-collection id="products" location="https://charlesiesbeta.firebaseio.com/products" data="{{products}}" order-by-child="[[_orderByChild]]" equal-to="[[category]]" limit-to-first="[[queryLimit]]" on-firebase-value="_computeProducts"></firebase-collection>
    <!-- <catalog-data products="[[products]]"></catalog-data> -->
    <!-- <iron-ajax id="firebaseProducts" params="{{_params()}}" url="https://charlesiesbeta.firebaseio.com/products.json" handle-as="json" loading="{{loading}}" last-response="{{_products}}" auto></iron-ajax> -->
    <catalog-user id="catalogUser" user="{{user}}"></catalog-user>

    <div id="grid" class="grid-container">

      <paper-spinner active="[[loading]]" hidden="{{!loading}}"></paper-spinner>

      <div class="grid-layout">

        <template is="dom-repeat" items="[[products]]">
          <product-card by-id="[[item.__firebaseKey__]]" class="grid-cell" wide$="{{item.wide}}"></product-card>
        </template>


        <template is="dom-if" if="[[!products.length]]">
          <div class="layout vertical center-center">
            <div>No products</div>
            <div>Create Product
              <paper-icon-button icon="add" on-tap="_navAddProduct"></paper-icon-button>
            </div>
          </div>
        </template>

        <template is="dom-if" if="{{user.isAdmin}}">
          <paper-fab class="addFab" icon="add" on-tap="_navAddProduct"></paper-fab>
        </template>

      </div>
    </div>

  </template>

  <script>
    (function() {

      Polymer({
        is: 'page-product-list',
        enableCustomStyleProperties: true,
        properties: {
          router: Object,
          loading: {
            type: Boolean,
            notify: true,
            value: true
          },
          // Query Parameters
          search: {
            type: String,
            notify: true,
            value: ''
          },
          category: {
            type: String,
            notify: true,
          },
          products: {
            type: Array,
          },
          tagList: {
            type: Array,
            computed: 'arrayParam(tag)',
            value: function() {
              return [];
            }
          },
          queryLimit: {
            type: Number,
            notify: true,
            // value: 12
          },
          _orderByChild: {
            type: String,
            notify: true,
            value: 'categoryByName'
          },

          _equalTo: {
            type: String,
            notify: true,
          }

        },
        observers: [
          // 'updateURL(q,package,tag,view,packageid)',
          // 'updateProducts(_products)',
          // 'updateMeta(packagename)'
        ],
        listeners: {
          'update-params': '_handleParamsUpdate',
          // 'page-fetch-more': '_fetchMore'
        },

        _computeProducts: function(_, e) {
          // console.log('_computeProducts: ', this.products[0].__firebaseKey__);
          this.loading = false;
        },

        _navAddProduct: function() {
          this.fire('nav', {
            path: '/product/new'
          });
        },

        _fetchMore: function(e) {
          this.queryLimit = this.queryLimit + 12;
        },

        attached: function() {
          // this.updateMeta();
          // this.updateSearch();
        },

        _params: function() {
          var p = {};
          p.orderBy = '\"priorty\"';
          p.limitToFirst = 8;
          // console.log(p);
          return p;
        },

        updateProducts: function(els) {

          // ________________________________________________________
          // object list to array
          // this.products = Object.keys(els).map(function(key) {
          //   return els[key];
          // });
          // els = null;
          // ________________________________________________________



          // ________________________________________________________
          // import products from bigcartel
          // var ref = new Firebase("https://charlesiesbeta.firebaseio.com/products");
          // for (var i = 0; i < els.length; i++) {
          //   ref.push(els[i]);
          // }
          // ________________________________________________________



          // ________________________________________________________
          // Image relations with products by key
          // var ref = new Firebase("https://charlesiesbeta.firebaseio.com/products");
          // ref.on('value', function(p) {
          // console.log(p.val());
          // var products = p.val();
          //
          // p.forEach(function(childSnapshot) {
          // key will be "fred" the first time and "barney" the second time
          // var key = childSnapshot.key();
          // childData will be the actual contents of the child
          // var childData = childSnapshot.val();
          // var images = childData.images;
          // console.log(childData.images[0].secure_url);
          // var imagesRef = new Firebase("https://charlesiesbeta.firebaseio.com/images");
          //   var out = {
          //     rel: key,
          //     images: []
          //   };
          //   for (var i = 0; i < images.length; i++) {
          //     out.images.push(images[i].secure_url);
          //   }
          //   // console.log(out);
          //   imagesRef.push(out);
          //
          // });

          // });

          // ________________________________________________________

        },


        _parseQueryString: function() {
          var query = window.location.search.substring(1);
          var params = query.split('&');
          var results = [];
          for (var i = 0; i < params.length; i++) {
            var pair = params[i].split('=');
            results[pair[0]] = pair[1];
          }
          return results;
        },
        _buildQueryString: function() {
          var out = [];
          if (this.q && this.q.length) out.push("q=" + this.q);
          if (this.tag && this.tag.length) out.push("tag=" + this.tag);
          // if (this.getPackage && this.getPackage.length) out.push("package=" + this.package);

          return out.join("&");
        },
        _handleParamsUpdate: function(_, params) {
          for (var key in params) {
            this[key] = params[key];
          }
        },

        updateSearch: function() {
          var params = this._parseQueryString();
          if (params && params.q) {
            this.async(function() {
              this.$.query.focus();
            });
          }
        },

        updateMeta: function(name) {
          console.log('updateMeta', name);

          // this.customStyle['--my-package-color'] = getPackage.color;
          // this.customStyle['--my-package-image'] = "url(" + getPackage.image + ")";
          // console.log(this.customStyle['--my-package-image']);
          // this.updateStyles();

        },

        arrayParam: function(param) {
          if (!param || !param.length) {
            return [];
          }
          return param.toString().split(',');
        },
        cartOpen: function(e) {
          this.fire('cart-open');
        },

        _detectIEVersion: function() {
          // via http://stackoverflow.com/questions/17907445/how-to-detect-ie11
          var rv = -1;
          var ua, re;
          if (navigator.appName === 'Microsoft Internet Explorer') {
            ua = navigator.userAgent;
            re = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) !== null)
              rv = parseFloat(RegExp.$1);
          } else if (navigator.appName === 'Netscape') {
            ua = navigator.userAgent;
            re = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) !== null)
              rv = parseFloat(RegExp.$1);
          }
          return rv;
        },

        _isEqual: function(a, b) {
          // console.log('_isEqual', a, b);
          return a === b;
        }
      });
    })();
  </script>

</dom-module>
