<dom-module id="page-card">
  <template>
    <style is="custom-style">
      :host {
        display: block;
        height: 100%;
      }

      paper-item {
        --paper-item: {
          cursor: default;
          padding: 8px;
          -webkit-box-shadow: 0px 0px 4px -2px rgba(0, 0, 0, 0.43);
          -moz-box-shadow: 0px 0px 4px -2px rgba(0, 0, 0, 0.43);
          box-shadow: 0px 0px 4px -2px rgba(0, 0, 0, 0.43);
        }
        --paper-item-focused-before: {
          background-color: white;
        }
      }

      .paper-font-title {
        @apply(--paper-font-title);
      }

      paper-material {
        min-width: 320px;
        background-color: white;
        overflow: hidden;
      }

      paper-material[wide] {
        margin: 16px;
        padding: 0;
      }

      paper-toolbar {
        --paper-toolbar-background: white;
      }

      .headerIcon {
        position: absolute;
        width: 64px;
        height: 100%;
        right: 6px;
        bottom: 0;
        color: rgba(0, 0, 0, 0.05);
        transform: rotateY( 180deg);
      }

      .line1 {
        font-size: 18px;
      }

      .dialog_backdrop {
        background-color: white;
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-center);
        background: rgba(0, 0, 0, 0.7);
      }

      form {
        margin-bottom: 32px;
      }

      .defaultBadge {
        background-color: var(--paper-red-500);
        @apply(--paper-font-caption);
        padding: 0 8px;
        color: white;
        margin-right: 16px;
      }

      .save_button {
        background-color: var(--paper-green-a700);
        color: white;
        --paper-button-ink-color: white;
      }

      .body {
        padding: 16px;
        margin: 0;
      }

      .addFab {
        position: fixed;
        bottom: 16px;
        right: 16px;
        color: #fff;
        will-change: transform;
        transition: -webkit-transform .2s ease-in-out;
        transition: transform .2s ease-in-out;
      }

      .margin-right-16 {
        margin-right: 16px;
      }

      .cc_type {
        height: 100%;
        width: 50px;
      }

      .cc_end {
        line-height: 31px;
      }
    </style>

    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{user}}" ></catalog-user>
    <!-- card="{{card}}" defaultCard="{{defaultCard}}" -->
    <firebase-document id="fbUserSettings" location$="{{_userSettingLocation(user)}}" on-firebase-value="_computeUserSetting" data="{{userSetting}}"></firebase-document>
    <!-- // Collection -->
    <!-- <firebase-collection id="fbUserCardList" location$="[[_computeCardLocation(user, loggedin)]]" data="{{_card}}" on-firebase-value="_computeCardList"></firebase-collection> -->
    <!-- // Single -->
    <firebase-document id="fbUserCard" location$="{{_cardLocation(user, byId)}}" on-firebase-value="_computeCardByID"></firebase-document>


    <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>

    <paper-toolbar>
      <div class="paper-font-title">[[_computePageTitle(selectedPage)]]</div>

      <span class="flex"></span>
      <iron-icon class="headerIcon" icon="icons:credit-card"></iron-icon>
    </paper-toolbar>

    <iron-pages selected="{{selectedPage}}">

      <paper-material class="card layout vertical center-center" wide$="{{wide}}">

        <paper-fab hidden="{{!user.isAdmin}}" class="addFab" icon="add" on-tap="_navAddCard"></paper-fab>

        <div style="padding:100px 100px;">
          No cards added
        </div>
        <template is="dom-if" if="{{!card}}">
          <div class="">
            No cards added
          </div>
        </template>

        <template is="dom-repeat" items="{{card}}">
          <paper-item on-tap="_navEditCard" default$="_computeDefault(item)" item="{{item}}">
            <paper-item-body>
              <div class="layout horizontal">
                <iron-icon class="cc_type margin-right-16" src$="[[_computeTypeIcon(item.cc_type)]]"></iron-icon>
                <div class="cc_end">{{item.cc_end}}</div>
              </div>
            </paper-item-body>
            <template is="dom-if" if="{{item.isDefault}}">
              <div class="defaultBadge">default</div>
            </template>
            <iron-icon icon="editor:mode-edit"></iron-icon>
          </paper-item>
        </template>
      </paper-material>


      <paper-material wide$="{{wide}}">

        <div class="body">
          <form class="edit-form" is="iron-form" id="newCardForm" method="post" action="/">

            <gold-cc-input id="cc_num" class="field" card-type="{{cc_type}}" value="{{cc_num}}" required auto-validate></gold-cc-input>

            <div class="layout horizontal">
              <gold-cc-cvc-input id="cc_cvc" card-type="[[cc_type]]" value="{{cc_cvc}}" required auto-validate></gold-cc-cvc-input>
              <span class="flex" style="margin-right:16px;"></span>
              <gold-cc-expiration-input id="cc_exp" value="{{cc_exp}}" required auto-validate></gold-cc-expiration-input>
            </div>

            <paper-input id="cc_name" label="Name on card" class="field" required value="{{cc_name}}" auto-validate></paper-input>
            <gold-zip-input id="cc_zip" value="{{cc_zip}}" required auto-validate></gold-zip-input>
            <br>
            <paper-checkbox checked="{{isDefault}}">Default</paper-checkbox>

          </form>

          <div class="buttons">
            <paper-button raised autofocus on-tap="cancel">Cancel</paper-button>
            <paper-button raised disabledx$="[[_validCardForm()]]" on-tap="_saveCard" class="save_button">Save</paper-button>
          </div>

        </div>

      </paper-material>

    </iron-pages>




  </template>
  <script>
    (function() {

      Polymer({
        is: 'page-card',
        enableCustomStyleProperties: true,
        properties: {

          user: {
            type: Object,
            notify: true,
          },

          byId: {
            type: String,
            notify: true,
          },
          selectedCard: {
            type: Object,
            notify: true,
          },
          selectedPage: {
            type: Number,
            notify: true,
            value: 0
          },

          isDefault: {
            type: Boolean,
            notify: true,
            value: false
          },

          userSetting: {
            type: Object,
            notify: true,
          },

          cc_num: {
            type: String,
            notify: true,
            // value: '375150143565695'
          },
          cc_exp: {
            type: String,
            notify: true,
            // value: '10/30'

          },
          cc_cvc: {
            type: String,
            notify: true,
            // value: '1432'
          },
          cc_name: {
            type: String,
            notify: true,
            // value: 'name on card'
          },
          cc_zip: {
            type: String,
            notify: true,
            // value: "43223"
          },

          cc_type: {
            type: String,
            notify: true,
          }

        },

        _computeTypeIcon: function(type) {
          return 'bower_components/gold-cc-input/images/' + type + '.png';
        },

        _saveDefault: function(key) {
          // console.log(!this.isDefault && key === this.userSetting);

          if (this.isDefault) {
            // console.dir(this.userSetting);
            this.set('userSetting', {
              'default_card': key
            });
            return true;
          }

          if (!this.isDefault && key === this.userSetting) {
            this.set('userSetting', {
              'default_card': null
            });
            return true;
          }

          if (!this.userSetting.default_card) {
            this.set('userSetting', {
              'default_card': key
            });
            return true;
          }

          return 'unable to to save ' + key + ' to default_card setting';

        },

        _computeCardByID: function(_, ref) {
          console.log(this.byId);

          if (this.byId === 'new') {
            console.log('NEW');
            this.selectedPage = 1;
            return;
          }

          console.log(ref.val());
          var selectedCard = ref.val();
          if (selectedCard) {
            this.cc_num = selectedCard.cc_num;
            this.cc_zip = selectedCard.cc_zip;
            this.cc_cvc = selectedCard.cc_cvc;
            this.cc_exp = selectedCard.cc_exp;
            this.cc_name = selectedCard.cc_name;
          }
        },

        _computeUserSetting: function(_, snapshot) {
          // console.log(this.userSetting);

          if (!snapshot.val()) return;
          // console.log(snapshot.val().default_card, this.byId);
          console.log(this.byId === snapshot.val().default_card);
          if (this.byId === snapshot.val().default_card) {
            this.isDefault = true;
          }
        },

        _userSettingLocation: function(user) {
          // console.log(user);
          // console.log(this.user, this.byId);
          if (user) {
            return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/settings/';
          }

        },

        _computeCardLocation: function(user, loggedin) {
          // console.log(user.uid, loggedin);
          if (loggedin) {
            return 'https://charlesiesbeta.firebaseio.com/users/' + user.uid + '/cards';
          }
        },

        _cardLocation: function(user, id) {
          // console.log(user, id);
          // console.log(id !== "new" && loggedin);
          if (id !== "new" && user) {
            this.selectedPage = 1;
            return 'https://charlesiesbeta.firebaseio.com/users/' + this.user.uid + '/cards/' + id;
          }

          if (id === "new" && user) {
            this.selectedPage = 1;
          }
          if (!user) {

          }

        },


        _computeCardList: function() {
          // console.log(this._card);
          this.debounce('isDefaultCardCheck', function(argument) {
            if (this._card.length > 0) {
              for (var i = 0; i < this._card.length; i++) {
                // console.log(this._card[i].__firebaseKey__ === this.userSetting.default_card );
                if (this._card[i].__firebaseKey__ === this.userSetting.default_card) {
                  // console.log(this._card[i]);
                  this._card[i].isDefault = true;
                }
              }
            }
          }, 0);

          // Get List (Array) firebase sets to this._card
          this.set('card', this._card);

        },

        _navEditCard: function(item) {
          // console.dir(item.model.item.__firebaseKey__);
          this.debounce('editnav', function(argument) {
            this.fire('nav', {
              path: '/account/card/' + item.model.item.__firebaseKey__
            });
            // +'?edit=true'
          }, 200);

        },

        _navAddCard: function(item) {
          // console.dir(item.model.item.__firebaseKey__);
          this.debounce('newnav', function(argument) {
            this.fire('nav', {
              // path: '/account/card/new'
              path: '?byId=new'
            });
          }, 200);

        },

        _computePageTitle: function(selectedPage) {
          if (selectedPage === 0) {
            return 'Cards';
          }
          if (selectedPage === 1) {

            if (this.byId) {
              return 'Edit Card: ' + this.type + " " + this.ending;
            }
            return 'Add Card';
          }
        },

        cancel: function function_name(replace) {
          this.cc_num = "";
          this.cc_exp = "";
          this.cc_cvc = "";
          this.cc_name = "";
          this.cc_zip = "";

          this.fire('nav', {
            path: "/account/card"
          });

        },

        _validCardForm: function(argument) {
          // console.dir(this.$.newCardForm.validate());
          return this.$.newCardForm.validate();
        },

        _saveCard: function() {

          if (!this.$.newCardForm.validate()) {
            this.fire('toast', {
              text: 'Card form is not complete, please try again'
            });
            return;
          }

          // Add card components

          var selectedCard = {};

          selectedCard.cc_num = this.cc_num;
          selectedCard.cc_exp = this.cc_exp;
          selectedCard.cc_cvc = this.cc_cvc;
          selectedCard.cc_name = this.cc_name;
          selectedCard.cc_type = this.cc_type;
          selectedCard.cc_zip = this.cc_zip;
          selectedCard.createdAt = {
            ".sv": "timestamp"
          };

          selectedCard.cc_end = this.cc_num.slice(-4);
          this.createdAt = {
            ".sv": "timestamp"
          };


          var key;
          if (this.byId) {
            this.$.fbUserCard.query.ref().set(selectedCard);
            key = this.$.fbUserCard.query.ref().key();
          } else {
            key = this.$.fbUserCardList.query.ref().push(selectedCard).key();
          }

          var done = this._saveDefault(key);

          if (!done) {
            this.fire('toast', {
              text: done
            });
          }
          this.cancel(true);
        },



      });
    })();
  </script>


</dom-module>
