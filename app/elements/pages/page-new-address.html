<dom-module id="page-new-address">
  <template>
    <style is="custom-style">
      :host {
        background-color: white;
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-center);
        background: rgba(0, 0, 0, 0.7);
      }

      .new_address_dialog {
        padding: 16px;
        background-color: white;
        margin: 64px 16px 16px;
        width: 304px;
      }

      .new-address-form {
        margin-bottom: 32px;
      }

      .save_button {
        background-color: var(--paper-green-a700);
        color: white;
        --paper-button-ink-color: white;
      }
      .closeButton{
        position: absolute;
        top: 16px;
        right: 16px;
      }
    </style>

    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{user}}" address="{{address}}"></catalog-user>
    <google-maps-api id="maps" libraries="places" on-api-load="on_api_load"></google-maps-api>


    <paper-material class="new_address_dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <paper-icon-button class="closeButton" icon="close" on-tap="cancel"></paper-icon-button>

      <h2>Add Address</h2>

      <form class="new-address-form" is="iron-form" id="addAddressForm" method="post" action="/" on-iron-form-submit="_addnewaddress">

        <paper-input value="{{add_street}}" label="Street Address" class="field" id="street_number" required></paper-input>

        <paper-input value="{{add_suite}}" label="Apt/Suite" class="field" id="route"></paper-input>

        <paper-input value="{{add_city}}" label="City" class="field" id="locality" required></paper-input>

        <paper-input value="{{add_state}}" label="State" class="field" id="administrative_area_level_1" required></paper-input>

        <gold-zip-input value="{{add_zip}}" id="postal_code" required></gold-zip-input>

      </form>

      <div class="buttons layout horizontal">
        <paper-button raised class="layout end" on-tap="cancel">Cancel</paper-button>
        <paper-button class="save_button layout end" on-tap="_saveAddress">Save</paper-button>
      </div>

    </paper-material>
  </template>
  <script>
    (function() {

      var componentForm = {
        street_number: 'short_name',
        route: 'long_name',
        locality: 'long_name',
        administrative_area_level_1: 'short_name',
        country: 'long_name',
        postal_code: 'short_name'
      };

      Polymer({
        is: 'page-new-address',
        enableCustomStyleProperties: true,
        properties: {

          user: {
            type: Object,
            notify: true,
          },
          place: {
            type: Object,
            notify: true,
            value: {}
          },
          newAddress: {
            type: Object,
            notify: true,
            value: {}
          },

        },


        cancel: function function_name(_replace) {
          this.add_street = "";
          this.add_city = "";
          this.add_state = "";
          this.add_zip = "";
          this.add_suite = "";
          // console.log(window.location.pathname);
          var replace = _replace || false;
          // console.log(replace);
          document.querySelector('app-router').go(window.location.pathname+"?selectedAddress=0", {replace: replace});
          // window.history.back(-1);
        },

        _saveAddress: function() {
          // console.log(this.$.address);
          // console.log(!this.place.address_components);

          if (!this.$.addAddressForm.validate()) {
            this.fire('toast', {
              text: 'Address is not complete, please try again'
            });
            console.log('Address is not complete, please try again');
            return;
          }

          // Add address components

          this.newAddress.add_street = this.add_street;
          this.newAddress.add_city = this.add_city;
          this.newAddress.add_state = this.add_state;
          this.newAddress.add_zip = this.add_zip;
          this.newAddress.suite = this.suite || '';


          this.$.catalogUser.save_address(this.newAddress);

          // document.querySelector('app-router').go(window.location.pathname, {replace: true});
          // document.querySelector('app-router').go(window.location.pathname, {replace: true});
          this.cancel(true);
        },

        on_api_load: function() {
          this.autocomplete = new google.maps.places.Autocomplete(this.$.street_number, this.options);
          google.maps.event.addListener(this.autocomplete, 'place_changed', this.on_change_place.bind(this));
        },

        on_change_place: function() {
          this.place = this.autocomplete.getPlace();
          if (!this.place.address_components) {
            return;
          }
          this.value = this.place.formatted_address;

          // console.log(this.place);

          this.add_street = "";
          this.add_city = "";
          this.add_state = "";
          this.add_zip = "";

          for (var i = 0; i < this.place.address_components.length; i++) {
            var addressType = this.place.address_components[i].types[0];
            // console.log(componentForm[addressType]);
            if (componentForm[addressType]) {

              var val = this.place.address_components[i][componentForm[addressType]];
              // console.log(addressType, val);
              if (addressType === 'street_number') {
                // this.newAddress.formatted_address_1 = val;
                this.add_street = val;
              }

              if (addressType === 'route') {
                // this.newAddress.formatted_address_1 += ' ' + val;
                // console.log(this.newAddress.formatted_address_1);
                this.add_street += ' ' + val;
              }

              if (addressType === 'locality') {
                // this.newAddress.formatted_address_2 = val;
                this.add_city = val;
              }

              if (addressType === 'administrative_area_level_1') {
                // this.newAddress.formatted_address_2 += ', ' + val;
                this.add_state = val;
              }

              if (addressType === 'postal_code') {
                // this.newAddress.formatted_address_2 += ', ' + val;
                // console.log(this.newAddress.formatted_address_2);
                this.add_zip = val;
              }

              // console.log(addressType);
              // document.getElementById(addressType).value = val;
            }
          }
        }

      });
    })();
  </script>
</dom-module>
