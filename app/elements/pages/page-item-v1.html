<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/iron-component-page/iron-component-page.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">


<link rel="import" href="../catalog-data/catalog-data.html">
<link rel="import" href="../catalog-category/catalog-category.html">
<link rel="import" href="../catalog-product/catalog-product.html">
<link rel="import" href="../package-symbol/package-symbol.html">
<link rel="import" href="../responsive-element/responsive-element.html">
<link rel="import" href="../theme-color/theme-color.html">
<link rel="import" href="../cart-icon/cart-icon.html">
<link rel="import" href="../cart-item-icon/cart-item-icon.html">


<dom-module id="page-item">
  <link rel="import" type="css" href="page-item.css">
  <template>

    <catalog-product id="catalogProduct" key="{{byId}}" data="{{item}}"></catalog-product>
    <catalog-category byshort="[[categoryByShort]]" data="{{category}}"></catalog-category>
    <catalog-user id="catalogUserPageElement" user="{{user}}"></catalog-user>

    <paper-drawer-panel id="drawerPanel" narrow="{{narrowDrawer}}" responsive-width="900px" drawer-width="272px" disable-edge-swipe>
      <app-sidebar drawer>
        <paper-toolbar>
          <app-logo class="flex" full="true"></app-logo>
          <search-bar class="horizontal layout center end-justified" query="{{q}}"></search-bar>
        </paper-toolbar>
        <div class="content">
          <a is="app-link" href="[[_categoryLink(item.category)]]" class="horizontal layout center" id="category-heading">
            <iron-icon icon="chevron-left"></iron-icon>
            <category-symbol item="[[item]]"></category-symbol>
            <span class="name flex">[[category.label]]</span>
          </a>

          <div id="item-header" class="">
            <template is="dom-if" if="[[!user.isAdmin]]" restamp="true">
              <div class="meta-item layout horizontal">
                <h2 id="item-title">[[item.label]]</h2>
                <span class="flex"></span>
                <h4 class="itemPrice">
                  <span>[[item.priceText]]</span>
                </h4>
              </div>
            </template>

            <template is="dom-if" if="[[user.isAdmin]]" restamp="true">
              <div class="meta-item layout horizontal">
                <paper-input id="data-label" placeholder="Label" value="{{item.label::change}}" label="Name" style="width:100%"></paper-input>
              </div>
            </template>
          </div>



          <div id="item-desc">

            <template is="dom-if" if="[[item.description]]" restamp="true">
              <template is="dom-if" if="[[!user.isAdmin]]" restamp="true">
                <p>[[item.description]]</p>
              </template>
            </template>
            <template is="dom-if" if="[[user.isAdmin]]" restamp="true">
              <paper-textarea id="data-description" label="Description" value="{{item.description::input}}" rows="1" max-rows="5"></paper-textarea>
            </template>

          </div>


          <section id="item-options" class="shrinkable layout vertical">
            <div class="layout horizontal">
              <h4>Options</h4>
              <span class="flex"></span>
              <paper-icon-button icon="menu" in-fav on-tap="_tapMenuOptions" hidden$="[[!user.isAdmin]]"></paper-icon-button>
            </div>
            <template is="dom-if" if="{{!user.isAdmin}}">
              <!-- <nav id="elnav" class="nav">
                <template is="dom-repeat" items="[[item.optionsArray]]" as="option">
                  <a is="app-link" class="item" href="[[_subLink(active,item.path)]]" active$="[[_subActive(item.path,view)]]">
                    <iron-icon icon="visibility"></iron-icon>
                    <span>[[option.label]]</span>
                  </a>
                </template>
              </nav> -->
              <div class="meta">
                <template is="dom-repeat" items="[[item.optionsArray]]" as="option">
                  <paper-button id="optionButton" toggles>[[option.label]]</paper-button>
                </template>
              </div>
            </template>

            <template is="dom-if" if="{{user.isAdmin}}">
              <template is="dom-repeat" items="{{item.optionsArray}}" as="option">
                <div class="meta-item layout horizontal">
                  <paper-input class="optionLabelValue" value="{{option.label::input}}" label="Label" type="text" always-float-label>
                  </paper-input>
                  <span class="flex"></span>
                  <paper-input class="optionPriceValue" value="{{option.price::input}}" label="Price" type="number" no-label-floatFFFF always-float-label>
                    <div prefix>$</div>
                  </paper-input>
                  <paper-icon-button on-tap="_tapRemoveOption" icon="clear" alt="clear" title="clear" style="margin-top: 20px;">
                  </paper-icon-button>
                </div>
              </template>

              <div class="layout horizontal meta-item">
                <paper-input class="optionLabelValue" value="{{addOption.label}}" label="Label" type="text" always-float-label placeholderFFFF="New">
                </paper-input>
                <span class="flex"></span>
                <paper-input class="optionPriceValue" value="{{addOption.price}}" label="Price" type="number" no-label-floatFFFF always-float-label placeholder="0">
                  <div prefix>$</div>
                </paper-input>
                <paper-icon-button on-tap="_tapAddOption" icon="add" alt="add option" title="Add Option" style="margin-top: 20px;">
                </paper-icon-button>
              </div>

            </template>
            <template is="dom-if" if="[[!user.isAdmin]]" restamp="true">
              <div class="cart-item-icon layout horizontal center-center">
                <cart-item-icon view="paper-button" id="cartItemIcon" item="[[item]]"></cart-item-icon>
              </div>
            </template>
          </section>




          <!-- <nav id="nav" class="nav" attr-for-selected="name" selected="{{view}}">
            <a is="app-link" class="item" href="[[_link(active,'docs')]]" active$="[[_isEqual(view,'docs')]]">
              <iron-icon icon="description"></iron-icon>
              <span>Docs</span>
            </a>
            <template is="dom-repeat" items="[[item.optionsArray]]" as="option">
              <a is="app-link" class="item" href="[[_subLink(active,item.path)]]" active$="[[_subActive(item.path,view)]]">
                <iron-icon icon="visibility"></iron-icon>
                <span>[[option.label]]</span>
              </a>
            </template>
            <a class="item" href="[[_githubLink(item.source)]]" target="_blank">
              <iron-icon icon="code"></iron-icon>
              <span>Source</span>
            </a>
          </nav> -->


          <!-- <div class="bower-command-label">Bower Command</div>
          <input class="bower-command" title="Bower Command" readonly value="[[_bowerCommand(item.source)]]" on-tap="_selectAllBowerCommand"> -->

          <!-- <section class="shrinkable" hidden$="[[_oneOrFewer(docBehaviors, docElements)]]">
            <h4>Bundled Behaviors</h4>
            <nav id="elnav" class="nav" attr-for-selected="name" selected="[[active]]">
              <template is="dom-repeat" items="[[docBehaviors]]">
                <a is="app-link" class="item" href$="[[_link(item.is,view)]]" active$="[[_isEqual(item.is,active)]]">[[item.is]]</a>
              </template>
            </nav>
          </section> -->

          <section id="item-tags" class="shrinkable layout vertical">
            <div class="meta layout horizontal">
              <iron-icon icon="maps:local-offer" class="" style="width:24px;margin-top:16px;margin-right:4px;"></iron-icon>
              <h4 style="margin-top:12px;margin-left:0px;margin-right:0px;">Tags</h4>
              <span class="flex"></span>
              <paper-icon-button icon="menu" in-fav on-tap="_tapMenuTags" hidden$="[[!user.isAdmin]]"></paper-icon-button>
            </div>

            <!-- <div class="shrinkable" hidden$="[[_oneOrFewer(docBehaviors, docElements)]]">
              <template is="dom-repeat" items="[[item.tagsArray]]" as="tag">
                <a is="app-link" class="item" href$="[[_computeTagLink(tag)]]">#[[tag.label]]</a>
              </template>
            </div> -->

            <!-- <nav id="elnav" class="nav">
              <template is="dom-repeat" items="[[item.tagsArray]]" as="option">
              <a is="app-link" class="item" href="[[_subLink(active,item.path)]]" active$="[[_subActive(item.path,view)]]">
                <iron-icon icon="visibility"></iron-icon>
                <span>[[option.label]]</span>
              </a>
              </template>
            </nav> -->

            <div class="meta-item">
              <template is="dom-repeat" items="[[item.tagsArray]]" as="tag">

                <template is="dom-if" if="[[!user.isAdmin]]">
                  <a is="app-link" class="tag" href="[[_tagLink]]" active$="[[_tagActive(tag,view)]]">
                    <span>#[[tag.label]]</span>
                  </a>
                </template>

                <template is="dom-if" if="[[user.isAdmin]]">
                  <paper-button on-tap="_tapRemoveTag" alt="Remove Tag" title="Remove Tag">
                    <span>#[[tag.label]]</span>
                    <iron-icon icon="clear"></iron-icon>
                  </paper-button>
                </template>

              </template>
            </div>

            <template is="dom-if" if="[[user.isAdmin]]" restamp="true">

              <div class="layout horizontal meta-item">
                <paper-input class="tagLabelValue" value="{{addTagLabel}}" placeholder="Add tag" type="text" no-label-float on-change="_addTagChange" style="width:100%">
                </paper-input>
              </div>

            </template>
          </section>

        </div>
      </app-sidebar>


      <section main class="fit">
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
        <cart-icon class="cartButton" id="cart-toggle" icon="stars" on-tap="cartOpen"></cart-icon>
      </section>

    </paper-drawer-panel>


  </template>
</dom-module>

<script>
  // Utils
  var decimalOnly = /^\s*-?[1-9]\d*(\.\d{1,2})?\s*$/;
  Polymer({
    is: 'page-item',
    enableCustomStyleProperties: true,
    properties: {
      // page
      byId: {
        type: String,
        notify: true,
      },
      item: {
        type: Object
      },
      view: {
        type: String,
        value: 'docs'
      },
      active: {
        type: String,
        value: ''
      },
      docElements: Array,
      docBehaviors: Array,
      docDemos: Array,
      docs: Object,
      categoryByShort: String,
      router: Object,
      q: String,
      narrowDrawer: Boolean,
      addTagLabel: {
        type: String,
        notify: true
      },
      // addOptionLabel: {
      //   type: String,
      //   notify: true,
      // },
      // addOptionPrice: {
      //   type: Number,
      //   notify: true,
      // },
      addOption: {
        type: Object,
        notify: true,
        value: {}
      },
    },
    observers: [
      'updateMeta(item,active)',
      'viewUpdated(view)',
      'search(q)',
      '_updateStyles(category)',
      // '_check(addOption.*)',
    ],

    _check: function(arg) {
      console.log('check(obj) ', arguments);
    },


    _addTagChange: function() {
      this.$.catalogProduct._addTag(this.addTagLabel)
        .then(function(err) {
          // console.log(err);
          this.addTagLabel = '';
        }.bind(this));
    },
    _tapRemoveTag: function(item) {
      // console.log('tap remove option: ', item);
      this.$.catalogProduct._removeTag(item.model.__data__.tag)
        .then(function(err) {
          // console.log(err);
        }.bind(this));
    },

    _tapAddOption: function(e) {
      this.$.catalogProduct._addOption(this.addOption)
        .then(function(err) {
          // console.log(err);
          this.addOption = {};
        });
    },
    _tapRemoveOption: function(item) {
      // console.log(item.model.__data__);
      this.$.catalogProduct._removeOption(item.model.__data__.option)
        .then(function(err) {
          // console.log(err);
        });
    },

    attached: function() {
      this.updateMeta();
    },
    _link: function(active, view) {
      return this.getURL(active, view);
    },
    _subLink: function(active, path) {
      return this.getURL(active, 'demo:' + path, true);
    },
    _subActive: function(path) {
      return this.view === 'demo:' + path;
    },
    _githubLink: function(source) {
      return 'https://github.com/' + source;
    },
    getURL: function(active, view, force) {
      var url = "/products/" + this.item.key;
      var qs = [];
      if (force || (view && view.length && view !== 'docs')) qs.push('view=' + view);
      if (force || (active && active.length && active !== this.element)) qs.push('active=' + active);
      if (qs.length) url += "?" + qs.join("&");
      return url;
    },
    updateMeta: function(item, active) {
      if (this.item) {
        this.$.drawerPanel.closeDrawer();
        this.fire('page-meta', {
          // title: (this.active && this.active.length) ? this.active : this.item.label
          title: this.item.label
        });
      }
      // console.log(item);

    },
    viewUpdated: function() {
      this.$.drawerPanel.closeDrawer();
    },
    _categoryLink: function() {
      return "/?category=" + this.category;
    },
    navToElement: function(e) {
      this.router.go("/elements/" + e.currentTarget.getAttribute('name'));
    },
    search: function(q) {
      if (q || this.q) {
        this.router.go('/?q=' + (q || this.q));
      }
    },
    cartAdd: function() {
      this.fire('cart-add', this.element);
    },
    _oneOrFewer: function(arr1, arr2) {
      if (!arr1 || arr1.length === 0) {
        return true;
      }
      if (!arr2) {
        return arr1.length <= 1;
      }
      return arr1.length + arr2.length <= 1;
    },

    _isEqual: function(a, b) {
      return a === b;
    },

    _handleError: function() {
      this.router.go('/404');
    },

    _updateStyles: function(category) {
      console.log(category);
      // this.async(this.$.componentPage.updateStyles, 2);
    },
  });
</script>
