<dom-module id="page-items">
  <template>

    <style is="custom-style" media="screen">
      .red {
        color: var(--accent-color);
      }

      .grid-layout {
        display: -ms-inline-flexbox;
        display: -webkit-inline-flex;
        display: inline-flex;
        -ms-flex-wrap: wrap;
        -webkit-flex-wrap: wrap;
        flex-wrap: wrap;
        -ms-flex-align: start;
        -webkit-align-items: flex-start;
        align-items: flex-start;
        display: -ms-flexbox;
        display: -webkit-flex;
        display: flex;
        -ms-flex-direction: row;
        -webkit-flex-direction: row;
        flex-direction: row;
        -ms-flex-align: center;
        -webkit-align-items: center;
        align-items: center;
        -ms-flex-pack: center;
        -webkit-justify-content: center;
        justify-content: center;
      }

       .grid-cell {
        margin: 16px;
        width: calc(100vh*.5);
      }


      @media all and (min-width: 480px) {
        .grid-cell {
          width: 208px;
          margin: 8px;
        }
      }

      @media all and (min-width: 600px) {
        .grid-cell {
          width: 264px;
        }
      }

      @media all and (min-width: 1120px) {
        .grid-cell {
          margin: 16px;
        }
      }
    </style>

    <!-- <firebase-collection id="elements" location="https://charlesiesbeta.firebaseio.com/elements" data="{{elements}}" order-by-child="priorty" limit-to-first="{{queryLimit}}"></firebase-collection> -->

    <catalog-data elements="[[elements]]"></catalog-data>

    <iron-ajax id="firebaseElements" params="{{_params()}}" url="https://charlesiesbeta.firebaseio.com/elements.json" handle-as="json" loading="{{loading}}" last-response="{{_elements}}" auto></iron-ajax>

    <iron-media-query query="(max-width: 640px)" query-matches="{{_narrowViewport}}"></iron-media-query>
    <paper-spinner active="{{loading}}"></paper-spinner>

    <div class="grid-layout">

      <template is="dom-repeat" items="[[elements]]">
        <element-card element="{{item}}" class="grid-cell"></element-card>
      </template>

      <!-- <iron-list items="[[elements]]" as="item" class="flex">
        <template>

          <paper-card heading="[[item.name]]" image="http://placehold.it/280x380" class="grid-cell">
            <div class="card-content">
              Lorem ipsum dolor sit amet, nec ad conceptam interpretaris.
            </div>
            <div class="card-actions">

              <paper-icon-button icon="favorite"></paper-icon-button>
              <paper-icon-button icon="shopping-cart"></paper-icon-button>

              <h4 class="itemPrice">$
                <span class="red">[[item.version]]</span>
              </h4>

            </div>
          </paper-card>

        </template>
      </iron-list> -->

    </div>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'page-items',
        enableCustomStyleProperties: true,
        properties: {
          router: Object,
          pageTitle: {
            type: String
          },
          // Query Parameters
          search: {
            type: String,
            notify: true,
            value: ''
          },
          tag: {
            type: String,
            notify: true,
            value: ''
          },
          elements: {
            type: Array,
            notify: true
          },
          tagList: {
            type: Array,
            computed: 'arrayParam(tag)',
            value: function() {
              return [];
            }
          },
          queryLimit: {
            type: Number,
            value: 10
          }
        },
        observers: [
          // 'updateURL(q,package,tag,view,packageid)',
          // 'updateMeta(elements)',
          'updateElements(_elements)'
        ],
        listeners: {
          'update-params': '_handleParamsUpdate'
        },

        attached: function() {
          // this.updateMeta();
          this.updateSearch();
        },

        _params: function() {
          var p = {};
          p.orderBy = '\"priorty\"';
          p.limitToFirst = 8;
          // console.log(p);
          return p;
        },

        updateElements: function(els) {
          this.elements = Object.keys(els).map(function(key) {
            return els[key];
          });
          els = null;
        },

        updateTag: function(e, detail) {
          e.stopPropagation();
          e.preventDefault();
          var newTag = detail.name;
          var t = this.tagList.slice(0);
          if (t.indexOf(newTag) < 0) t.push(newTag);
          this.tag = t.join(',');
        },
        clearTag: function() {
          this.tag = null;
        },

        clearITEMS: function() {
          this.package = null;
        },

        _parseQueryString: function() {
          var query = window.location.search.substring(1);
          var params = query.split('&');
          var results = [];
          for (var i = 0; i < params.length; i++) {
            var pair = params[i].split('=');
            results[pair[0]] = pair[1];
          }
          return results;
        },
        _buildQueryString: function() {
          var out = [];
          if (this.q && this.q.length) out.push("q=" + this.q);
          if (this.tag && this.tag.length) out.push("tag=" + this.tag);
          // if (this.getPackage && this.getPackage.length) out.push("package=" + this.package);

          return out.join("&");
        },
        _handleParamsUpdate: function(_, params) {
          for (var key in params) {
            this[key] = params[key];
          }
        },

        updateSearch: function() {
          var params = this._parseQueryString();
          if (params && params.q) {
            this.async(function() {
              this.$.query.focus();
            });
          }
        },

        updateMeta: function(elements) {
          console.log('updateMeta', elements[0]);

          // this.customStyle['--my-package-color'] = getPackage.color;
          // this.customStyle['--my-package-image'] = "url(" + getPackage.image + ")";
          // console.log(this.customStyle['--my-package-image']);
          // this.updateStyles();

          if (this.q && this.q.length) {
            var t = "'" + this.q + "' ";
            t += (this.packageid && getPackage.title) ? getPackage.title :
              "Elements";
            this.pageTitle = t;
          } else if (elements) {
            // this.pageTitle = getPackage.title;
          } else if (this.tagList.length) {
            this.pageTitle = "Elements Tagged '" + this.tagList.join(
              "' or '") + "'";
          } else {
            this.pageTitle = "All Elements";
          }

          this.fire('page-meta', {
            title: this.pageTitle
          });

        },

        arrayParam: function(param) {
          if (!param || !param.length) {
            return [];
          }
          return param.toString().split(',');
        },
        cartOpen: function(e) {
          this.fire('cart-open');
        },

        _detectIEVersion: function() {
          // via http://stackoverflow.com/questions/17907445/how-to-detect-ie11
          var rv = -1;
          var ua, re;
          if (navigator.appName === 'Microsoft Internet Explorer') {
            ua = navigator.userAgent;
            re = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) !== null)
              rv = parseFloat(RegExp.$1);
          } else if (navigator.appName === 'Netscape') {
            ua = navigator.userAgent;
            re = new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})");
            if (re.exec(ua) !== null)
              rv = parseFloat(RegExp.$1);
          }
          return rv;
        },

        _isEqual: function(a, b) {
          // console.log('_isEqual', a, b);
          return a === b;
        }
      });
    })();
  </script>

</dom-module>
