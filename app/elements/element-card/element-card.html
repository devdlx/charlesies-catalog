<link rel="import" href="../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../catalog-product/catalog-product.html">
<link rel="import" href="../catalog-category/catalog-category.html">
<link rel="import" href="../hero-image/hero-image.html">
<link rel="import" href="../package-symbol/package-symbol.html">
<link rel="import" href="../element-action-menu/element-action-menu.html">
<link rel="import" href="../cart-item-icon/cart-item-icon.html">

<dom-module id="element-card">
  <template>
    <style>
      :host {
        display: -webkit-box;
        /*margin: 10px 10px 10px 0;*/
        cursor: pointer;
        border-radius: 4px;
        /*border: 1px solid #d0d0d0;*/
        border: 1px solid rgba(208, 208, 208, 0.33);
        background: white;
        /*flex: 1 250px;*/
        /*max-width: calc(48vw - 10px);*/
        /*width: 100%;*/
        transition-properties: all;
        transition-duration: 0.4s;
        -webkit-transition-properties: all;
        -webkit-transition-duration: 0.4s;
        width: 266px;
        margin-bottom: 20px;
        background-color: white;
        position: relative;
      }

      :root {
        --hero-height: 266px;
        --hero-width: 266px;
      }
      /*@media (max-width: 1070px) {
        :host {
          max-width: calc(50% - 10px);
        }
      }

      @media (max-width: 530px) {
        :host {
          max-width: calc(100% - 10px);
        }
      }*/

      :host(:hover),
      :host(.hover) {
        @apply(--shadow-elevation-2dp);
      }

      #item-label #label {
        font-size: 16px;
        font-weight: 500;
        margin: 0;
        padding: 0 16px;
        line-height: 18px;
      }

      p {
        margin: 0;
      }

      #el {
        position: relative;
        cursor: pointer;
      }

      #hero {
        /*width: calc(48vw - 10px);*/
        /*height: calc(48vw - 10px);*/
        /*width: 100%;*/
        /*height: var(--hero-height);
        width: var(--hero-width);*/
        height: 266px;
        width: 266px;
        /*background: #ccc;*/
        border-radius: 3px 3px 0 0;
        overflow: hidden;
      }

      #hero.border-bottom {
        border-bottom: 1px solid #e5e5e5;
      }

      #hero > img {
        width: 100%;
        height: 100%;
      }

      #hero iron-image {
        width: 100%;
        height: 100%;
        /*background-color: #212121;*/
        /*background-color: white;*/
      }

      #hero.tall {
        height: 394px;
      }

      #heroActions {
        position: absolute;
        bottom: 0;
        right: 0;
        left: 0;
        background: rgba(51, 51, 51, 0.41);
        color: white;
        height: 52px;
      }

      #heroActions #title {
        @apply(--paper-font-title2);
        color: white;
        margin: 0;
        padding: 10px 16px;
      }

      .item-price {
        margin: 0;
        line-height: 40px;
      }

      .body-item {
        /*border-top: 1px solid;*/
        /*border-bottom: 1px solid;*/
        /*border-color: var(--divider-color);*/
        border-color: rgba(219, 219, 219, 0.2);
        padding: 10px 16px;
        min-height: 20px;
      }

      .body-item:last-child {
        border-bottom: 0;
      }

      #data-label {
        margin: 0;
        padding: 10px 16px 0;
      }

      #data-description {
        @apply(--paper-font-body1);
        margin: 0;
        padding: 0 16px;
      }

      #data-label,
      #data-description {
        --paper-input-container-underline-disabled: {
          border: none;
        }
        --paper-input-container-disabled: {
          opacity: 1;
        }
      }

      #description {
        /*@apply(--paper-font-body1);*/
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        font-size: 14px;
        font-weight: 400;
        color: var(--secondary-text-color);
        margin: 16px 0;
        padding: 0 16px;
        /*height: 75px;*/
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
      }

      .package {
        font-size: 12px;
        font-weight: 500;
      }

      .package package-symbol {
        margin: 0 15px 0 0;
      }

      .package > a:hover {
        text-decoration: underline;
      }

      .tags iron-icon {
        margin: 0 15px 0 0;
        padding: 5px;
        color: var(--secondary-text-color);
        --iron-icon-size: 18px;
      }

      .tag {
        margin-right: 4px;
        font-size: 12px;
      }

      .tag:hover {
        text-decoration: underline;
      }

      .tag:after {
        margin-left: -3px;
        content: " ,";
      }

      .tag:last-of-type:after {
        content: "";
      }

      @media all and (min-width: 481px) {
        :host {
          margin: 0 4px 8px 4px;
          width: 220px;
        }
        #hero {
          width: 220px;
          height: 220px;
        }
        #hero.tall {
          height: 326px;
        }
        #hero.wide {
          width: 450px;
        }
      }

      @media all and (min-width: 1281px) and (max-width: 1600px) {
        #hero {
          /*width: 302px;*/
          /*height: 302px;*/
        }
        #hero.tall {
          height: 447px;
        }
        #hero.wide {
          width: 618px;
        }
      }

      .check-icon {
        width: 12px;
        height: 12px;
        background: var(--paper-grey-300);
        --iron-icon-fill-color: white;
        border-radius: 50%;
        padding: 3px;
        margin-left: 4px;
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 1;
      }

      :host.iron-selected .check-icon {
        background: var(--paper-green-300);
      }
    </style>

    <catalog-product id="catalogProduct" data="{{item}}" key="{{itemKey}}"></catalog-product>

    <div class="vertical layout">
      <!-- <div id="el" view="docs"> -->
      <template is="dom-if" if="[[select]]" restamp="true">
        <iron-icon icon="check" class="check-icon" checked$="[[addressFormOk]]"></iron-icon>
      </template>

      <a href$="[[_getItemLink(item.key)]]">
        <div id="hero" style$="[[_computeStyle(color)]]" on-mouseenterFFFF="_mouseEnter" on-mouseleaveFFFF="_mouseLeave">
          <!-- <img src="[[_getImageSrc(item)]]"> -->
          <iron-image fade src="[[mediaSrc]]" sizing="{{sizing}}" preload placeholderFFFF=""></iron-image>
        </div>
        <!-- <h3 id="title">[[item.label]]</h3> -->
        <template is="dom-if" if="[[!body]]" restamp="true">
          <div id="heroActions" class="layout horizontal">
            <template is="dom-if" if="[[itemLabel]]" restamp="true">
              <h3 id="title">[[itemLabel]]</h3>
            </template>
            <!-- <paper-input id="data-label" class="title" placeholder="Label" value="{{item.label::change}}" disabled$="[[!admin]]" no-label-float="true"></paper-input> -->
            <span class="flex"></span>
            <template is="dom-if" if="[[actionButton]]" restamp="true">
              <cart-item-icon id="cartItemIcon" item="[[item]]" view="paper-icon-button"></cart-item-icon>
            </template>
          </div>
        </template>
        <!-- <template is="dom-if" if="[[item.label]]" restamp="true">
            <h3 id="title">[[item.label]]</h3>
          </template> -->
        <!-- </div> -->

        <template is="dom-if" if="[[body]]" restamp="true">

          <div class="body-item card-actions layout horizontal ">
            <cart-item-icon id="cartItemIcon" item="[[item]]" view="paper-icon-button"></cart-item-icon>
            <span class="flex"></span>
            <h4 class="item-price">
              <span>[[item.priceText]]</span>
            </h4>
          </div>

          <!-- <element-action-menu key="[[item.__firebaseKey__]]" icons-onlyFFFF="true"></element-action-menu> -->

          <div id="item-label">
            <template is="dom-if" if="[[itemLabel]]" restamp="true">
              <template is="dom-if" if="[[!admin]]" restamp="true">
                <h3 id="label">[[itemLabel]]</h3>
              </template>
            </template>

            <template is="dom-if" if="[[!itemLabel]]" restamp="true">
              <template is="dom-if" if="[[!admin]]" restamp="true">
                <h3 id="label">Add Label</h3>
              </template>
            </template>

            <template is="dom-if" if="[[admin]]" restamp="true">
              <paper-input id="data-label" placeholder="Label" value="{{item.label::change}}" disabled$="[[!admin]]" no-label-float></paper-input>
            </template>
          </div>

          <div id="item-descripton">
            <template is="dom-if" if="[[item.description]]" restamp="true">
              <template is="dom-if" if="[[!admin]]" restamp="true">
                <p id="description">[[item.description]]</p>
              </template>
            </template>

            <template is="dom-if" if="[[!item.description]]" restamp="true">
              <template is="dom-if" if="[[!admin]]" restamp="true">
                <p id="description">Add Description</p>
              </template>
            </template>

            <template is="dom-if" if="[[admin]]" restamp="true">
              <paper-textarea id="data-description" placeholder="Description" value="{{item.description::change}}" disabled$="[[!admin]]" no-label-float="true" on-changeFFF="_productDescriptionChange" rows="2" max-rows="2" styleFFFF="width: 190px;"></paper-textarea>
            </template>
          </div>
        </template>

        <!-- <div class="horizontal layout center body-item package">
          <package-symbol item="[[item]]"></package-symbol>

          <a href="[[_getCategoryLink(item.category)]]">[[item.category]]</a>
        </div> -->
        <!-- Ma He SoSo Sc Hi Lang -->
        <template is="dom-if" if="[[item.tagsArray.length]]" restamp="true" as="tag">
          <div id="item-tags" class="body-item">

            <!-- <iron-icon icon="maps:local-offer" class="flex-none"></iron-icon> -->
            <template is="dom-repeat" items="[[item.tagsArray]]" as="tag">
              <a is="app-link" class="item-tag" href="[[_computeTagLink(tag)]]">
                <!-- active$="[[_tagActive(tag,view)]]" -->
                s
                <span>#[[tag.label]]</span>
              </a>
              <!-- <template is="dom-if" if="{{admin}}" restamp="true">
              <paper-button on-tap="_tap">[[tag.label]]</paper-button>
            </template> -->
              <!-- <template is="dom-if" if="{{!admin}}" restamp="true">
              <paper-input value="{{tag.label}}">
                <paper-icon-button icon="clear" suffix on-tap=""></paper-icon-button>
              </paper-input>
            </template> -->
            </template>
          </div>
        </template>
      </a>
    </div>

  </template>
</dom-module>

<script>
  (function() {

    function goDeep(obj, path) {
      var parts = path.split('.'),
        rv,
        index;
      for (rv = obj, index = 0; rv && index < parts.length; ++index) {
        rv = rv[parts[index]];
      }
      return rv;
    }


    var sharedActionMenu = null;
    var activeCard = null;

    function mouseEnter() {
      if (activeCard) {
        activeCard.showActions();
      }
    }

    function mouseLeave() {
      if (activeCard) {
        activeCard.hideActions();
      }
    }

    Polymer({
      is: 'element-card',
      enableCustomStyleProperties: true,
      properties: {
        // Data
        item: {
          type: Object,
          notify: true
        },
        itemKey: String,
        // #Label
        labelPath: {
          type: String,
          value: 'item.label'
        },
        itemLabel: {
          type: String,
          // notify: true,
          value: ''
        },
        // #Media
        mediaPath: {
          type: String,
          value: 'item.src'
        },
        mediaSrc: {
          type: String,
          // notify: true,
          value: ''
        },
        // View
        view: String,
        body: {
          type: Boolean,
          value: true
        },
        sizing: {
          type: String,
          value: 'cover'
        },
        admin: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_computeView(view)',
        '_computeItemLabel(item, labelPath)',
        '_computeMediaSrc(item, mediaPath)',
        // '_checkItem(_item)',
      ],
      _checkItem: function(item) {
        this.set('item', item);
        console.log(this.item.tags);
      },

      _computeItemLabel: function(item, labelPath) {
        if (labelPath) {
          var label = goDeep(item, labelPath.split('item.')[1]);
          // console.log(_labelpath);
          this.set('itemLabel', label);
          return;
        }
        this.set('itemLabel', 'No Label');
      },

      _computeMediaSrc: function(item, mediaPath) {
        var _mediaPath = mediaPath.split('item.')[1];
        this.set('mediaSrc', goDeep(item, _mediaPath));
      },

      _productDescriptionChange: function(e) {
        // console.log(e.model.item);
        var item = e.model.item;
        var _edit = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/products/' + item.key + '/'));
        item.key = null;
        _edit.set(item);
      },

      _computeView: function(view) {
        // console.log(view);
        if (view === 'poster') {
          this.body = false;
          // this.sizing = 'contain';
          // this.updateStyles();
        }

        if (view === 'wide') {
          this.$.hero.classList.add('wide');
          // this.sizing = 'contain';
          // this.updateStyles();
        }

      },

      attached: function() {
        this.style.opacity = 0;

        this.async(function() {
          this.style.opacity = 1;
        }, 1);
      },

      detached: function() {
        if (activeCard === this) {
          activeCard = null;
          if (sharedActionMenu) {
            Polymer.dom(this.parentNode).removeChild(sharedActionMenu);
            sharedActionMenu = null;
          }
        }
      },

      _tagClicked: function(e) {
        e.stopPropagation();
        this.fire('update-params', {
          tag: e.currentTarget.name
        });
      },
      _computeStyle: function(color) {
        return 'background-color:' + color;
      },
      _getItemLink: function(_key) {
        if (this.item.key) {
          return '/products/' + _key;
        }

      },
      _getImageSrc: function(item) {
        if (!item.media) {
          return '/images/hero/random-' + Math.ceil(Math.random() * 4) + '.svg';
        }

        // return '/images/hero/random-4.svg';
        // return 'https://i1.sndcdn.com/artworks-000141692329-15r585-t500x500.jpg';
        // return 'https://www.cinematerial.com/media/posters/md/cr/cr6n9ota.jpg?v=1448549115';
      },

      _getCategoryLink: function(category) {
        // + '&view=cards';
        var link = '/?category=' + category;
        return link;
      },

      _computeTagLink: function(tag) {
        // console.log(tag);
        // + '&view=cards';
        return '/?tag=' + tag.short;
      },

      showActions: function() {
        // console.dir(this.$.hero);
      },

      hideActions: function() {

      },

      showActions_old: function() {
        var top = this.$.hero.offsetTop;
        var left = this.$.hero.offsetLeft;
        var width = this.$.hero.offsetWidth;




        if (!sharedActionMenu) {
          sharedActionMenu = document.createElement('element-action-menu');
          sharedActionMenu.classList.add('cards');
          sharedActionMenu.classList.add('hidden');
          sharedActionMenu.addEventListener('mouseenter', mouseEnter);
          sharedActionMenu.addEventListener('mouseleave', mouseLeave);
        }
        if (!sharedActionMenu.parentNode) {
          Polymer.dom(this.parentNode).appendChild(sharedActionMenu);
        }

        // top += this.$.hero.offsetHeight - sharedActionMenu.offsetHeight;
        console.log('Top: ', top);

        sharedActionMenu.element = this.item.name;
        sharedActionMenu.style.top = top + 'px';
        sharedActionMenu.style.left = left + 'px';
        sharedActionMenu.style.width = width + 'px';

        this._layoutIfNeeded(sharedActionMenu);
        sharedActionMenu.classList.remove('hidden');
        this.classList.add('hover');
        sharedActionMenu.cancelDebouncer('hide');
      },

      hideActions_old: function() {
        if (sharedActionMenu && sharedActionMenu.element == this.item.name) {
          sharedActionMenu.debounce('hide', function() {
            sharedActionMenu.classList.add('hidden');
          }, 10);
          this.classList.remove('hover');
        }
      },

      _mouseEnter: function() {
        activeCard = this;
        mouseEnter();
      },

      _mouseLeave: function(e) {
        mouseLeave();
      },

      _layoutIfNeeded: function(el) {
        return el.offsetTop;
      }
    });

  })();
</script>
