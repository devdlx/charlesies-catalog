<dom-module id="catalog-product">
  <template>
    <!-- <catalog-data product-map="{{_products}}"></catalog-data> -->
    <firebase-document id="catalogProoductDetails" location$="[[_productLocation(byId)]]" data="{{_productDetails}}" on-firebase-value="_computeProductDetails"></firebase-document>
  </template>
  <script>
    var _defaultProduct = {}; //= {
    //   ".sv": "timestamp"
    // };
    _defaultProduct.status = 0;
    _defaultProduct.price = 0;
    _defaultProduct.title = "New";

    Polymer({
      is: 'catalog-product',
      properties: {

        byId: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },
        // Product Reference
        productDetails: {
          type: Object,
          notify: true
        },

        // Product References
        images: {
          type: Array,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
        },

        categories: {
          type: Array,
          notify: true
        },

        // Final Product
        data: {
          type: Object,
          notify: true,
          // computed: 'getData(_media, _categories, _options)'
        },
        edit: {
          type: Object,
          notify: true
        }

      },

      observers: [
        '_computeImages(productDetails)',
        '_computeCategories(productDetails)',
        '_computeProductOptions(productDetails)',
        'getData(images, categories, options)',
        '_edit(edit.*)',
        '_options(data.options.*)',
      ],


      // Categories

      _computeCategories: function(snap) {
        // console.log('loading ' + snap.key() + '\'s categories');
        if (this.saving) {
          // console.log('saving');
          // this.saving = false;
          return;
        }

        if (snap.err || typeof snap.val().categories === 'undefined') {
          this.set('categories', false);
          return;
        }

        var _productDetails = snap.val();
        // console.log(this.addImage(_image));
        this.set('categories', []);
        // var imageKeys = Object.keys(_productDetails.categoriesById).sort();
        var categories = [];
        for (var key in _productDetails.categoriesById) {
          // console.log(key);
          snap.ref().root().child('/categories/' + key).once('value', function(dataSnapshot) {
            // console.log(dataSnapshot.val());
            categories.push(dataSnapshot.val());
          });
        }

        this.debounce('_computeCategoriesFFFF', function() {
          this.set('categories', categories);
          // console.log(this.categories);
        }, 600);

      },

      // Images

      addImageAtomicGoogleDrive: function(image) {
        // this.push('images', image);
        var byId = this.byId;
        var urlRef = 'https://charlesiesbeta.firebaseio.com';
        var ref = new Firebase(urlRef);
        var updates = {};
        var imageId = image.id;

        // ref.child('/images/' + imageId).once('value', function(snapshot) {
        //   // console.log(snapshot.exists());
        //   if (!snapshot.exists()) {
        //     // imageId = ref.push(image).key();
        //     ref.child('/images/' + imageId).set(image);
        //   }
        //   updates['/images/' + imageId + '/productById/' + byId] = true;
        //   updates['/products/' + byId + '/mediaById/' + imageId] = true;
        //   ref.update(updates);
        //   return ref.child('images').child(imageId);
        // });


        ref.child('/images/').orderByChild('key').equalTo(imageId).once('value', function(snap) {
          // console.log(snap.exists());
          var val = snap.val();
          var key;

          if (snap.exists()) {
            // the image exist, update
            console.log('the image exist, update!');
            // console.log(snap.val());
            for (var key in val) {
              updates['/images/' + key + '/productById/' + byId] = true;
              updates['/products/' + byId + '/mediaById/' + key] = true;
              ref.update(updates);
            }
          } else {
            // add new image
            console.log('add new image');
            var obj = {};
            obj.src = image.webContentLink;
            obj.key = imageId;
            key = ref.child('/images/').push(obj).key();
            // console.log(key);
          }

          this.debounce('push_image', function(argument) {
            updates['/images/' + key + '/productById/' + byId] = true;
            updates['/products/' + byId + '/mediaById/' + key] = true;
            ref.update(updates);
          });

        }.bind(this));

      },


      _updateMediaRef: function(key, remove) {
        console.log('update references');
        var value = true;
        if (remove) {
          value = false;
        }
        var byId = this.byId;
        var updates = {};

        updates['/media/' + key + '/productById/' + byId] = value;
        updates['/products/' + byId + '/mediaById/' + key] = value;
        var rootRef = new Fireproof(new Firebase('https://charlesiesbeta.firebaseio.com/'));
        rootRef.update(updates);

        // console.log('/images/' + key + '/productById/' + byId);
      },

      addImageAtomicInstagram: function(_media) {

        if (!_media.length) return;


        var promises = [];

        var byId = this.byId;
        var updates = {};

        var mediaRef = new Fireproof(new Firebase('https://charlesiesbeta.firebaseio.com/media'));


        _media.forEach(function(e) {
          console.log(e.id);
          promises.push(mediaRef.orderByChild('id').equalTo(e.id).limitToFirst(1).then(function(snap) {
            console.log(e.id);
            // console.log(snap.val());
            // console.log(instagramPic);
            var val = snap.val();
            if (!val) {
              console.log('Adding...');
              // console.log(instagramPic);
              // this._updateMediaRef(mediaRef.push(instagramPic).key(), false);
              mediaId = mediaRef.push(e).key();
              console.log(mediaId);
            } else {
              console.log('Updating...');
              // console.log(Object.keys(val)[0]);
              // val.__firebaseKey__ = Object.keys(val)[0];
              // this._updateMediaRef(Object.keys(val)[0], false);
              mediaId = Object.keys(val)[0];
              // console.log(mediaId);
              console.log(snap.val().id);
            }
          }.bind(this)).then(function(argument) {
            updates['/media/' + mediaId + '/productById/' + byId] = true;
            updates['/products/' + byId + '/mediaById/' + mediaId] = true;
          }));
        }, this);

        Promise.all(promises).then(function(dataArr) {
          console.log('updating refs...');
          // console.log(updates);
          mediaRef.root().update(updates);
        }).catch(function(err) {
          console.log(err);
        });

      },

      addImageGoogleDrive: function(images) {
        return this.addImageAtomicGoogleDrive(images);
      },

      addImageInstagram: function(images) {
        return this.addImageAtomicInstagram(images);
      },

      removeImageAtomic: function(imageKey) {
        var byId = this.byId;
        var urlRef = 'https://charlesiesbeta.firebaseio.com';
        var ref = new Firebase(urlRef);
        // var updates = {};
        // updates['/images/' + imageKey + '/productById/' + byId] = null;
        // updates['/products/' + byId + '/mediaById/' + imageKey] = null;
        // ref.update(updates);
        return true;
      },

      removeImage: function(imageId) {
        return this.addImageAtomic(imageId);
      },

      _computeImages: function(snap) {
        // console.log('loading images for ', snap.key());

        if (snap.err || typeof snap.val().mediaById === 'undefined') {
          // this.images = this._media;
          console.log(snap.val());
          this.set('images', []);
          return;
        }
        var _productDetails = snap.val();
        // console.log(typeof _productDetails.mediaById=== 'undefined');
        // var imageKeys = Object.keys(_productDetails.mediaById).sort();
        var imageKeys = Object.keys(_productDetails.mediaById);
        // console.log(imageKeys);
        var images = [];
        for (var i = 0; i < imageKeys.length; i++) {
          // console.log(imageKeys[i]);
          snap.ref().root().child('/media/' + imageKeys[i]).on('value', function(dataSnapshot) {
            // console.log(dataSnapshot.val());
            images.push(dataSnapshot.val());
          });
        }
        //      Throttle
        this.debounce('_computeImagesFFFF', function() {
          this.set('images', images);
          // console.log(this.images);
        }, 600);
      },

      // Options

      newOption: function() {
        var key = this.productDetails.child('options').ref().push({
          'label': '',
          'price': 0
        }).key();
        // console.log(key);
      },

      _computeProductOptions: function(snap) {
        if (this.saving) {
          // console.log('saving');
          this.saving = false;
          return;
        }
        if (snap.err) {
          this.set('options', []);
          return;
        }
        // console.log('loading options for ', this.productDetails.key());
        // console.log(snap.child('/options').val());
        if (!snap.child('/options').val()) {
          this.set('options', []);
          return;
        }
        var options = [],
          _options = snap.child('/options').val();
        for (var option in _options) {
          // console.log(_options[option]);
          _options[option].__firebaseKey__ = option;
          options.push(_options[option]);
        }
        this.set('options', options);
        // console.log(this.options);
      },

      _options: function(options) {
        // console.log('options', options.path);
        if (options.path === 'data.options') return;
        this.saving = true;
        var optionKey = options.path.split('#')[1].split('.');
        var option = options.base[optionKey[0]];
        this.productDetails.child('/options/' + option.__firebaseKey__).ref().update(option);
        // console.log(options.base);
      },

      removeOption: function(option) {
        console.log('removeOption', option);
        this.saving = true;
        this.productDetails.child('/options/' + option.__firebaseKey__).ref().remove();
      },


      // Product Tags

      newTag: function() {
        var byId = this.byId;
        var updates = {};

        var rootRef = new Fireproof(new Firebase('https://charlesiesbeta.firebaseio.com/'));
        var tagsRef = new Fireproof(new Firebase('https://charlesiesbeta.firebaseio.com/tags'));
        var tagId, newTag = {
          name: '',
          text: 'new'
        };

        tagId = tagsRef.push(newTag).key();
        updates['/tags/' + tagId + '/productById/' + byId] = true;
        updates['/products/' + byId + '/tagsById/' + tagId] = true;
        // console.log(updates);
        rootRef.update(updates);

      },

      // Product Details

      _productLocation: function(id) {
        // console.log('_productsLocation', "https://charlesiesbeta.firebaseio.com/products/" + id);
        // console.log('loading ' + id + ' details');
        return "https://charlesiesbeta.firebaseio.com/products/" + id;
      },


      _edit: function(edit) {
        // console.log('edit', edit.path);
        // this.set('edit', check.base);
        if (edit.path === 'edit') return;
        this.saving = true;
        this.productDetails.ref().update(edit.base);
        // console.log(this.productDetails);
      },


      _computeProductDetails: function(e, snap) {
        // console.log(snap.key());
        // this.set('productDetails', this._productDetails);
        if (snap.val()) {
          this.set('productDetails', snap);
        } else {
          var text = 'no product with id: ' + snap.key();
          this.set('productDetails', {
            err: text
          });
        }

      },

      new: function() {
        var urlRef = 'https://charlesiesbeta.firebaseio.com/products/';
        var ref = new Firebase(urlRef);
        var newProduct = ref.push(_defaultProduct);
        // newProduct.update(_defaultProduct);
        var key = newProduct.key();
        // this.byId = key;
        // console.log(newProduct);
        return key;
      },

      getData: function(_media, _categories, _options) {

        // console.log('getData', this.productDetails.key(), _media, _categories, _options);

        if (this.productDetails.err) {
          this.set('data', {});
          this.set('edit', {});
          this.fire('error', this.productDetails.err);
          return;
        }
        var _productDetails = this.productDetails.val();
        if (!_productDetails) {
          _productDetails = {
            err: {
              text: 'Product ' + this.btId + ' not found'
            }
          };
        }

        _productDetails.__firebaseKey__ = this.productDetails.key();
        _productDetails.images = _media;
        _productDetails.categories = _categories;
        _productDetails.options = _options;
        // console.log(_productDetails);
        this.set('data', _productDetails);
        this.set('edit', this._productDetails);
      }
    });
  </script>

</dom-module>
