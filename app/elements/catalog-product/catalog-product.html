<dom-module id="catalog-product">
  <template>
    <!-- <catalog-data product-map="{{_products}}"></catalog-data> -->
    <firebase-document id="catalogProoductDetails" location$="[[_productLocation(byId)]]" data="{{_productDetails}}" on-firebase-value="_computeProductDetails"></firebase-document>
  </template>
  <script>
    var _defaultProduct = {}; //= {
    //   ".sv": "timestamp"
    // };
    _defaultProduct.status = 0;
    _defaultProduct.price = 0;
    _defaultProduct.title = "New";

    Polymer({
      is: 'catalog-product',
      properties: {

        byId: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },
        // Product Reference
        productDetails: {
          type: Object,
          notify: true
        },
        _productdetails: {
          type: Object,
          notify: true
        },

        // Product References
        images: {
          type: Array,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
        },

        categories: {
          type: Array,
          notify: true
        },

        // Final Product
        data: {
          type: Object,
          notify: true,
          // computed: 'getData(_images, _categories, _options)'
        },
        edit: {
          type: Object,
          notify: true
        }

      },

      observers: [
        '_computeImages(productDetails)',
        '_computeCategories(productDetails)',
        '_computeProductOptions(productDetails)',
        'getData(images, categories, options)',
        '_edit(edit.*)',
        '_options(data.options.*)',
      ],


      // Categories

      _computeCategories: function(snap) {
        // console.log('loading ' + snap.key() + '\'s categories');
        if (this.saving) {
          // console.log('saving');
          // this.saving = false;
          return;
        }

        if (snap.err || typeof snap.val().categories === 'undefined') {
          this.set('categories', false);
          return;
        }

        var _productDetails = snap.val();
        // console.log(this.addImage(_image));
        this.set('categories', []);
        // var imageKeys = Object.keys(_productDetails.categoriesById).sort();
        var categories = [];
        for (var key in _productDetails.categoriesById) {
          // console.log(key);
          snap.ref().root().child('/categories/' + key).once('value', function(dataSnapshot) {
            // console.log(dataSnapshot.val());
            categories.push(dataSnapshot.val());
          });
        }

        this.debounce('_computeCategoriesFFFF', function() {
          this.set('categories', categories);
          // console.log(this.categories);
        }, 600);

      },

      // Images

      addImageAtomicGoogleDrive: function(image) {
        // this.push('images', image);
        var byId = this.byId;
        var urlRef = 'https://charlesiesbeta.firebaseio.com';
        var ref = new Firebase(urlRef);
        var updates = {};
        var imageId = image.id;

        // ref.child('/images/' + imageId).once('value', function(snapshot) {
        //   // console.log(snapshot.exists());
        //   if (!snapshot.exists()) {
        //     // imageId = ref.push(image).key();
        //     ref.child('/images/' + imageId).set(image);
        //   }
        //   updates['/images/' + imageId + '/productById/' + byId] = true;
        //   updates['/products/' + byId + '/imagesById/' + imageId] = true;
        //   ref.update(updates);
        //   return ref.child('images').child(imageId);
        // });

        var thiss = this;

        ref.child('/images/').orderByChild('key').equalTo(imageId).once('value', function(snap) {
          // console.log(snap.exists());
          var val = snap.val();
          var key;

          if (snap.exists()) {
            // the image exist, update
            console.log('the image exist, update!');
            // console.log(snap.val());
            for (var key in val) {
              updates['/images/' + key + '/productById/' + byId] = true;
              updates['/products/' + byId + '/imagesById/' + key] = true;
              ref.update(updates);
            }
          } else {
            // add new image
            console.log('add new image');
            var obj = {};
            obj.src = image.webContentLink;
            obj.key = imageId;
            key = ref.child('/images/').push(obj).key();
            // console.log(key);
          }

          thiss.debounce('push_image', function(argument) {
            updates['/images/' + key + '/productById/' + byId] = true;
            updates['/products/' + byId + '/imagesById/' + key] = true;
            ref.update(updates);
          });



        });

      },

      addImageAtomicInstagram: function(images) {
        // this.push('images', image);
        var byId = this.byId;
        var urlRef = 'https://charlesiesbeta.firebaseio.com';
        var ref = new Firebase(urlRef);
        var updates = {};

        for (var i = 0; i < images.length; i++) {
          console.log(images[i]);
          var imageId = image[i].id;
          var thiss = this;

          ref.child('/images/').orderByChild('key').equalTo(imageId).once('value', function(snap) {
            // console.log(snap.exists());
            var val = snap.val();
            var key;

            if (snap.exists()) {
              // the image exist, update
              console.log('the image exist, update!');
              // console.log(snap.val());
              for (var key in val) {
                updates['/images/' + key + '/productById/' + byId] = true;
                updates['/products/' + byId + '/imagesById/' + key] = true;
                ref.update(updates);
              }
            } else {
              // add new image
              console.log('add new image');
              var obj = {};
              obj.src = image.webContentLink;
              obj.key = imageId;
              key = ref.child('/images/').push(obj).key();
              // console.log(key);
            }

            thiss.debounce('push_image', function(argument) {
              updates['/images/' + key + '/productById/' + byId] = true;
              updates['/products/' + byId + '/imagesById/' + key] = true;
              ref.update(updates);
            });

          });


        }





      },

      addImageGoogleDrive: function(images) {
        return this.addImageAtomicGoogleDrive(images);
      },

      addImageInstagram: function(images) {
        return this.addImageAtomicInstagram(images);
      },

      removeImageAtomic: function(imageKey) {
        var byId = this.byId;
        var urlRef = 'https://charlesiesbeta.firebaseio.com';
        var ref = new Firebase(urlRef);
        var updates = {};
        updates['/images/' + imageKey + '/productById/' + byId] = null;
        updates['/products/' + byId + '/imagesById/' + imageKey] = null;
        ref.update(updates);
        return true;
      },

      removeImage: function(imageId) {
        return this.addImageAtomic(imageId);
      },

      _computeImages: function(snap) {
        // console.log('loading images for ', snap.key());
        if (this.saving) {
          // console.log('saving');
          this.saving = false;
          return;
        }

        if (snap.err || typeof snap.val().imagesById === 'undefined') {
          // this.images = this._images;
          this.set('images', false);
          return;
        }
        var _productDetails = snap.val();
        // console.log(typeof _productDetails.imagesById=== 'undefined');
        // var imageKeys = Object.keys(_productDetails.imagesById).sort();
        var imageKeys = Object.keys(_productDetails.imagesById);
        var images = [];
        for (var i = 0; i < imageKeys.length; i++) {
          // console.log(imageKeys[i]);
          snap.ref().root().child('/images/' + imageKeys[i]).orderByPriority().once('value', function(dataSnapshot) {
            images.push(dataSnapshot.val());
          });
        }
        // for (var key in _productDetails.imagesById) {
        //   // console.log(key);
        //   snap.ref().root().child('/images/' + key).once('value', function(dataSnapshot) {
        //     // console.log(dataSnapshot.val());
        //     images.push(dataSnapshot.val());
        //   });
        // }
        //      Throttle
        this.debounce('_computeImagesFFFF', function() {
          this.set('images', images);
          // console.log(this.images);
        }, 600);
      },

      // Options

      newOption: function() {
        var key = this.productDetails.child('options').ref().push({
          'label': '',
          'price': 0
        }).key();
        // console.log(key);
      },

      _computeProductOptions: function(snap) {
        if (this.saving) {
          // console.log('saving');
          this.saving = false;
          return;
        }
        if (snap.err) {
          this.set('options', []);
          return;
        }
        // console.log('loading options for ', this.productDetails.key());
        // console.log(snap.child('/options').val());
        if (!snap.child('/options').val()) {
          this.set('options', []);
          return;
        }
        var options = [],
          _options = snap.child('/options').val();
        for (var option in _options) {
          // console.log(_options[option]);
          _options[option].__firebaseKey__ = option;
          options.push(_options[option]);
        }
        this.set('options', options);
        // console.log(this.options);
      },

      _options: function(options) {
        // console.log('options', options.path);
        if (options.path === 'data.options') return;
        this.saving = true;
        var optionKey = options.path.split('#')[1].split('.');
        var option = options.base[optionKey[0]];
        this.productDetails.child('/options/' + option.__firebaseKey__).ref().update(option);
        // console.log(options.base);
      },

      removeOption: function(option) {
        console.log('removeOption', option);
        this.saving = true;
        this.productDetails.child('/options/' + option.__firebaseKey__).ref().remove();
      },

      // Product Details

      _productLocation: function(id) {
        // console.log('_productsLocation', "https://charlesiesbeta.firebaseio.com/products/" + id);
        // console.log('loading ' + id + ' details');
        return "https://charlesiesbeta.firebaseio.com/products/" + id;
      },


      _edit: function(edit) {
        // console.log('edit', edit.path);
        // this.set('edit', check.base);
        if (edit.path === 'edit') return;
        this.saving = true;
        this.productDetails.ref().update(edit.base);
        // console.log(this.productDetails);
      },


      _computeProductDetails: function(e, snap) {
        // console.log(snap.key());
        // this.set('productDetails', this._productDetails);
        if (snap.val()) {
          this.set('productDetails', snap);
        } else {
          var text = 'no product with id: ' + snap.key();
          this.set('productDetails', {
            err: text
          });
        }

      },

      new: function() {
        var urlRef = 'https://charlesiesbeta.firebaseio.com/products/';
        var ref = new Firebase(urlRef);
        var newProduct = ref.push({});
        newProduct.update(_defaultProduct);
        var key = newProduct.key();
        // this.byId = key;
        // console.log(newProduct);
        return key;
      },

      getData: function(_images, _categories, _options) {

        if (_images === true) return;

        // console.log('getData', this.productDetails.key(), _images, _categories, _options);

        if (this.productDetails.err) {
          this.set('data', false);
          this.set('edit', false);
          this.fire('error', this.productDetails.err);
          return;
        }
        var _productDetails = this.productDetails.val();
        if (!_productDetails) {
          _productDetails = {
            err: {
              text: 'Product ' + this.btId + ' not found'
            }
          };
        }

        _productDetails.__firebaseKey__ = this.productDetails.key();
        _productDetails.images = _images;
        _productDetails.categories = _categories;
        _productDetails.options = _options;
        // // console.log(_productDetails);
        this.set('data', _productDetails);
        this.set('edit', this._productDetails);
      }
    });
  </script>

</dom-module>
