<dom-module id="catalog-product">
  <template>
    <!-- <catalog-data product-map="{{_products}}"></catalog-data> -->
    <firebase-document id="catalogProoductDetails" location$="[[_productLocation(byId)]]" data="{{_productDetails}}" on-firebase-value="_computeProductDetails"></firebase-document>
  </template>
  <script>
    var _defaultProduct = {}; //= {
    //   ".sv": "timestamp"
    // };
    _defaultProduct.status = 0;
    _defaultProduct.price = 0;
    _defaultProduct.title = "New";

    var _oldById = '';

    Polymer({
      is: 'catalog-product',
      properties: {

        loading: {
          type: Boolean,
          notify: true,
          // computed: '_detectChange(byId)',
          // reflectToAttribute: true
        },

        byId: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },
        // Product Reference
        productDetails: {
          type: Object,
          notify: true
        },

        // Product References
        media: {
          type: Array,
          notify: true,
        },

        options: {
          type: Array,
          notify: true,
        },

        categories: {
          type: Array,
          notify: true
        },

        // Final Product
        data: {
          type: Object,
          notify: true,
          // computed: 'getData(_media, _categories, _options)'
        },
        edit: {
          type: Object,
          notify: true
        }

      },

      observers: [
        '_computeMedia(productDetails)',
        '_computeCategories(productDetails)',
        '_computeProductOptions(productDetails)',
        'getData(media,categories, options)',
        '_edit(edit.*)',
        '_options(data.options.*)'
      ],


      _detectChange: function(byId) {
        console.log(byId, _oldById);
        if (byId !== _oldById && _oldById !== '') {
          _oldById = byId;
          return true;
        }
      },


      // Categories

      _computeCategories: function(snap) {
        // console.log('loading ' + snap.key() + '\'s categories');

        if (snap.err || typeof snap.val().categories === 'undefined') {
          this.set('categories', []);
          return;
        }

        var _productDetails = snap.val();
        // console.log(this.addImage(_image));
        // var imageKeys = Object.keys(_productDetails.categoriesById).sort();
        var categories = [];
        for (var key in _productDetails.categoriesById) {
          // console.log(key);
          snap.ref().root().child('/categories/' + key).once('value', function(dataSnapshot) {
            // console.log(dataSnapshot.val());
            categories.push(dataSnapshot.val());
          });
        }

        this.debounce('_computeCategoriesFFFF', function() {
          this.set('categories', categories);
          // console.log(this.categories);
        }, 600);

      },

      // Images

      addImageAtomicGoogleDrive: function(image) {
        // this.push('images', image);
        var byId = this.byId;
        var urlRef = 'https://charlesiescom.firebaseio.com';
        var ref = new Firebase(urlRef);
        var updates = {};
        var imageId = image.id;

        // ref.child('/images/' + imageId).once('value', function(snapshot) {
        //   // console.log(snapshot.exists());
        //   if (!snapshot.exists()) {
        //     // imageId = ref.push(image).key();
        //     ref.child('/images/' + imageId).set(image);
        //   }
        //   updates['/images/' + imageId + '/productById/' + byId] = true;
        //   updates['/products/' + byId + '/mediaById/' + imageId] = true;
        //   ref.update(updates);
        //   return ref.child('images').child(imageId);
        // });


        ref.child('/images/').orderByChild('key').equalTo(imageId).once('value', function(snap) {
          // console.log(snap.exists());
          var val = snap.val();
          var key;

          if (snap.exists()) {
            // the image exist, update
            console.log('the image exist, update!');
            // console.log(snap.val());
            for (var key in val) {
              updates['/images/' + key + '/productById/' + byId] = true;
              updates['/products/' + byId + '/mediaById/' + key] = true;
              ref.update(updates);
            }
          } else {
            // add new image
            console.log('add new image');
            var obj = {};
            obj.src = image.webContentLink;
            obj.key = imageId;
            key = ref.child('/images/').push(obj).key();
            // console.log(key);
          }

          this.debounce('push_image', function(argument) {
            updates['/images/' + key + '/productById/' + byId] = true;
            updates['/products/' + byId + '/mediaById/' + key] = true;
            ref.update(updates);
          });

        }.bind(this));

      },


      _updateMediaRef: function(key, remove) {
        // console.log('update references');
        var value = true;
        if (remove) {
          value = false;
        }
        var byId = this.byId;
        var updates = {};

        updates['/media/' + key + '/productById/' + byId] = value;
        updates['/products/' + byId + '/mediaById/' + key] = value;
        var rootRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/'));
        rootRef.update(updates);

        // console.log('/media/' + key + '/productById/' + byId);
      },

      readyParse: function() {
        var script = document.createElement('script');
        script.src = 'https://parse.com/downloads/javascript/parse-1.6.12.min.js';
        script.onload = function() {
          // console.log('loaded');
          Parse.initialize("jKezwNz4AfEGU4UGLq82XsSqrlmjqkCGEaZSyXlr", "3ZZYwFQbXB42ee369XIEjgk37qo5W6hF2RYaCQIC");
        };

        document.head.appendChild(script);
      },

      addImageAtomicInstagramParse: function(_media) {
        // Parse
        if (!_media.length) return;

        // console.log(_media);
        // console.log(this._product);

        var _pro = this._product;

        var MediaObject = Parse.Object.extend("MediaObject");


        _media.forEach(function(item) {

          var query = new Parse.Query(MediaObject);
          query.equalTo("instagram_id", item.id);
          query.first({
            success: function(media_object) {
              // console.dir(media_object);
              if (!media_object) {
                // Save new media
                // console.log(item);
                item.instagram_id = item.id;
                item.id = null;
                item.media_type = 'instagram';

                var instgramMedia = new MediaObject();
                var relation = instgramMedia.relation("products_byId");
                relation.add(_pro);
                instgramMedia.save(item).then(function(e) {
                  // console.log(e);
                  console.log('saved new media', e.id);
                });
              } else {
                // Update media
                // console.log(media_object);

                query.get(media_object.id, {
                  success: function(item) {
                    var relation = media_object.relation("products_byId");
                    relation.add(_pro);
                    media_object.save();
                    console.log(item);
                    console.log('updated media', item.id);
                  },

                  error: function(object, error) {
                    console.log("ERROR: ", error);
                  }
                });


              }
            },
            error: function(error) {
              alert("Error: " + error.code + " " + error.message);
            }
          });

        });
      },

      addImageAtomicInstagramReferences: function(_media) {
        // FIREBASE
        // console.log(_media);

        if (!_media.length) return;

        var promises = [];

        var byId = this.byId;
        var updates = {};

        var mediaRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/media'));

        _media.forEach(function(e) {
          // console.log(e.link);
          promises.push(mediaRef.orderByChild('id').equalTo(e.id).limitToFirst(1).then(function(snap) {
            // console.log(e.link);
            // console.log(snap.val());
            // console.log(instagramPic);
            var val = snap.val();
            if (!val) {
              console.log('Adding...');
              // console.log(instagramPic);
              // this._updateMediaRef(mediaRef.push(instagramPic).key(), false);
              // mediaId = mediaRef.push(e).key();
              // console.log(mediaId);
              this._updateMediaRef(mediaId = mediaRef.push(e).key());
            } else {
              console.log('Updating...');
              // console.log(Object.keys(val)[0]);
              // val.__firebaseKey__ = Object.keys(val)[0];
              // this._updateMediaRef(Object.keys(val)[0], false);
              // mediaId = Object.keys(val)[0];
              // console.log(mediaId);
              this._updateMediaRef(Object.keys(val)[0]);
              // console.log(snap.val().id);
            }
          }.bind(this)).then(function(argument) {
            // updates['/media/' + mediaId + '/productById/' + byId] = true;
            // updates['/products/' + byId + '/mediaById/' + mediaId] = true;
            // console.log(mediaId);
          }));
        }, this);

        Promise.all(promises).then(function(dataArr) {
          // console.log('updating refs...');
          // console.log(updates);
          // mediaRef.root().update(updates);
        }).catch(function(err) {
          console.log(err);
        });

      },
      addImageAtomicInstagram: function(_media) {
        // FIREBASE
        // console.log(_media);

        if (!_media.length) return;

        var promises = [];

        var byId = this.byId;
        var updates = {};

        var mediaRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/products/' + this.byId + '/media/'));
        console.log(this._productDetails);

        _media.forEach(function(e) {
          // console.log(e.link);
          mediaRef.orderByChild('id').equalTo(e.id).limitToFirst(1).then(function(snap) {
            // console.log(snap.val());
            var val = snap.val();
            if (!val) {
              console.log('Adding...');
              // console.log(instagramPic);
              // this._updateMediaRef(mediaRef.push(instagramPic).key(), false);
              // mediaId = mediaRef.push(e).key();
              // console.log(mediaId);
              mediaRef.push(e).key();
            } else {
              console.log('Already Added');
            }
          }.bind(this));
        });



      },

      addImageGoogleDrive: function(images) {
        return this.addImageAtomicGoogleDrive(images);
      },

      addImageInstagram: function(images) {
        return this.addImageAtomicInstagram(images);
      },

      removeImageAtomic: function(imageKey) {
        var byId = this.byId;
        var urlRef = 'https://charlesiescom.firebaseio.com';
        var ref = new Firebase(urlRef);
        // var updates = {};
        // updates['/images/' + imageKey + '/productById/' + byId] = null;
        // updates['/products/' + byId + '/mediaById/' + imageKey] = null;
        // ref.update(updates);
        return true;
      },

      removeImageFirebaseReference: function(imageId) {
        return this.addImageAtomic(imageId);
      },

      removeMedia: function(mediaKey) {

      },

      _computeMediaFirebaseReferences: function(snap) {
        // console.log('loading media for ', snap.key());
        if (snap.err || typeof snap.val().mediaById === 'undefined') {
          // console.log(snap.val());
          this.set('media', []);
          return;
        }
        var _productDetails = snap.val();
        // console.log(typeof _productDetails.mediaById=== 'undefined');
        // var imageKeys = Object.keys(_productDetails.mediaById).sort();
        // var imageKeys = Object.keys(_productDetails.mediaById);
        // console.log(imageKeys);
        // var images = [];
        // for (var i = 0; i < imageKeys.length; i++) {
        //   // console.log(imageKeys[i]);
        //   snap.ref().root().child('/media/' + imageKeys[i]).on('value', function(dataSnapshot) {
        //     // console.log(dataSnapshot.val());
        //     images.push(dataSnapshot.val());
        //   });
        // }
        //      Throttle
        // this.debounce('_computeMediaFFFF', function() {
        //   this.set('images', images);
        //   // console.log(this.images);
        // }, 600);


        var productKey = snap.key();
        var refPath = 'productById' + productKey;
        var mediaKeys = Object.keys(_productDetails.mediaById);
        var promises = [];
        var _media = [];

        var mediaRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/media/'));
        // console.log(mediaKeys);

        for (var mediaId in mediaKeys) {
          if (mediaKeys.hasOwnProperty(mediaId)) {
            // console.log(mediaKeys[mediaId]);
            promises.push(
              mediaRef.child(mediaKeys[mediaId]).then(function(e) {
                // console.log(e.val());
                _media.push(e.val());
              })
            );
          }
        }

        Promise.all(promises).then(function(dataArr) {
          // console.log('images, ', dataArr);
          // console.log(_media);
          this.set('media', []);
          this.set('media', _media);
        }.bind(this)).catch(function(err) {
          console.log(err);
        });

      },


      _computeMedia: function(snap) {

        if (snap.err || typeof snap.val().media === 'undefined') {
          // console.log(snap.val());
          this.set('media', []);
          return;
        } else {
          var _productDetails = snap.val();
          var mediaArray = [];
          // console.log(_productDetails);

          var mediaRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/products/' + this.byId + '/media/'));
          // console.log(mediaKeys);
          mediaRef.then(function(mediaSnap) {
            var mediaKeys = mediaSnap.val();
            // console.log(mediaKeys);
            for (var mediaId in mediaKeys) {
              if (mediaKeys.hasOwnProperty(mediaId)) {
                // console.log(mediaKeys[mediaId]);
                mediaArray.push(mediaKeys[mediaId]);
              }
            }
            this.set('media', mediaArray);

          }.bind(this));


        }

      },

      // Options

      newOption: function() {
        var key = this.productDetails.child('options').ref().push({
          'label': '',
          'price': 0
        }).key();
        // console.log(key);
      },

      _computeProductOptions: function(snap) {
        if (this.saving) {
          // console.log('saving');
          this.saving = false;
          return;
        }
        if (snap.err) {
          this.set('options', []);
          return;
        }
        // console.log('loading options for ', this.productDetails.key());
        // console.log(snap.child('/options').val());
        if (!snap.child('/options').val()) {
          this.set('options', []);
          return;
        }
        var options = [],
          _options = snap.child('/options').val();
        for (var option in _options) {
          // console.log(_options[option]);
          _options[option].__firebaseKey__ = option;
          options.push(_options[option]);
        }
        this.set('options', options);
        // console.log(this.options);
      },

      _options: function(options) {
        // console.log('options', options.path);
        if (options.path === 'data.options') return;
        // this.saving = true;
        var optionKey = options.path.split('#')[1].split('.');
        var option = options.base[optionKey[0]];
        this.productDetails.child('/options/' + option.__firebaseKey__).ref().update(option);
        // console.log(options.base);
      },

      removeOption: function(option) {
        // console.log('removeOption', option);
        // this.saving = true;
        this.productDetails.child('/options/' + option.__firebaseKey__).ref().remove();
      },


      // Product Tags

      newTag: function() {
        var byId = this.byId;
        var updates = {};

        var rootRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/'));
        var tagsRef = new Fireproof(new Firebase('https://charlesiescom.firebaseio.com/tags'));
        var tagId, newTag = {
          name: '',
          text: 'new'
        };

        tagId = tagsRef.push(newTag).key();
        updates['/tags/' + tagId + '/productById/' + byId] = true;
        updates['/products/' + byId + '/tagsById/' + tagId] = true;
        // console.log(updates);
        rootRef.update(updates);

      },


      removeTag: function(tag) {
        // console.log('removeOption', option);
        // this.saving = true;
        // this.productDetails.child('/tags/' + tags.__firebaseKey__).ref().remove();
      },

      // Product Details

      _productLocation: function(id) {
        // console.log('_productsLocation', "https://charlesiescom.firebaseio.com/products/" + id);
        // console.log('loading ' + id + ' details');
        return "https://charlesiescom.firebaseio.com/products/" + id;
      },


      _edit: function(edit) {
        // console.log('edit', edit.path);
        // this.set('edit', check.base);
        if (edit.path === 'edit') return;
        this.saving = true;
        this.productDetails.ref().update(edit.base);
        // console.log(this.productDetails);
      },


      _computeProductDetails: function(e, snap) {
        // console.log(snap.key());
        // this.set('productDetails', this._productDetails);
        if (snap.val()) {
          this.set('productDetails', snap);
        } else {
          var text = 'no product with id: ' + snap.key();
          this.set('productDetails', {
            err: text
          });
        }

      },

      new: function() {
        var urlRef = 'https://charlesiescom.firebaseio.com/products/';
        var ref = new Firebase(urlRef);
        var newProduct = ref.push(_defaultProduct);
        // newProduct.update(_defaultProduct);
        var key = newProduct.key();
        // this.byId = key;
        // console.log(newProduct);
        return key;
      },

      getData: function(_media, _categories, _options) {
        // console.log('getData', this.productDetails.key(), _media, _categories, _options);

        if (this.productDetails.err) {
          this.set('data', {});
          this.set('edit', {});
          this.fire('error', this.productDetails.err);
          return;
        }
        var _productDetails = this.productDetails.val();
        if (!_productDetails) {
          _productDetails = {
            err: {
              text: 'Product ' + this.btId + ' not found'
            }
          };
        }

        _productDetails.__firebaseKey__ = this.productDetails.key();
        _productDetails.images = _media;
        _productDetails.categories = _categories;
        _productDetails.options = _options;
        // console.log(_productDetails);
        this.set('loading', false)
        this.set('data', _productDetails);
        this.set('edit', this._productDetails);


        // Parse last min add-on

        // var Product = Parse.Object.extend("Products");
        //
        // var pquery = new Parse.Query(Product);
        // var jjj = pquery.get('vTfMIVc1bc', {
        //   success: function(item) {
        //     // console.log(item);
        //     this.set('_product', item);
        //   }.bind(this),
        //
        //   error: function(object, error) {
        //     console.log("ERROR: ", error);
        //   }
        // });


      }
    });
  </script>

</dom-module>
