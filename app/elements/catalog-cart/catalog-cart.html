<link rel="import" href="../catalog-product/catalog-product.html">

<script>
  (function() {
    var _instances = [];

    var _store = function() {
      if (_instances.length) {
        localStorage['catalog.cart'] = JSON.stringify(_instances[0].items);
      }
      // console.log(localStorage['catalog.cart']);
    };

    var _clear = function() {
      if (_instances.length) {
        localStorage['catalog.cart'] = [];
      }
    };

    var _retrieve = function() {
      try {
        return JSON.parse(localStorage['catalog.cart'] || '[]');
      } catch (e) {
        console.log('error retrieving catalog data from localstorage.', e);
        return [];
      }
    };

    var _add = function(product) {
      var check = _instances[0];
      var insertAt = 0;

      // var el = document.createElement('catalog-product');
      // el.id = _product.__firebaseKey__;
      // console.dir(_product);
      // if (!el.data) {
      //   return;
      // }
      // var product = el.data;

      for (var i = 0; i < check.items.length; i++) {
        // console.log(check.items[i].__firebaseKey__);
        if (check.items[i].__firebaseKey__ === product.__firebaseKey__) {
          // console.log('product match');
          check.items[i].quantity++;
          _store();
          _updateAll();
          // console.log(check.items[i].quantity);
          // console.log(check);
          return;
        }
      }

      product.quantity = 1;

      _instances.forEach(function(instance) {
        instance.splice('items', insertAt, 0, product);
        instance.fire('item-added', product, {
          bubbles: false
        });
      });

      _store();

      return product;
    };

    var _remove = function(product_index) {
      var check = _instances[0];
      var removeAt = product_index;
      // for (var i = 0; i < check.items.length; i++) {
      //   if (check.items[i] === product || check.items[i].name === product.name) {
      //     removeAt = i;
      //   }
      // }

      if (removeAt >= 0) {
        _instances.forEach(function(instance) {
          instance.splice('items', removeAt, 1);
          instance.fire('item-removed', product_index, {
            bubbles: false
          });
        });
        _store();
      } else {
        return false;
      }
    };


    var _updateAll = function() {
      _instances.forEach(function(instance) {
        // instance.items = _instances[0].items;
        instance.Update();
      });

    };


    Polymer({
      is: 'catalog-cart',
      properties: {
        items: {
          type: Array,
          notify: true,
          value: function() {
            return _retrieve();
          }
        },
        count: {
          type: Number,
          notify: true,
          computed: '_count(items.splices)'
        }
      },

      observers: [
        // '_save(items.*)'
      ],

      clear: function() {
        _clear();
        _updateAll();
      },

      created: function() {
        _instances.push(this);
      },
      Update: function() {
        this.items = _retrieve();
      },
      addCart: function(item) {
        // if (this.includes(name)) return false;
        return _add(item);
      },
      removeCart: function(item) {
        return _remove(item);
      },
      _count: function(items) {
        return this.items.length;
      },
      _save: function(changes) {
        // console.log('_save: ', changes);
        // console.log(changes.path.split('.'));
        var path = changes.path.split('.');
        // console.log(path[2]); // = "quantity"

        if (path[2]) {
          var check = _instances[0];
          // console.log(check.items[path[1]]);
          check.items[path[1]].quantity = changes.value;
          _updateAll();
          _store();
        }

      }
    });
  })();
</script>
