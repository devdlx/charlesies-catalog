<dom-module id="app-shell">
  <template>

    <style is="custom-style">
      :host {
        @apply(--app-shell);
      }

      #appToolbar {
        @apply(--app-toolbar);
      }

      #appToolbar a {
        @apply(--app-toolbar-link);
      }

      #btnCartx {
        margin-right: 16px;
        margin-top: 16px;
      }

      .cartBadge {
        --paper-badge-background: var(--accent-color);
        --paper-badge-text-color: white;
      }

      #appToolbar paper-icon-button[icon=menu] {
        margin-right: 8px;
      }

      paper-icon-button.userIcon::shadow img {
        border-radius: 50%;
      }

      #menu {
        /*box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.16);*/
        /*height: 100%;*/
        border-right: 1px solid #e7e7e7
      }

      paper-toast {
        z-index: 1;
      }
    </style>

    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{user}}"></catalog-user>
    <catalog-cart id="catalogCart" items="{{cart}}" count="{{cartCount}}"></catalog-cart>

    <iron-media-query query="(min-width: 705px)" query-matches="{{narrow}}"></iron-media-query>
    <!-- <firebase-collection id="category" location="https://charlesiesbeta.firebaseio.com/categories" data="{{categories}}" order-by-child="showInNav" equal-to="true" on-firebase-value="check"></firebase-collection> -->

    <paper-drawer-panel responsive-width="704px">

      <paper-scroll-header-panel id="menuPanel" drawer class="layout vertical" fixed>

        <paper-toolbar id="appToolbar">
          <app-logo full="true" tabindex="1" hidden$x="{{!narrow}}"></app-logo>
        </paper-toolbar>

        <paper-menu id="menu" selected="[[routeSelected]]">
          <paper-item link="" on-tap="_clickNav">Home</paper-item>
          <paper-item link="products" on-tap="_clickNav">Browse</paper-item>
          <template is="dom-repeat" items="[[categories]]">
            <!-- <a href$="{{_computeNav(item)}}" is="pushstate-anchor"> -->
            <!-- </a> -->
            <paper-item link$="products?category={{item.name}}" on-tap="_clickNav">{{item.label}}</paper-item>
            <!-- Add Categories Page -->
            <!-- <paper-item link$="categories/{{item.name}}" on-tap="_clickNav">{{item.label}}</paper-item> -->

          </template>
        </paper-menu>

      </paper-scroll-header-panel>

      <paper-scroll-header-panel id="content" main class="flex" fixed>

        <paper-toolbar id="appToolbar">
          <!-- Menu Button -->
          <paper-icon-button id="btnMenu" icon="menu" paper-drawer-toggle></paper-icon-button>
          <!-- App Logo -->
          <app-logo full="{{narrow}}" tabindex="1" hidden$="{{narrow}}"></app-logo>

          <span class="flex"></span>

          <!-- Search Toolbar -->
          <!-- <iron-input id="query" type="search" autocomplete="off" value="{{q::keyup}}" placeholder="Search Elements" class="flex"></iron-input> -->
          <app-bar class="horizontal layout center end-justified" query="{{q}}" style="margin-right: 8px;"></app-bar>
          <!-- Cart Button -->
          <span hidden$="{{!narrow}}">
            <paper-icon-button id="btnCart" icon="shopping-cart" on-tap="_clickNavCart"></paper-icon-button>
            <paper-badge class="cartBadge" for="btnCart" label="{{cartCount}}" hidden$="{{!cartCountShow}}"></paper-badge>
          </span>

          <!-- account Dropdown Button -->
          <paper-menu-button vertical-align="top" horizontal-align="right">

            <paper-icon-button hidden={{loggedin}} icon="social:person" class="dropdown-trigger userIcon" alt="menu"></paper-icon-button>
            <paper-icon-button hidden={{!loggedin}} src="{{user.profileImageURL}}" class="dropdown-trigger userIcon" alt="menu"></paper-icon-button>

            <!-- <paper-button class="dropdown-trigger" hidden$="{{!narrow}}">
              <iron-icon src="{{user.profileImageURL}}"></iron-icon>
              <span>{{user.displayName}}</span>
            </paper-button> -->

            <!-- account Dropdown Button / Items -->
            <paper-menu class="dropdown-content">
              <paper-item link="cart" on-tap="_clickNav" hidden$="{{narrow}}">
                <iron-icon icon="shopping-cart"></iron-icon>
                <span>{{cartCount}}</span>
              </paper-item>
              <paper-item hidden={{!loggedin}} link="account" on-tap="_clickNav">[[_computeAccountText(loggedin, user)]]</paper-item>
              <paper-item hidden={{!loggedin}} on-tap="logout">logout</paper-item>
              <paper-item hidden={{loggedin}} link="login" on-tap="_clickNav">login</paper-item>
            </paper-menu>

          </paper-menu-button>

          </div>

        </paper-toolbar>

        <app-router id="router" class="flex" main mode="[[_demo(demo)]]" on-activate-route-end="_routeEnd" on-activate-route-start="_routeStart" on-state-change="_routerStateChange" on-before-data-binding="modifyModel">

          <app-route path="/" element="page-home" bindRouter></app-route>

          <app-route path="/products" element="page-product-list" bindRouter onUrlChange="reload"></app-route>
          <app-route path="/products/:byId" element="page-product" bindRouter onUrlChange="reload"></app-route>
          <!-- <app-route path="/product/:byId/:edit" element="page-product" bindRouter onUrlChange="reload"></app-route> -->

          <app-route path="/cart" element="page-cart" bindRouter onUrlChange="reload"></app-route>
          <!-- <app-route path="/cart/checkout" element="page-checkout" bindRouter onUrlChange="reload"></app-route> -->

          <app-route path="/login" element="page-account" bindRouter onUrlChange="reload"></app-route>
          <app-route path="/account" element="page-account" bindRouter onUrlChange="reload"></app-route>

          <!-- <app-route path="/account/address" element="page-address" bindRouter onUrlChange="reload"></app-route>
          <app-route path="/account/address/:id" element="page-address" bindRouter onUrlChange="reload"></app-route> -->

          <!-- <app-route path="/account/card" element="page-card" bindRouter onUrlChange="reload"></app-route>
          <app-route path="/account/card/:id" element="page-card" bindRouter onUrlChange="reload"></app-route> -->

          <app-route path="*" element="page-error"></app-route>

        </app-router>

        <!-- <a href="//www.iubenda.com/privacy-policy/434491" class="iubenda-white iubenda-embed" title="Privacy Policy">Privacy Policy</a> -->

      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <!-- Uncomment next block to enable Service Worker support (1/2) -->
    <!--
    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="networkFirst"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
    -->

    <paper-toast id="toast"></paper-toast>

    <!-- <page-new-address id="newAddressDialog" class="fit" hidden="{{!newaddress}}" user="{{user}}"></page-new-address> -->
    <!-- <page-new-card id="newCardDialog" class="fit" hidden="{{!newcard}}" user="{{user}}"></page-new-card> -->

    <script type="text/javascript">
      (function(w, d) {
        var loader = function() {
          var s = d.createElement("script"),
            tag = d.getElementsByTagName("script")[0];
          s.src = "//cdn.iubenda.com/iubenda.js";
          tag.parentNode.insertBefore(s, tag);
        };
        if (w.addEventListener) {
          w.addEventListener("load", loader, false);
        } else if (w.attachEvent) {
          w.attachEvent("onload", loader);
        } else {
          w.onload = loader;
        }
      })(window, document);
    </script>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'app-shell',
        enableCustomStyleProperties: true,
        properties: {
          // Global
          router: Object,
          mode: {
            type: String,
            notify: true,
            value: 'hash'
          },
          settings: {
            type: Object,
            notify: true,
          },
          narrow: Boolean,
          routeSelected: {
            type: Number,
            notify: true
          },

          // Cart
          cartCount: {
            type: Number,
            notify: true,
          },
          cartCountShow: {
            type: Boolean,
            notify: true,
            value: true
          },

          // User
          user: {
            type: Object,
            notify: true
          },
          loggedin: {
            type: Boolean,
            notify: true,
          },
          newaddress: {
            type: Boolean,
            notify: true,
            value: false
          },
          newcard: {
            type: Boolean,
            notify: true,
            value: false
          },


          // Categories

          categories: {
            type: Array,
            notify: true,
            value: []
          }

        },
        listeners: {
          'toast': 'showToast',
          'content-scroll': 'firePageScroll',
          'nav': 'nav',
          //address
          'open-address-dialog': 'openAddressDialog',
          'open-card-dialog': 'openCardDialog',
          //product
          'open-product-category': 'openProductCategory',
          'new-product': '_productNew',
          'add-to-fav': 'addFav',
          'add-to-cart': 'addCart',
          'remove-from-cart': 'removeFromCart'
        },
        observers: [
          'setApp(settings)',
          //  '_demo(mode)',


        ],
        attached: function() {
          var thiss = this;
          var categoriesArray;

          var categories = new Fireproof(new Firebase('https://charlesiesbeta.firebaseio.com/categories'));
          categories.orderByChild('showInNav').equalTo(true).on('child_added', function(snap) {
            // console.log(snap.val());
            var val = snap.val();
            thiss.push('categories', val);
          }).then(function(argument) {
            document.body.classList.remove('loading');
          });
          // for (var cat in val) {
          //   if (val.hasOwnProperty(cat)) {
          //     console.log(cat);
          //     thiss.push('categories', val[cat]);
          //
          //   }
          // }



        },


        _demo: function(mode) {
          console.log(mode);
          if (mode) {
            return 'auto';
          }
          return 'pushstate';
        },

        _computeAccountText: function(loggedin, user) {
          // console.log(loggedin, user);
          if (user.displayName) {
            // console.log(user);
            return this.user.displayName;
          }
          return 'Account';
        },

        nav: function(_, e) {
          if (!e) return;
          // console.log(e);
          var path = e.path || window.location.pathname;
          var params = e.params || null;
          if (params) {
            // path = path + '&';
            for (var param in params) {
              // console.log('key: ', param);
              // console.log('value: ', params[param]);
              path = path + '?' + param + '=' + params[param];
            }
          }

          this.$.router.go(path, {
            replace: e.replace
          });
        },

        _productNew: function(_, e) {
          var path = '/products?category=' + e.name;
          this.fire('nav', {
            path: path
          });
        },


        _productNew: function(_, e) {
          var path = '/products/new';
          this.fire('nav', {
            path: path
          });
        },

        openCardDialog: function(_, e) {
          if (e.new && e.after) {
            this.fire('nav', {
              path: '/account/card/?byId=new&after=' + e.after
            });
            return;
          }

        },

        openAddressDialog: function(_, e) {

          // if (e.new && e.after) {
          //   this.fire('nav', {
          //     path: '/account/address/?new=true&after=' + e.after
          //   });
          //   return;
          // }
          var params = {
            addressEdit: true
          };
          if (e.after) {
            params.after = e.after;
          }

          this.fire('nav', {
            params: params
          });


        },

        addFav: function(e, item) {
          // console.log(item.product);
          this.$.catalogUser.addFav(item.product);
        },
        removeFromCart: function(e, item) {
          // console.log(item.index);
          this.$.catalogCart.removeCart(item.index);
        },
        addCart: function(e, item) {
          // console.log(item.product);
          this.$.catalogCart.addCart(item.product);
        },

        // Navigation

        _computeNav: function(item) {
          console.log(item);
          return '#/category/' + item.name;
        },

        _clickNav: function function_name(e) {
          // console.log(e.target.getAttribute('href').split('#')[1]);
          // console.dir(e.target.getAttribute('link'));
          // this.$.router.go(this.$.menu.selectedItem.getAttribute('href'));
          // this.$.router.go('/' + e.target.getAttribute('href').split('#')[1]);
          this.$.router.go('/' + e.target.getAttribute('link'));
        },

        _clickNavCart: function(argument) {
          this.$.router.go('/cart');
        },

        firePageScroll: function(e, el) {
          var content = el.target;
          var bottom = (content.scrollHeight - content.scrollTop) === content.clientHeight;
          // console.log(bottom);
          if (bottom === true) {
            this.fire('page-fetch-more', e);
          }
        },
        // Router

        _routerStateChange: function(event) {
          // console.log(event.detail.path);
          // Select sidebar navigation item if possible

          // console.log(event.detail.path);
          if (!event) return;

          if (event.detail.path === "/") {
            this.routeSelected = 0;
            return;
          }

          var items = this.$.menu.items;

          for (var i = 0; i < items.length; i++) {
            // console.log(items[i].getAttribute('href'));

            if (typeof items[i].getAttribute('href') === 'undefined') {
              return;
            }

            var _href = items[i].getAttribute('href');
            var routePath = event.detail.path.split('/');
            // console.log(routePath);
            // console.log(routePath, index);
            // console.log(routePath, _href, i);

            // if (routePath[2]) {
            //   if (_href.split('/')[2] === routePath[2]) {
            //     // console.log(entry.attributes.route.textContent);
            //     // console.log(i);
            //     this.routeSelected = i;
            //     return;
            //   }
            // }

          }
          this.routeSelected = -1;

        },

        _routeStart: function(_, e) {
          // console.log(e.path.match('\/product/'));
          if (e.oldRoute) {
            // console.dir(e.oldRoute.getAttribute('path'));
            if (e.oldRoute.getAttribute('path') === e.route.getAttribute('path')) {
              // console.log('match');
            }
          }

          // console.log(e);
        },

        _routeEnd: function(event) {
          // if (event.detail.path === "/account") {
          //   if (!this.loggedin) {
          //     event.preventDefault();
          //     this.fire('toast', {
          //       text: 'Have to be logged in to view page'
          //     });
          //     router.go('/login', {
          //       replace: true
          //     });
          //   }
          // }
          this.$.content.scrollToTop(true);
        },

        modifyModel: function(event) {
          // event.detail.model.user = this.$.catalogUser;
          // console.dir(this.$.router);
        },

        // Global settings

        setApp: function(settings) {
          // console.log('setApp', settings);
          this.title = settings.title;
          this.fire('page-meta', {
            title: null
          });
        },
        // Search
        toggleSearch: function() {
          this.$.search.active = !this.$.search.active;
        },
        performSearch: function(e) {
          e.preventDefault();
          if (this.query.length) this.$.router.go('/search?q=' + this.query);
        },

        updateTitle: function(_, detail) {
          if (detail.title && detail.title.length) {
            document.title = detail.title + " - Catalog";
          } else {
            document.title = "Catalog";
          }
        },

        // Global Functions
        showToast: function(e, detail) {
          this.$.toast.text = detail.text;
          this.$.toast.show();
        },
        trackPageview: function(e, detail) {
          // this.debounce('pageview', function() {
          //   var loc = window.location.pathname + window.location.search;
          //   ga('send', 'pageview', {
          //     location: loc,
          //     title: document.title
          //   });
          //   ga('set', 'page', loc);
          // }, 2000);
        },
        logout: function() {
          this.$.catalogUser.logout();
          this._routerStateChange();
        }
      });
    })();
  </script>
</dom-module>
