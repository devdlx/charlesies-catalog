<dom-module id="app-shell">
  <template>

    <style is="custom-style">
      :host {
        @apply(--app-shell);
      }

      #appToolbar {
        @apply(--app-toolbar);
      }

      #appToolbar a {
        @apply(--app-toolbar-link);
      }

      #btnCartx {
        margin-right: 16px;
        margin-top: 16px;
      }

      #appToolbar paper-icon-button[icon=menu] {
        margin-right: 8px;
      }
    </style>
    <firebase-auth id="firebaseLogin" user="{{user}}" status-known="{{statusKnown}}" location="https://charlesiesbeta.firebaseio.com"></firebase-auth>

    <iron-media-query query="(min-width: 705px)" query-matches="{{narrow}}"></iron-media-query>
    <firebase-collection id="packagess" location="https://charlesiesbeta.firebaseio.com/packages" data="{{packages}}"></firebase-collection>
    <iron-localstorage name="cart" value="{{cart}}" on-iron-localstorage-load-empty="initializeDefaultCart"></iron-localstorage>
    <!-- <catalog-cart id="catalogData" cartcount="{{cartcount}}"></catalog-cart> -->
    <paper-drawer-panel responsive-width="704px">

      <paper-scroll-header-panel id="menuPanel" drawer class="layout vertical">

        <paper-toolbar id="appToolbar">
          <span class="paper-font-title">Menu</span>
        </paper-toolbar>

        <paper-menu class="list" attr-for-selected="data-route" selected="[[routeSelected]]">
          <template is="dom-repeat" items="[[packages]]">
            <a href$="{{_computeNav(item)}}" is="pushstate-anchor">
              <paper-item>{{item.name}}</paper-item>
            </a>
          </template>
        </paper-menu>

      </paper-scroll-header-panel>

      <paper-scroll-header-panel id="content" main class="fit" fixed>

        <paper-toolbar id="appToolbar">
          <!-- <span class="paper-font-title">Menu</span> -->
          <paper-icon-button id="btnMenu" icon="menu" paper-drawer-toggle></paper-icon-button>
          <app-logo full="{{narrow}}" tabindex="1"></app-logo>
          <!-- <app-bar class="horizontal layout center end-justified" no-search></app-bar> -->
          <span class="flex"></span>
          <!-- <iron-input id="query" type="search" autocomplete="off" value="{{q::keyup}}" placeholder="Search Elements" class="flex"></iron-input> -->

          <paper-icon-button id="btnCart" icon="shopping-cart"></paper-icon-button>

          <!-- <paper-badge class="cartBadge" for="btnCart" label="{{cartItemsCount}}" hiddenx="{{!cartShowCount}}" style="position:relative;top:0;left:0;"></paper-badge> -->

          </div>
        </paper-toolbar>

        <app-router id="router" class="flex" main mode="pushstate" on-activate-route-start="routeStart">
          <app-route path="/" element="page-items" bindRouter></app-route>
          <!-- <app-route path="/item/" element="page-items" bindRouter onUrlChange="updateModel"></app-route> -->
          <app-route path="/products/:itemid" element="page-home" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/login" element="page-user" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/cart" element="page-items" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/cart/checkout" element="page-items" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="*" element="page-error"></app-route>
        </app-router>

        <!-- <a href="//www.iubenda.com/privacy-policy/434491" class="iubenda-white iubenda-embed" title="Privacy Policy">Privacy Policy</a> -->

      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <!-- Uncomment next block to enable Service Worker support (1/2) -->
    <!--
    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="networkFirst"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
    -->

    <paper-toast id="toast"></paper-toast>


    <script type="text/javascript">
      (function(w, d) {
        var loader = function() {
          var s = d.createElement("script"),
            tag = d.getElementsByTagName("script")[0];
          s.src = "//cdn.iubenda.com/iubenda.js";
          tag.parentNode.insertBefore(s, tag);
        };
        if (w.addEventListener) {
          w.addEventListener("load", loader, false);
        } else if (w.attachEvent) {
          w.attachEvent("onload", loader);
        } else {
          w.onload = loader;
        }
      })(window, document);
    </script>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'app-shell',
        enableCustomStyleProperties: true,
        properties: {
          settings: {
            type: Object,
            notify: true,
          },
          narrow: Boolean,
          routeSelected: {
            type: Number,
            notify: true
          },
          cartItems: {
            type: Array,
            notify: true,
          },
          cartItemsCount: {
            type: Number,
            notify: true,
          },
          cartShowCount: {
            type: Boolean,
            notify: true,
            // value: false
          }
        },
        listeners: {
          'toast': 'showToast',
          'add-to-cart': 'addCart',
          'content-scroll': 'firePageScroll'
        },
        observers: [
          'setApp(settings)',
          // 'updatePacks(packages)',
          '_cartItemsCount(cartItems.splice)'
        ],

        _computeNav: function(item) {
          return '/products/' + item.name;
        },

        initializeDefaultCart: function() {
          this.cart = [];
        },

        firePageScroll: function(e, el) {
          var content = el.target;
          var bottom = (content.scrollHeight - content.scrollTop) === content.clientHeight;
          // console.log(bottom);
          if (bottom === true) {
            this.fire('page-fetch-more', e);
          }

        },

        _cartItemsCount: function(_newCartItems) {
          // console.log('_cartItemsCount', _newCartItems);
          if (_newCartItems.length > 0) {
            this.cartShowCount = true;
          } else {
            this.cartShowCount = false;
          }
          // console.log(_newCartItems.length);
          this.cartItemCount = _newCartItems.length;
          // console.log(this.cartItemCount);
        },

        routeStart: function(event) {
          // console.log(this.$.navtabs.items[0].attributes.route.textContent);
          // console.log(event.detail.path);
          // var that = this;
          // this.$.navtabs.items.forEach(function(entry, index) {
          //   if (typeof entry.attributes.route === 'undefined') {
          //     return;
          //   }
          //   var tabRoute = entry.attributes.route.textContent.split('/')[1];
          //   var routePath = event.detail.path.split('/')[1];
          //   // console.log(routePath, index);
          //   // console.log(routePath);
          //
          //   if (tabRoute === routePath) {
          //     // console.log(entry.attributes.route.textContent);
          //     // console.log(index);
          //     that.routeSelected = index;
          //     return;
          //   }
          //
          // });

        },

        headerTransform: function(e) {
          var applogo = document.querySelector('app-logo.icon');
          var detail = e.detail;
          var heightDiff = detail.height - detail.condensedHeight;
          var yRatio = Math.min(1, detail.y / heightDiff);
          // console.log(yRatio);
          // Polymer.Base.transform('translateX(' + scaleMiddle + ')', applogo);
        },

        ready: function() {
          // this.title = "Catalog";
        },
        setApp: function(settings) {
          // console.log('setApp', settings);
          this.title = settings.title;
          this.fire('page-meta', {
            title: null
          });
        },
        toggleSearch: function() {
          this.$.search.active = !this.$.search.active;
        },
        performSearch: function(e) {
          e.preventDefault();
          if (this.query.length) this.$.router.go('/search?q=' + this.query);
        },

        updateTitle: function(_, detail) {
          if (detail.title && detail.title.length) {
            document.title = detail.title + " - Catalog";
          } else {
            document.title = "Catalog";
          }
        },

        /*   Menu   */

        menuClose: function() {
          this.$.menuPanel.closeDrawer();
        },
        menuOpen: function() {
          this.$.menuPanel.openDrawer();
        },
        menuToggle: function() {
          this.$.menuPanel.togglePanel();
        },

        /*   Cart   */


        cartClose: function() {
          this.$.cartpanel.closeDrawer();
        },
        cartOpen: function() {
          this.$.cartpanel.openDrawer();
        },
        addCart: function(e, el) {
          // console.log('addCart', e, el);

          for (var i = 0; i < this.cart.length; i++) {
            // console.log(this.cart[i].product.__firebaseKey__);
            if (this.cart[i].product.__firebaseKey__ === el.product.__firebaseKey__) {
              // console.log('item match');
              this.cart[i].quantity++;
              // console.log(this.cart[i]);
              return;
            }
          }
          el.quantity = 1;
          this.cart.push(el);
          // this._cartItemsCount(this.cart)
          // console.log(this.cart);
        },
        cartRemove: function(e, el) {
          this.$.cart.remove(el);
        },
        showToast: function(e, detail) {
          this.$.toast.text = detail.text;
          this.$.toast.show();
        },
        trackPageview: function(e, detail) {
          // this.debounce('pageview', function() {
          //   var loc = window.location.pathname + window.location.search;
          //   ga('send', 'pageview', {
          //     location: loc,
          //     title: document.title
          //   });
          //   ga('set', 'page', loc);
          // }, 2000);
        }
      });
    })();
  </script>
</dom-module>
