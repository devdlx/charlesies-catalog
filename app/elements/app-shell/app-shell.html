<dom-module id="app-shell">
  <template>

    <style is="custom-style">
      :host {
        @apply(--app-shell);
      }

      #appToolbar {
        @apply(--app-toolbar);
      }

      #appToolbar a {
        @apply(--app-toolbar-link);
      }

      #btnCartx {
        margin-right: 16px;
        margin-top: 16px;
      }

      #appToolbar paper-icon-button[icon=menu] {
        margin-right: 8px;
      }

      paper-icon-button.userIcon::shadow img {
        border-radius: 50%;
      }

      #menu {
        /*box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.16);*/
        height: 100%;
        border-right: 1px solid #e7e7e7
      }

      paper-toast {
        z-index: 1;
      }
    </style>

    <catalog-user id="catalogUser" loggedin="{{loggedin}}" wait="{{wait}}" user="{{user}}"></catalog-user>
    <catalog-cart id="catalogCart" items="{{cart}}" count="{{cartCount}}"></catalog-cart>

    <iron-media-query query="(min-width: 705px)" query-matches="{{narrow}}"></iron-media-query>
    <firebase-collection id="category" location="https://charlesiesbeta.firebaseio.com/category" data="{{category}}"></firebase-collection>

    <paper-drawer-panel responsive-width="704px">

      <paper-scroll-header-panel id="menuPanel" drawer class="layout vertical" fixed>

        <paper-toolbar id="appToolbar">
          <app-logo full="true" tabindex="1" hidden$x="{{!narrow}}"></app-logo>
        </paper-toolbar>

        <paper-menu id="menu" selected="[[routeSelected]]">
          <paper-item href="/" on-tap="_clickNav">home</paper-item>
          <template is="dom-repeat" items="[[category]]">
            <!-- <a href$="{{_computeNav(item)}}" is="pushstate-anchor"> -->
            <paper-item href$="{{_computeNav(item)}}" on-tap="_clickNav">{{item.name}}</paper-item>
            <!-- </a> -->
          </template>
        </paper-menu>

      </paper-scroll-header-panel>

      <paper-scroll-header-panel id="content" main class="flex" fixed>

        <paper-toolbar id="appToolbar">
          <!-- Menu Button -->
          <paper-icon-button id="btnMenu" icon="menu" paper-drawer-toggle></paper-icon-button>
          <!-- App Logo -->
          <app-logo full="{{narrow}}" tabindex="1" hidden$="{{narrow}}"></app-logo>

          <span class="flex"></span>

          <!-- Search Toolbar -->
          <!-- <iron-input id="query" type="search" autocomplete="off" value="{{q::keyup}}" placeholder="Search Elements" class="flex"></iron-input> -->
          <app-bar class="horizontal layout center end-justified" query="{{q}}" style="margin-right: 8px;"></app-bar>
          <!-- Cart Button -->
          <span hidden$="{{!narrow}}">
            <paper-icon-button id="btnCart" icon="shopping-cart" on-tap="_clickNavCart"></paper-icon-button>
            <paper-badge class="cartBadge" for="btnCart" label="{{cartCount}}" hidden$="{{!cartCountShow}}"></paper-badge>
          </span>

          <!-- account Dropdown Button -->
          <paper-menu-button vertical-align="top" horizontal-align="right">

            <paper-icon-button hidden={{loggedin}} icon="social:person" class="dropdown-trigger userIcon" alt="menu"></paper-icon-button>
            <paper-icon-button hidden={{!loggedin}} src="{{user.profileImage}}" class="dropdown-trigger userIcon" alt="menu"></paper-icon-button>

            <!-- <paper-button class="dropdown-trigger" hidden$="{{!narrow}}">
              <iron-icon src="{{user.profileImage}}"></iron-icon>
              <span>{{user.google.displayName}}</span>
            </paper-button> -->

            <!-- account Dropdown Button / Items -->
            <paper-menu class="dropdown-content">
              <paper-item href="/cart" on-tap="_clickNav" hidden$="{{narrow}}">
                <iron-icon icon="shopping-cart"></iron-icon>
                <span>{{cartCount}}</span>
              </paper-item>
              <paper-item hidden={{!loggedin}} href="/account" on-tap="_clickNav">{{user.displayName}}</paper-item>
              <paper-item hidden={{!loggedin}} on-tap="logout">logout</paper-item>
              <paper-item hidden={{loggedin}} href="/login" on-tap="_clickNav">login</paper-item>
            </paper-menu>

          </paper-menu-button>

          </div>
        </paper-toolbar>

        <app-router id="router" class="flex" main mode="pushstate" on-activate-route-end="_routeEnd" on-state-change="_routerStateChange">
          <!-- <app-route path="/" element="page-home" bindRouter></app-route> -->
          <app-route path="/" element="page-checkout" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/category/:category" element="page-product-list" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/products/:itemid" element="page-product" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/cart" element="page-cart" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/cart/checkout" element="page-checkout" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/login" element="page-login" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="/account" element="page-account" bindRouter onUrlChange="updateModel"></app-route>
          <app-route path="*" element="page-error"></app-route>
        </app-router>

        <!-- <a href="//www.iubenda.com/privacy-policy/434491" class="iubenda-white iubenda-embed" title="Privacy Policy">Privacy Policy</a> -->

      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <!-- Uncomment next block to enable Service Worker support (1/2) -->
    <!--
    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="networkFirst"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
    -->

    <paper-toast id="toast"></paper-toast>

    <page-new-address id="newAddressDialog" class="fit" hidden="{{!newaddress}}" user="{{user}}"></page-new-address>
    <page-new-card id="newCardDialog" class="fit" hidden="{{!newcard}}" user="{{user}}"></page-new-card>

    <script type="text/javascript">
      (function(w, d) {
        var loader = function() {
          var s = d.createElement("script"),
            tag = d.getElementsByTagName("script")[0];
          s.src = "//cdn.iubenda.com/iubenda.js";
          tag.parentNode.insertBefore(s, tag);
        };
        if (w.addEventListener) {
          w.addEventListener("load", loader, false);
        } else if (w.attachEvent) {
          w.attachEvent("onload", loader);
        } else {
          w.onload = loader;
        }
      })(window, document);
    </script>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'app-shell',
        enableCustomStyleProperties: true,
        properties: {
          // Global
          router: Object,
          settings: {
            type: Object,
            notify: true,
          },
          narrow: Boolean,
          routeSelected: {
            type: Number,
            notify: true
          },

          // Cart
          cartCount: {
            type: Number,
            notify: true,
          },
          cartCountShow: {
            type: Boolean,
            notify: true,
            value: true
          },

          // User
          loggedin: Boolean,
          newaddress: {
            type: Boolean,
            notify: true,
            value: false
          },
          newcard: {
            type: Boolean,
            notify: true,
            value: false
          }

        },
        listeners: {
          'open-address-dialog': 'openAddressDialog',
          'open-card-dialog': 'openCardDialog',
          'add-to-cart': 'addCart',
          'add-to-fav': 'addFav',
          'remove-from-cart': 'removeFromCart',
          'toast': 'showToast',
          'content-scroll': 'firePageScroll'
        },
        observers: [
          'setApp(settings)'
        ],

        openCardDialog: function(argument) {
          // this.$.newCardDialog.open();
          // document.querySelector('app-router').go(window.location.pathname+'?newaddress=true');
          this.$.router.go(window.location.pathname + '?newcard=true');
        },

        openAddressDialog: function(argument) {
          // this.$.newAddressDialog.open();
          this.$.router.go(window.location.pathname + '?newaddress=true');
        },

        addFav: function(e, item) {
          // console.log(item.product);
          this.$.catalogUser.addFav(item.product);
        },
        removeFromCart: function(e, item) {
          // console.log(item.index);
          this.$.catalogCart.removeCart(item.index);
        },
        addCart: function(e, item) {
          // console.log(item.product);
          this.$.catalogCart.addCart(item.product);
        },

        // Navigation

        _computeNav: function(item) {
          // console.log(item);
          return '/category/' + item.name.split(' ').join('_');
        },

        _clickNav: function function_name(e) {
          // console.log(e.target.getAttribute('href'));
          // this.$.router.go(this.$.menu.selectedItem.getAttribute('href'));
          this.$.router.go(e.target.getAttribute('href'));
        },

        _clickNavCart: function(argument) {
          this.$.router.go('/cart');
        },

        firePageScroll: function(e, el) {
          var content = el.target;
          var bottom = (content.scrollHeight - content.scrollTop) === content.clientHeight;
          // console.log(bottom);
          if (bottom === true) {
            this.fire('page-fetch-more', e);
          }
        },
        // Router

        _routerStateChange: function(event) {
          // console.log(event.detail.path);
          // Select sidebar navigation item if possible
          if (event.detail.path === "/") {
            this.routeSelected = 0;
            return;
          }

          var items = this.$.menu.items;

          for (var i = 0; i < items.length; i++) {
            // console.log(items[i].getAttribute('href'));

            if (typeof items[i].getAttribute('href') === 'undefined') {
              return;
            }

            var _href = items[i].getAttribute('href').split('/')[2];
            var routePath = event.detail.path.split('/')[2];
            // console.log(routePath, index);
            // console.log(routePath, _href, i);

            if (_href === routePath) {
              // console.log(entry.attributes.route.textContent);
              // console.log(i);
              this.routeSelected = i;
              return;
            }
          }

          this.routeSelected = -1;

        },

        _routeEnd: function(event) {
          // console.log(event.detail.model.newaddress);
          this.newaddress = event.detail.model.newaddress;
          this.newcard = event.detail.model.newcard;
          this.$.content.scrollToTop(true);
        },

        // Global settings

        setApp: function(settings) {
          // console.log('setApp', settings);
          this.title = settings.title;
          this.fire('page-meta', {
            title: null
          });
        },
        // Search
        toggleSearch: function() {
          this.$.search.active = !this.$.search.active;
        },
        performSearch: function(e) {
          e.preventDefault();
          if (this.query.length) this.$.router.go('/search?q=' + this.query);
        },

        updateTitle: function(_, detail) {
          if (detail.title && detail.title.length) {
            document.title = detail.title + " - Catalog";
          } else {
            document.title = "Catalog";
          }
        },

        // Global Functions
        showToast: function(e, detail) {
          this.$.toast.text = detail.text;
          this.$.toast.show();
        },
        trackPageview: function(e, detail) {
          // this.debounce('pageview', function() {
          //   var loc = window.location.pathname + window.location.search;
          //   ga('send', 'pageview', {
          //     location: loc,
          //     title: document.title
          //   });
          //   ga('set', 'page', loc);
          // }, 2000);
        },
        logout: function() {
          this.$.catalogUser.logout();
        }
      });
    })();
  </script>
</dom-module>
