<dom-module id="app-shell">
  <template>

    <style is="custom-style">
      :host {
        @apply(--app-shell);
      }

      #appToolbar {
        @apply(--app-toolbar);
      }

      #appToolbar a {
        @apply(--app-toolbar-link);
      }

      #btnCart {
        margin-right: 16px;
        margin-top: 16px;
      }
    </style>

    <iron-media-query query="(min-width: 600px)" query-matches="{{narrow}}"></iron-media-query>

    <!-- <catalog-cart id="catalogData" cartcount="{{cartcount}}"></catalog-cart> -->

    <paper-scroll-header-panel class="fit" fixed on-paper-header-transform="headerTransform">

      <paper-toolbar id="appToolbar" class="medium-tall">
        <!-- <span class="paper-font-title">Menu</span> -->
        <app-logo tabindex="1"></app-logo>
        <!-- <app-bar class="horizontal layout center end-justified" no-search></app-bar> -->
        <span class="flex"></span>
        <!-- <iron-input id="query" type="search" autocomplete="off" value="{{q::keyup}}" placeholder="Search Elements" class="flex"></iron-input> -->

        <paper-icon-button id="btnCart" icon="shopping-cart"></paper-icon-button>
        <paper-badge class="cartBadge" for="btnCart" label="{{cartcount}}" hidden$="{{!_cartcount(cartcount)}}"></paper-badge>

        <div class="bottom fit">
          <paper-tabs id="navtabs" selected="[[routeSelected]]" noink>
            <paper-tab route="/" link>
              <a class="layout horizontal center-center" is="pushstate-anchor" href="/">
                <iron-icon class="app-icon" icon="home"></iron-icon>
              </a>
            </paper-tab>
            <paper-tab route="/women" link>
              <a class="layout horizontal center-center" is="pushstate-anchor" href="/women">women</a></paper-tab>
            <paper-tab route="/men" link>
              <a class="horizontal center-center layout" is="pushstate-anchor" href="/men/specials">men</a></paper-tab>
            <paper-tab route="/kids" link>
              <a class="horizontal center-center layout" is="pushstate-anchor" href="/kids">kids</a></paper-tab>
          </paper-tabs>
        </div>
      </paper-toolbar>

      <app-router id="router" class="flex" main mode="pushstate" on-activate-route-start="routeStart">
        <app-route path="/" element="page-items" bindRouter></app-route>
        <!-- <app-route path="/item/" element="page-items" bindRouter onUrlChange="updateModel"></app-route> -->
        <app-route path="/items/:itemid" element="page-home" bindRouter onUrlChange="updateModel"></app-route>
        <app-route path="*" element="page-error"></app-route>
      </app-router>

    </paper-scroll-header-panel>

    <!-- Uncomment next block to enable Service Worker support (1/2) -->
    <!--
    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="networkFirst"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
    -->

    <paper-toast id="toast"></paper-toast>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'app-shell',
        enableCustomStyleProperties: true,
        listeners: {
          'toast': 'showToast'
        },
        properties: {
          settings: {
            type: Object,
            notify: true,
          },
          routeSelected: {
            type: Number,
            notify: true
          },
          cartcount: {
            type: Number,
            notify: true,
            value: 0
          }
        },
        observers: [
          'setApp(settings)',
          // 'updatePacks(packages)'
        ],

        _cartcount: function(cartcount) {
          console.log('_cartcount', cartcount);
          if (cartcount === 0) {
            return false
          };
          return true;
        },

        routeStart: function(event) {
          // console.log(this.$.navtabs.items[0].attributes.route.textContent);
          // console.log(event.detail.path);
          var that = this;
          this.$.navtabs.items.forEach(function(entry, index) {
            if (typeof entry.attributes.route === 'undefined') {
              return;
            }
            var tabRoute = entry.attributes.route.textContent.split('/')[1];
            var routePath = event.detail.path.split('/')[1];
            // console.log(routePath, index);
            // console.log(routePath);

            if (tabRoute === routePath) {
              // console.log(entry.attributes.route.textContent);
              // console.log(index);
              that.routeSelected = index;
              return;
            }

          });

        },

        headerTransform: function(e) {
          var applogo = document.querySelector('app-logo.icon');
          var detail = e.detail;
          var heightDiff = detail.height - detail.condensedHeight;
          var yRatio = Math.min(1, detail.y / heightDiff);
          // console.log(yRatio);
          // Polymer.Base.transform('translateX(' + scaleMiddle + ')', applogo);
        },

        ready: function() {
          // this.title = "Catalog";
        },
        setApp: function(settings) {
          // console.log('setApp', settings);
          this.title = settings.title;
          this.fire('page-meta', {
            title: null
          });
        },
        toggleSearch: function() {
          this.$.search.active = !this.$.search.active;
        },
        performSearch: function(e) {
          e.preventDefault();
          if (this.query.length) this.$.router.go('/search?q=' + this.query);
        },

        updateTitle: function(_, detail) {
          if (detail.title && detail.title.length) {
            document.title = detail.title + " - Catalog";
          } else {
            document.title = "Catalog";
          }
        },
        cartClose: function() {
          this.$.cartpanel.closeDrawer();
        },
        cartOpen: function() {
          this.$.cartpanel.openDrawer();
        },
        cartAdd: function(e, el) {
          this.$.cart.add(el);
        },
        cartRemove: function(e, el) {
          this.$.cart.remove(el);
        },
        showToast: function(e, detail) {
          this.$.toast.text = detail.text;
          this.$.toast.show();
        },
        trackPageview: function(e, detail) {
          // this.debounce('pageview', function() {
          //   var loc = window.location.pathname + window.location.search;
          //   ga('send', 'pageview', {
          //     location: loc,
          //     title: document.title
          //   });
          //   ga('set', 'page', loc);
          // }, 2000);
        }
      });
    })();
  </script>
</dom-module>
